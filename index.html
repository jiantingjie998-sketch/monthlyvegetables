<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的多元營養攝取 (版面優化)</title>
    <!-- Chart.js Library for Pie Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        /* --- 整體樣式與新色盤 --- */
        :root {
            --bg-color: #f9f7f4;
            --text-primary: #5c5c5c;
            --text-secondary: #7a7a7a;
            --header-color: #002B5C; /* 深海軍藍 */
            --accent-color: #d4c8be; /* 柔和米色 */
            --btn-reset-bg: #c87e7e; /* 灰粉色 */
            --btn-manage-bg: #476b9e; /* 適中的專業藍 */
            --placeholder-bg: #eaeaea;

            /* Category Colors (Updated) */
            --leafy-color: #3d5a49;      /* 深綠 */
            --spice-color: #d16a67;      /* 紅色系 */
            --root-color: #c57c56;       /* 橘色 */
            --gourd-bean-color: #8a9a5b; /* 淺綠 */
            --mushroom-color: #8b6b5b;   /* 土色 */
        }

        html {
            overflow-y: scroll; /* 始終顯示滾動條，防止版面跳動 */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0; /* 將 padding 移至 main-content */
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .main-content {
            width: 100%;
            max-width: 1200px;
            padding: 1rem; /* 在此處控制主要內容的邊距 */
            box-sizing: border-box; /* 確保 padding 不會影響總寬度 */
        }

        /* --- 頂部容器與日期選擇器 --- */
        .top-container {
            display: grid;
            grid-template-areas: "header dates manage";
            grid-template-columns: 1fr auto auto;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 1rem;
            gap: 0.75rem;
        }
        .header {
            grid-area: header;
        }
        .header h1 {
            margin: 0;
            color: var(--header-color);
            font-size: 1.75rem; /* 設定基礎字體大小 */
        }
        
        .date-selector {
            grid-area: dates;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .date-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
            margin: 0 -0.4rem; /* 減少與日期選擇器之間的間距 */
        }
        
        .date-selector input[type="date"] {
            padding: 0.5rem;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-primary);
            background-color: #fff;
            width: auto;
            min-width: 140px;
        }

        #management-btn {
            grid-area: manage;
        }

        @media (max-width: 600px) {
            .top-container {
                grid-template-columns: 1fr auto;
                grid-template-areas: 
                    "header manage"
                    "dates dates";
            }
            .date-selector { 
                justify-content: flex-start;
            }
        }

        /* 針對特別窄的螢幕優化標題 */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.5rem;
            }
        }

        #recommendation-section .category-header {
            cursor: pointer;
            border-bottom: 2px solid var(--header-color);
        }

        /* --- 分類區塊 --- */
        .category-section {
            margin-top: 1rem;
        }

        /* --- 分類標題 (可點擊) --- */
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 0.5rem;
            cursor: pointer;
            user-select: none; /* 防止選取文字 */
        }
        .category-header-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .category-name-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        h2 { font-size: 1.5rem; margin: 0; }
        .category-count { font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); }
        .recommendation-subtitle {
            font-size: 0.85rem;
            font-weight: 400;
            color: #a0a0a0;
        }
        
        /* --- 折疊圖示 --- */
        .toggle-icon {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
            stroke-width: 2.5;
            transition: transform 0.3s ease-in-out;
        }
        .category-section:not(.collapsed) .toggle-icon {
            transform: rotate(90deg);
        }

        /* --- 蔬菜格線容器 (可折疊) --- */
        .vegetable-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(115px, 1fr));
            gap: 0.75rem;
            width: 100%;
            margin-top: 1rem;
            overflow: hidden;
            max-height: 2000px; /* 預設一個足夠大的高度 */
            transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1;
        }
        .category-section.collapsed .vegetable-grid {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
        }


        /* --- 單一蔬菜格 --- */
        .veg-item {
            background-color: #ffffff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            border: 1px solid #e5e5e5;
            overflow: hidden;
            position: relative;
        }
        .veg-item:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0,0,0,0.06); }
        .veg-image-container { 
            width: 100%; 
            height: 90px; 
            background-color: #ffffff; /* 將底色改為白色 */
        }
        .veg-image { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; /* 修改為 contain 以完整顯示圖片 */
        }
        .veg-name { font-size: 0.9rem; font-weight: 500; padding: 0.6rem 0.5rem; color: var(--text-primary); text-align: center; }
        .veg-item.eaten { filter: grayscale(100%); opacity: 0.6; }
        .veg-item.eaten:hover { opacity: 0.75; }

        /* --- 按鈕通用樣式 --- */
        .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.07); }
        .btn-reset { background-color: var(--btn-reset-bg); }
        .btn-reset:hover { background-color: #b86e6e; }
        .btn-save { background-color: #4a6854; }
        .btn-save:hover { background-color: #3e5646; }
        .btn-cancel { background-color: #9e9e9e; }
        .btn-cancel:hover { background-color: #8a8a8a; }
        .btn-select { background-color: var(--btn-manage-bg); }
        .btn-select:hover { background-color: #3a5885; }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            flex-shrink: 0; /* 防止在 flex 容器中被壓縮 */
        }
        .btn-icon svg {
            width: 22px;
            height: 22px;
            stroke: #ffffff;
            stroke-width: 1.5;
        }

        /* 選取/儲存按鈕的圖示切換 */
        #select-mode-btn .icon-save {
            display: none;
        }
        .summary-section.selection-mode #select-mode-btn .icon-select {
            display: none;
        }
        .summary-section.selection-mode #select-mode-btn .icon-save {
            display: block;
        }

        /* --- 編輯/刪除/資訊按鈕 --- */
        .veg-actions {
            position: absolute;
            top: 6px;
            right: 6px;
            display: flex;
            gap: 5px;
            opacity: 0;
            pointer-events: none; /* 隱藏時不可點擊 */
            transition: opacity 0.2s;
        }
        /* 手機長按時顯示 */
        .veg-item.show-actions .veg-actions {
            opacity: 1;
            pointer-events: auto;
        }
        /* 電腦滑鼠懸停時顯示 */
        @media (hover: hover) and (pointer: fine) {
            .veg-item:hover .veg-actions { opacity: 1; pointer-events: auto; }
        }
        .action-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }
        .action-btn:hover { background: #fff; transform: scale(1.1); }
        .action-btn svg { width: 14px; height: 14px; stroke: #5c5c5c; stroke-width: 2; }
        .action-btn.info-btn svg { stroke-width: 2.5; }

        /* --- 總覽 & 設定區塊 --- */
        .summary-section {
            width: 100%;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e5e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            box-sizing: border-box; 
        }
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .summary-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--header-color);
        }
        .summary-actions {
            display: flex;
            gap: 0.75rem;
        }
        .summary-content {
            display: grid;
            gap: 1rem;
            align-items: start;
            grid-template-columns: 1fr;
            margin-bottom: 1rem; /* 在列表和選擇區塊間增加間距 */
        }
        
        #summary-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.75rem; 
            padding: 0; 
            margin: 0;
            min-width: 0; /* 確保列表可以正確換行 */
        }

        .summary-item {
            list-style: none;
            background: #f4f4f4;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem;
            padding-right: 0.6rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .summary-item img { width: 30px; height: 30px; border-radius: 4px; object-fit: cover; }
        
        /* Placeholder Styles */
        .summary-item-placeholder {
            list-style: none;
            background: var(--placeholder-bg);
            border-radius: 6px;
            width: 120px;
            height: 38px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* --- 圖表區塊 --- */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .charts-container .summary-section {
            margin-bottom: 0;
        }

        .charts-content {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            max-width: 320px;
            margin: 0 auto;
            aspect-ratio: 1 / 1;
        }

        @media (max-width: 992px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        /* --- Selection Mode --- */
        #vegetable-container {
            display: none; /* Hide by default */
        }
        .summary-section.selection-mode #vegetable-container {
            display: block;
        }


        /* --- 彈出式視窗 (Modal) --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
            align-items: center; justify-content: center;
            padding: 1rem;
            box-sizing: border-box;
        }
        .modal-content {
            background-color: #fefefe; 
            margin: auto; 
            padding: 2rem;
            border: none; 
            width: 90%; 
            max-width: 400px;
            border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        #footer-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .modal-content {
         display: flex;
         flex-direction: column;
         }
        .link-style {
            text-decoration: underline;
            cursor: pointer;
            color: var(--header-color);
            font-weight: 500;
            transition: opacity 0.2s;
        }
        .link-style:hover { opacity: 0.8; }

        .modal-content .small-credit {
            font-size: 0.75rem; /* 字體小一級 */
            color: #a0a0a0;
            margin: 2rem 0 1rem 0; /* 與主文句間距2rem, 與下方按鈕間距1rem */
            text-align: left; /* 確保靠左對齊 */
        }

        .modal-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            background-color: #f9f9f9;
            border-left: 4px solid var(--accent-color);
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            text-align: left;
            line-height: 1.5;
        }

        .management-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            width: 100%;
        }
        .management-actions .btn, .management-actions label.btn {
            width: 100%;
            box-sizing: border-box;
            background-color: var(--btn-manage-bg);
            color: #ffffff; /* 確保文字為白色 */
            justify-content: center;
        }
        .management-actions .btn:hover, .management-actions label.btn:hover {
            background-color: #3a5885;
        }

        /* 新增模式下顯示分類選擇 */
        #category-select-group { display: none; }
        .modal.add-mode #category-select-group { display: block; }
        .modal-content select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: white;
        }

        @media (max-width: 480px) {
            .modal { padding: 0.75rem; }
            .modal-content {
                padding: 1.5rem;
                width: calc(100% - 2rem);
                margin: 1rem;
            }
        }

        .modal-content h3 { margin-top: 0; color: var(--header-color); }
        .modal-content p { font-size: 1rem; color: var(--text-primary); line-height: 1.6; margin-bottom: 1.5rem; }
        .modal-content .form-group { margin-bottom: 1rem; text-align: left; }
        .modal-content label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); }
        .modal-content input[type="text"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        #about-modal .modal-actions {
            justify-content: center; /* 按鈕置中 */
            margin-top: 0; /* 間距由上方感謝文字控制 */
        }
        #about-modal .modal-content p {
            text-align: left;
        }
        #nutrient-modal-image {
            width: 100%;
            aspect-ratio: 4 / 3;
            object-fit: contain;
            background-color: #ffffff;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
    </style>
</head>
<body>
    <main class="main-content">
        <div class="top-container">
            <div class="header">
                <h1>我的多元營養攝取</h1>
            </div>
            <div class="date-selector">
                <input type="date" id="start-date-picker" value="">
                <span class="date-label">&mdash;</span>
                <input type="date" id="end-date-picker" value="">
            </div>
            <button id="management-btn" class="btn btn-icon btn-select" title="管理">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
            </button>
        </div>
        <input type="file" id="import-file-input" accept=".json" style="display: none;">

        <div class="summary-section">
            <div class="summary-header">
                <h3>攝取 <span id="summary-count">0</span> 種蔬菜</h3>
                <div class="summary-actions">
                    <button id="select-mode-btn" class="btn btn-icon btn-save" title="新增攝取/儲存">
                        <svg class="icon-select" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <svg class="icon-save" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    </button>
                    <button id="reset-button" class="btn btn-icon btn-reset" title="刪除本日紀錄">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    </button>
                </div>
            </div>
            <div class="summary-content">
                <ul id="summary-list"></ul>
            </div>
            <div id="vegetable-container"></div>
        </div>

        <div id="charts-grid" class="charts-container">
            <div id="category-chart-section" class="summary-section">
                <div class="summary-header">
                    <h3>種類</h3>
                </div>
                <div class="charts-content">
                    <div class="chart-wrapper"><canvas id="summary-pie-chart-1"></canvas></div>
                </div>
            </div>
            <div id="unique-items-chart-section" class="summary-section">
                <div class="summary-header">
                    <h3>大類</h3>
                </div>
                <div class="charts-content">
                    <div class="chart-wrapper"><canvas id="summary-pie-chart-3"></canvas></div>
                </div>
            </div>
            <div id="nutrient-chart-section" class="summary-section">
                <div class="summary-header">
                    <h3>營養素</h3>
                </div>
                <div class="charts-content">
                    <div class="chart-wrapper"><canvas id="summary-pie-chart-2"></canvas></div>
                </div>
            </div>
            <div id="daily-chart-container" class="summary-section" style="display: none;">
                <div class="summary-header">
                    <h3>攝取分析</h3>
                </div>
                <div class="charts-content">
                    <div class="chart-wrapper"><canvas id="daily-bar-chart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="recommendation-section" class="category-section">
            <div class="category-header">
                <div class="category-header-title">
                    <div class="category-name-wrapper">
                        <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        <h2>建議攝取</h2>
                    </div>
                    <span class="recommendation-subtitle">30天內未攝取</span>
                </div>
            </div>
            <div id="recommendation-grid" class="vegetable-grid">
                <!-- Recommended vegetables will be injected here -->
            </div>
        </div>

        <div id="footer-section">
            <span>版權所有 All Rights Reserved</span>
            <span id="about-link" class="link-style">關於網站</span>
        </div>
    </main>

    <!-- 管理 Modal -->
    <div id="management-modal" class="modal">
        <div class="modal-content">
            <h3>管理選項</h3>
            <p class="modal-description">您的資料儲存在目前使用的瀏覽器中。若要在不同瀏覽器或裝置間同步，請先「下載備份」，再到另一台裝置「上傳備份」。</p>
            <div class="management-actions">
                <button id="manage-add-veg-btn" class="btn">新增蔬菜</button>
                <label for="import-file-input" id="manage-import-btn" class="btn">上傳備份</label>
                <button id="manage-download-btn" class="btn">下載備份</button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" data-modal="management-modal">關閉</button>
            </div>
        </div>
    </div>

    <!-- 編輯/新增 Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">編輯食材</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-category">
                <input type="hidden" id="edit-original-name">
                <div class="form-group" id="category-select-group">
                    <label for="veg-category-select">分類:</label>
                    <select id="veg-category-select" required></select>
                </div>
                <div class="form-group">
                    <label for="veg-name-input">食材名稱:</label>
                    <input type="text" id="veg-name-input" required>
                </div>
                <div class="form-group">
                    <label for="veg-image-input" id="veg-image-label">圖片網址:</label>
                    <input type="text" id="veg-image-input" placeholder="請貼上圖片的網址">
                </div>
                <div class="form-group">
                    <label for="veg-nutrients-input">主要營養素 (以逗號分隔):</label>
                    <input type="text" id="veg-nutrients-input" placeholder="例如: 維生素C, 鐵, 葉酸">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" data-modal="edit-modal">取消</button>
                    <button type="submit" class="btn btn-save">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 確認操作 Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-title">確定操作</h3>
            <p id="confirm-message">您確定要執行此操作嗎？</p>
            <div class="modal-actions">
                <button type="button" id="confirm-cancel" class="btn btn-cancel">取消</button>
                <button type="button" id="confirm-ok" class="btn btn-reset">確定</button>
            </div>
        </div>
    </div>

    <!-- 營養素資訊 Modal -->
    <div id="nutrient-modal" class="modal">
        <div class="modal-content">
            <img id="nutrient-modal-image" src="" alt="食材圖片">
            <h3 id="nutrient-modal-title">食材名稱</h3>
            <p id="nutrient-modal-text">主要營養素</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" data-modal="nutrient-modal">關閉</button>
            </div>
        </div>
    </div>

    <!-- 關於我 Modal -->
    <div id="about-modal" class="modal">
        <div class="modal-content">
            <p>網頁設計概念受楊定一博士著作「療癒的飲食與斷食」啟發，為幫助多元攝取營養，設計此網頁記錄每日品項，也有助提醒尚未攝取的品項，達到多元營養的目的。</p>
            <p class="small-credit">感謝科技進步，讓我能將想法實現為網頁，也謝謝Jeff Lin技術指導，加快了實現的速度。</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" data-modal="about-modal">關閉</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js Plugin to draw text inside the doughnut chart
    const doughnutTextPlugin = {
        id: 'doughnutText',
        afterDraw(chart, args, options) {
            if (!options.text || options.text.main === undefined) {
                return;
            }
            const { ctx, chartArea: { top, right, bottom, left } } = chart;
            const centerX = (left + right) / 2;
            const centerY = (top + bottom) / 2;
            const computedStyle = getComputedStyle(document.documentElement);
            ctx.save();
            
            // Main text (number)
            const mainFontSize = Math.min(chart.width * 0.18, 48); // Cap font size
            ctx.font = `700 ${mainFontSize}px "Noto Sans TC", sans-serif`;
            ctx.fillStyle = computedStyle.getPropertyValue('--header-color').trim();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(options.text.main, centerX, centerY); // Center the number

            ctx.restore();
        }
    };

    // Chart.js Plugin to draw text inside placeholder bar chart
    const barChartTextPlugin = {
        id: 'barChartText',
        afterDraw(chart, args, options) {
            if (!options.text) {
                return;
            }
            const { ctx, chartArea: { top, right, bottom, left } } = chart;
            const centerX = (left + right) / 2;
            const centerY = (top + bottom) / 2;
            const computedStyle = getComputedStyle(document.documentElement);

            ctx.save();
            
            const fontSize = Math.min(chart.width * 0.07, 16);
            ctx.font = `500 ${fontSize}px "Noto Sans TC", sans-serif`;
            ctx.fillStyle = computedStyle.getPropertyValue('--text-secondary').trim();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(options.text, centerX, centerY);

            ctx.restore();
        }
    };
    Chart.register(doughnutTextPlugin, barChartTextPlugin);

    const defaultVegetables = {
        '葉菜': [
            { name: '地瓜葉', image: 'https://i.postimg.cc/Qx48ccLm/2.png', nutrients: '維生素A, 維生素C, 維生素E, 維生素K, 維生素B6' },
            { name: '空心菜', image: 'https://i.postimg.cc/NjRMYN82/image.png', nutrients: '維生素C, 維生素A, 維生素B2, 葉酸, 維生素B3' },
            { name: '菠菜', image: 'https://i.postimg.cc/59hVTPMh/image.png', nutrients: '維生素K, 維生素A, 維生素C, 葉酸, 維生素B6' },
            { name: 'A菜', image: 'https://i.postimg.cc/ZRsSfF4R/Gemini-Generated-Image-z9dal7z9dal7z9da.png', nutrients: '維生素A, 維生素C, 維生素K, 葉酸, 維生素B2' },
            { name: '小白菜', image: 'https://i.postimg.cc/ryZnXjnN/image.png', nutrients: '維生素C, 維生素K, 維生素A, 葉酸, 維生素B6' },
            { name: '青江菜', image: 'https://i.postimg.cc/L6jcMQFn/image.png', nutrients: '維生素A, 維生素C, 維生素K, 葉酸, 維生素B6' },
            { name: '高麗菜', image: 'https://i.postimg.cc/TYY2yCsh/2.png', nutrients: '維生素K, 維生素C, 維生素B6, 葉酸, 維生素B1' },
            { name: '大白菜', image: 'https://i.postimg.cc/GpbCCn1B/image.png', nutrients: '維生素C, 維生素K, 葉酸, 維生素B6, 維生素A' },
            { name: '芥藍', image: 'https://i.postimg.cc/YCG75815/image.png', nutrients: '維生素C, 維生素K, 維生素A, 葉酸, 維生素B6' },
            { name: '龍鬚菜', image: 'https://i.postimg.cc/WzyXGpFH/image.png', nutrients: '維生素A, 維生素C, 鐵, 鋅, 葉酸' },
            { name: '芹菜', image: 'https://i.postimg.cc/zBQdLPj8/image.png', nutrients: '維生素K, 維生素A, 維生素C, 葉酸, 維生素B5' },
            { name: '結球萵苣', image: 'https://i.postimg.cc/593kt1P1/image.png', nutrients: '維生素A, 維生素K, 維生素C, 葉酸, 維生素B1' },
            { name: '萵苣', image: 'https://i.postimg.cc/3N9KSvkK/3.png', nutrients: '維生素K, 維生素A, 葉酸, 維生素C, 維生素B1' },
            { name: '茼蒿', image: 'https://i.postimg.cc/bwc6CBjw/image.png', nutrients: '維生素A, 維生素K, 維生素C, 葉酸, 維生素B6' },
            { name: '蘿蔓', image: 'https://i.postimg.cc/Xqnjk87H/2.png', nutrients: '維生素A, 維生素K, 葉酸, 維生素C, 維生素B1' },
            { name: '莧菜', image: 'https://i.postimg.cc/D8TQ6S2B/amaranth.png', nutrients: '維生素K, 維生素A, 維生素C, 鈣, 鐵' },
            { name: '紅莧菜', image: 'https://i.postimg.cc/TPz0fWY3/image.png', nutrients: '維生素K, 維生素A, 維生素C, 鈣, 鐵' },
            { name: '紅鳳菜', image: 'https://i.postimg.cc/3xPtqwwj/image.png', nutrients: '維生素A, 維生素C, 鐵, 鈣, 花青素' },
            { name: '韭菜', image: 'https://i.postimg.cc/JzyTKXR4/image.png', nutrients: '維生素A, 維生素C, 維生素K, 維生素B6, 葉酸' },
            { name: '韭黃', image: 'https://i.postimg.cc/Z5cXW9Rm/2.png', nutrients: '維生素A, 維生素C, 膳食纖維' },
            { name: '韭菜花', image: 'https://i.postimg.cc/D00x44ZG/image.png', nutrients: '維生素C, 維生素A, 維生素K, 維生素B2, 葉酸' },
            { name: '九層塔', image: 'https://i.postimg.cc/jSBRFKSJ/image.png', nutrients: '維生素K, 維生素A, 維生素C, 葉酸, 維生素B6' },
            { name: '香菜', image: 'https://i.postimg.cc/KvqbRCGk/image.png', nutrients: '維生素K, 維生素A, 維生素C, 葉酸, 維生素B6' },
            { name: '蒜苗', image: 'https://i.postimg.cc/c1gWFpP7/image.png', nutrients: '維生素C, 維生素A, 維生素K, 維生素B6, 葉酸' },
            { name: '其他葉菜', image: 'https://i.postimg.cc/44HCWN8v/image.png', nutrients: '多種維生素, 礦物質' },
            { name: '各種生菜', image: 'https://i.postimg.cc/907v0J4g/image.png', nutrients: '維生素A, 維生素K, 葉酸' },
        ],
        '辛香料': [
            { name: '蔥', image: 'https://i.postimg.cc/RhXPpQ3q/image.png', nutrients: '維生素K, 維生素C, 維生素A, 維生素B6, 葉酸' },
            { name: '薑', image: 'https://i.postimg.cc/1zJ7SzVg/image.png', nutrients: '薑辣素, 鎂, 鉀, 錳, 維生素B6' },
            { name: '大蒜', image: 'https://i.postimg.cc/rzXQj03H/image.png', nutrients: '蒜素, 錳, 維生素B6, 維生素C, 硒' },
            { name: '洋蔥', image: 'https://i.postimg.cc/jW9Gjmkm/onion.png', nutrients: '槲皮素, 維生素C, 維生素B6, 葉酸, 鉀' },
            { name: '紅蔥頭', image: 'https://i.postimg.cc/bwpnwDvN/image.png', nutrients: '維生素A, 維生素C, 維生素B6, 葉酸, 鉀' },
            { name: '紅辣椒', image: 'https://i.postimg.cc/sMHLnbyx/chili.png', nutrients: '辣椒素, 維生素C, 維生素A, 維生素B6, 鉀' },
        ],
        '根莖穀豆': [
            { name: '白蘿蔔', image: 'https://i.postimg.cc/gr3fYMyt/daikon.png', nutrients: '維生素C, 葉酸, 維生素B6, 維生素B5, 維生素B1' },
            { name: '胡蘿蔔', image: 'https://i.postimg.cc/QdfFNfP0/image.png', nutrients: '維生素A, 維生素K, 維生素B6, 維生素C, 維生素B1' },
            { name: '地瓜', image: 'https://i.postimg.cc/Fs5MD7ym/image.png', nutrients: '維生素A, 維生素C, 維生素B6, 維生素B5, 維生素B1' },
            { name: '南瓜', image: 'https://i.postimg.cc/PPjnYGrk/pumpkin.png', nutrients: '維生素A, 維生素C, 維生素E, 維生素B2, 維生素B6' },
            { name: '馬鈴薯', image: 'https://i.postimg.cc/rKwXQ1Wh/potato.png', nutrients: '維生素C, 維生素B6, 鉀, 錳, 葉酸' },
            { name: '芋頭', image: 'https://i.postimg.cc/PrWBcTyD/image.png', nutrients: '鉀, 維生素C, 維生素E, 維生素B6, 錳' },
            { name: '山藥', image: 'https://i.postimg.cc/rKNX9hKR/yam.png', nutrients: '鉀, 錳, 維生素C, 維生素B6, 膳食纖維' },
            { name: '日本山藥', image: 'https://i.postimg.cc/YStHvkcH/image.png', nutrients: '鉀, 錳, 維生素C, 維生素B1, 膳食纖維' },
            { name: '海帶', image: 'https://i.postimg.cc/DzpVg6gY/image.png', nutrients: '碘, 維生素K, 葉酸, 鎂, 鈣' },
            { name: '蓮藕', image: 'https://i.postimg.cc/PxsTdZtS/image.png', nutrients: '維生素C, 維生素B6, 維生素B1, 維生素B5, 葉酸' },
            { name: '玉米筍', image: 'https://i.postimg.cc/2yvPCDfP/image.png', nutrients: '維生素C, 維生素A, 葉酸, 鐵, 鉀' },
            { name: '玉米', image: 'https://i.postimg.cc/ZRdnc4qM/image.png', nutrients: '葉黃素, 玉米黃素, 維生素B1, 維生素B5, 葉酸' },
            { name: '紫米', image: 'https://i.postimg.cc/yd2MqN2m/image.png', nutrients: '花青素, 鐵, 維生素E, 膳食纖維, 鎂' },
            { name: '糙米', image: 'https://i.postimg.cc/qRNPZKDB/image.png', nutrients: '錳, 硒, 鎂, 維生素B3, 維生素B1' },
            { name: '芝麻', image: 'https://i.postimg.cc/gJTjyrdR/image.png', nutrients: '鈣, 鐵, 鎂, 鋅, 維生素E' },
            { name: '黃豆', image: 'https://i.postimg.cc/bwwv5QJb/image.png', nutrients: '蛋白質, 鐵, 錳, 磷, 維生素K' },
            { name: '牛蒡', image: 'https://i.postimg.cc/02HxXhJG/image.png', nutrients: '膳食纖維, 鉀, 鎂, 菊糖, 多酚' },
            { name: '黑豆', image: 'https://i.postimg.cc/Pf1NvX9L/image.png', nutrients: '蛋白質, 大豆異黃酮, 膳食纖維, 花青素, 維生素A, 維生素E' }
        ],
        '瓜果莖': [
            { name: '白花椰', image: 'https://i.postimg.cc/JhBRwKWy/image.png', nutrients: '維生素C, 維生素K, 維生素B6, 葉酸, 維生素B5' },
            { name: '青花菜', image: 'https://i.postimg.cc/hQSWFxYt/broccoli.png', nutrients: '維生素C, 維生素K, 維生素A, 維生素B6, 葉酸' },
            { name: '番茄', image: 'https://i.postimg.cc/PPShj3Ts/tomato.png', nutrients: '茄紅素, 維生素C, 維生素A, 維生素K, 鉀' },
            { name: '茄子', image: 'https://i.postimg.cc/CKZxhSbx/image.png', nutrients: '花青素, 膳食纖維, 錳, 維生素K, 維生素B6' },
            { name: '糯米椒', image: 'https://i.postimg.cc/TK3SJfzB/shishito-pepper.png', nutrients: '維生素C, 維生素A, 維生素B6, 維生素K, 維生素B1' },
            { name: '青椒', image: 'https://i.postimg.cc/8cf5ZDPY/image.png', nutrients: '維生素C, 維生素A, 維生素B6, 維生素K, 葉酸' },
            { name: '甜椒', image: 'https://i.postimg.cc/zHY6CWNk/bell-pepper.png', nutrients: '維生素C, 維生素A, 維生素B6, 葉酸, 維生素K' },
            { name: '大黃瓜', image: 'https://i.postimg.cc/9fQ5ZKG7/image.png', nutrients: '維生素K, 維生素C, 鉀, 鎂, 錳' },
            { name: '小黃瓜', image: 'https://i.postimg.cc/pLZM9Rnv/image.png', nutrients: '維生素K, 維生素C, 維生素B5, 維生素A, 維生素B1' },
            { name: '櫛瓜', image: 'https://i.postimg.cc/Hr6qqV0p/zucchini.png', nutrients: '維生素C, 維生素A, 維生素B6, 葉酸, 維生素K' },
            { name: '蒲瓜', image: 'https://i.postimg.cc/K8FyvRjQ/image.png', nutrients: '維生素C, 維生素B3, 維生素B6, 鈣, 鐵' },
            { name: '絲瓜', image: 'https://i.postimg.cc/qBNXP3NP/2.png', nutrients: '維生素C, 維生素B6, 維生素B5, 維生素B1, 葉酸' },
            { name: '苦瓜', image: 'https://i.postimg.cc/Y07rzFZv/image.png', nutrients: '苦瓜苷, 維生素C, 維生素A, 葉酸, 鉀' },
            { name: '冬瓜', image: 'https://i.postimg.cc/6QHnSW-t6/image.png', nutrients: '維生素C, 維生素B1, 維生素B3, 維生素B5, 維生素B6' },
            { name: '四季豆', image: 'https://i.postimg.cc/Y9sKY4Lg/image.png', nutrients: '維生素K, 維生素C, 維生素A, 葉酸, 維生素B1' },
            { name: '菜豆', image: 'https://i.postimg.cc/MTSCdPCq/image.png', nutrients: '維生素K, 維生素C, 葉酸, 維生素A, 維生素B6' },
            { name: '荷蘭豆', image: 'https://i.postimg.cc/brRzCJf3/image.png', nutrients: '維生素K, 維生素C, 維生素B1, 維生素A, 葉酸' },
            { name: '毛豆', image: 'https://i.postimg.cc/PLNgTTK1/edamame.png', nutrients: '蛋白質, 葉酸, 鐵, 錳, 維生素K' },
            { name: '秋葵', image: 'https://i.postimg.cc/kBczSBpx/okra.png', nutrients: '維生素K, 維生素C, 葉酸, 維生素B6, 維生素A' },
            { name: '豆芽菜', image: 'https://i.postimg.cc/XYPnDmtS/image.png', nutrients: '維生素C, 維生素K, 葉酸, 維生素B1, 維生素B2' },
            { name: '竹筍', image: 'https://i.postimg.cc/fW0zHpSQ/image.png', nutrients: '膳食纖維, 鉀, 維生素B1, 維生素B6, 維生素C' },
            { name: '筊白筍', image: 'https://i.postimg.cc/Dz7SntBW/image.png', nutrients: '鉀, 葉酸, 維生素C, 維生素B1, 維生素B6' },
            { name: '蘆筍', image: 'https://i.postimg.cc/P5hBfbdK/image.png', nutrients: '葉酸, 維生素K, 維生素B1, 維生素B2, 維生素C' }
        ],
        '菌菇': [
            { name: '乾香菇', image: 'https://i.postimg.cc/HL3C5KH7/image.png', nutrients: '維生素D, 維生素B2, 維生素B3, 維生素B5, 維生素B6' },
            { name: '香菇', image: 'https://i.postimg.cc/z351RZfY/shiitake-mushroom.png', nutrients: '維生素D, 維生素B2, 維生素B3, 維生素B5, 維生素B6' },
            { name: '金針菇', image: 'https://i.postimg.cc/cLCsh09B/image.png', nutrients: '維生素B3, 維生素B5, 維生素B1, 維生素B2, 葉酸' },
            { name: '杏鮑菇', image: 'https://i.postimg.cc/zXG2bMMh/image.png', nutrients: '維生素B3, 維生素B2, 維生素B5, 葉酸, 維生素B1' },
            { name: '黑木耳', image: 'https://i.postimg.cc/Twpgvz3V/image.png', nutrients: '膳食纖維, 鐵, 多醣體, 鈣, 維生素B2' },
            { name: '白木耳', image: 'https://i.postimg.cc/SscrsNJ7/image.png', nutrients: '多醣體, 膳食纖維, 膠質, 維生素D, 硒' },
            { name: '秀珍菇', image: 'https://i.postimg.cc/Pfbrr6vY/image.png', nutrients: '維生素B3, 維生素B2, 維生素B5, 維生素D, 葉酸' },
            { name: '鴻喜菇', image: 'https://i.postimg.cc/L6N9jnTs/image.png', nutrients: '維生素B3, 維生素B2, 維生素B5, 維生素D, 葉酸' }
        ]
    };

    const categoryOrder = ['葉菜', '辛香料', '根莖穀豆', '瓜果莖', '菌菇'];
    const dataVersion = '7.15'; // 資料版本控制 (營養素更新)
    const itemsToRemoveInMigration = ['豆類', '綠豆', '紅豆', '花生']; // 在資料合併時要移除的舊品項

    const categoryColorVars = {
        '葉菜': '--leafy-color',
        '辛香料': '--spice-color',
        '根莖穀豆': '--root-color',
        '瓜果莖': '--gourd-bean-color',
        '菌菇': '--mushroom-color'
    };

    let vegetables = {};
    let eatenState = {};
    let categoryCollapseState = {}; // 追蹤類別的折疊狀態
    let recommendationCollapseState = null;
    let summaryPieChart1 = null; // 第一個圖表的實例
    let summaryPieChart2 = null; // 第二個圖表的實例
    let summaryPieChart3 = null; // 第三個圖表的實例
    let dailyBarChart = null;   // 長條圖的實例
    let isStorageAvailable = true; // 追蹤 localStorage 是否可用

    const summarySection = document.querySelector('.summary-section');
    const selectModeBtn = document.getElementById('select-mode-btn');
    const vegContainer = document.getElementById('vegetable-container');
    const editModal = document.getElementById('edit-modal');
    const confirmModal = document.getElementById('confirm-modal');
    const nutrientModal = document.getElementById('nutrient-modal');
    const managementModal = document.getElementById('management-modal');
    const aboutModal = document.getElementById('about-modal');
    const modalTitle = document.getElementById('modal-title');
    const editForm = document.getElementById('edit-form');
    const editCategoryInput = document.getElementById('edit-category');
    const editOrigNameInput = document.getElementById('edit-original-name');
    const vegNameInput = document.getElementById('veg-name-input');
    const vegImageInput = document.getElementById('veg-image-input');
    const vegImageLabel = document.getElementById('veg-image-label');
    const startDatePicker = document.getElementById('start-date-picker');
    const endDatePicker = document.getElementById('end-date-picker');

    // 日期範圍變數
    let startDate, endDate;

    function safeSetItem(key, value) {
        if (!isStorageAvailable) return;
        try {
            localStorage.setItem(key, value);
        } catch (e) {
            console.error(`Error saving to localStorage: ${e}`);
            if (isStorageAvailable) { // Show the warning only once
                alert('警告：由於您目前使用的環境（例如 Google Sites 的 iframe 沙箱）限制，無法自動儲存您的紀錄。您仍然可以手動使用「下載/上傳備份」來保存與還原進度。');
            }
            isStorageAvailable = false;
        }
    }

    function safeGetItem(key) {
        try {
            return localStorage.getItem(key);
        } catch (e) {
            console.error(`Error reading from localStorage: ${e}`);
            isStorageAvailable = false;
            return null;
        }
    }

    function saveData() {
        safeSetItem('vegetablesData', JSON.stringify(vegetables));
        safeSetItem('eatenVeggiesDaily', JSON.stringify(eatenState));
        safeSetItem('categoryCollapseState', JSON.stringify(categoryCollapseState));
        safeSetItem('recommendationCollapseState', JSON.stringify(recommendationCollapseState));
    }

    function loadData() {
        const storedVeggiesJSON = safeGetItem('vegetablesData');
        const storedVersion = safeGetItem('dataVersion');
        let loadedVeggies = storedVeggiesJSON ? JSON.parse(storedVeggiesJSON) : null;
        let migrationOccurred = false; // 標記是否執行了資料合併

        // 如果版本不符或沒有本地資料，則進行處理
        if (!loadedVeggies || storedVersion !== dataVersion) {
            migrationOccurred = true;

            // --- 特定版本遷移邏輯 (在合併前執行) ---
            if (loadedVeggies && storedVersion === '5.4') {
                // 將 '豌豆' 更名為 '荷蘭豆'
                Object.keys(loadedVeggies).forEach(category => {
                    const vegToRename = loadedVeggies[category].find(v => v.name === '豌豆');
                    if (vegToRename) {
                        vegToRename.name = '荷蘭豆';
                    }
                });
            }
            const baseVeggies = structuredClone(defaultVegetables);
            
            if (loadedVeggies) { // 如果存在舊資料，則進行合併
                const mergedVeggies = {};
                const processedNames = new Set();

                // 1. 遍歷新的預設資料，以建立順序和更新內容
                categoryOrder.forEach(category => {
                    if (baseVeggies[category]) {
                        mergedVeggies[category] = [];
                        baseVeggies[category].forEach(defaultVeg => {
                            // 在用戶的資料中尋找此蔬菜（不論分類）
                            let loadedVeg = null;
                            for (const cat in loadedVeggies) {
                                const found = loadedVeggies[cat].find(v => v.name === defaultVeg.name);
                                if (found) {
                                    loadedVeg = found;
                                    break;
                                }
                            }

                            if (loadedVeg) {
                                // 找到了。使用用戶的版本，但更新圖片和營養素
                                loadedVeg.image = defaultVeg.image;
                                loadedVeg.nutrients = defaultVeg.nutrients;
                                mergedVeggies[category].push(loadedVeg);
                            } else {
                                // 這是新的預設品項，直接加入
                                mergedVeggies[category].push(defaultVeg);
                            }
                            processedNames.add(defaultVeg.name);
                        });
                    }
                });

                // 2. 加入任何剩餘的用戶自訂品項
                Object.keys(loadedVeggies).forEach(category => {
                    loadedVeggies[category].forEach(loadedVeg => {
                        // 如果品項在移除清單中，則跳過，不加回去
                        if (itemsToRemoveInMigration.includes(loadedVeg.name)) {
                            return;
                        }

                        if (!processedNames.has(loadedVeg.name)) {
                            // 這是用戶自訂的品項，或是從預設中被刪除的品項，需要加回去
                            if (!mergedVeggies[category]) {
                                mergedVeggies[category] = []; // 如果分類是新的，則建立它
                            }
                            // 避免重複加入
                            if (!mergedVeggies[category].some(v => v.name === loadedVeg.name)) {
                                mergedVeggies[category].push(loadedVeg);
                            }
                        }
                    });
                });
                vegetables = mergedVeggies;
            } else {
                // 完全沒有本地資料，直接使用預設值
                vegetables = baseVeggies;
            }
            // 更新/儲存合併後的資料和新版本號
            safeSetItem('vegetablesData', JSON.stringify(vegetables));
            safeSetItem('dataVersion', dataVersion);
        } else {
            // 版本相符，直接從本地儲存載入
            vegetables = loadedVeggies;
        }

        eatenState = JSON.parse(safeGetItem('eatenVeggiesDaily')) || {};

        // 如果執行了資料合併，則對攝取紀錄進行遷移
        if (migrationOccurred) {
            let eatenStateModified = false;

            // 1. 處理移除
            Object.keys(eatenState).forEach(date => {
                itemsToRemoveInMigration.forEach(removedName => {
                    if (eatenState[date]?.[removedName]) {
                        delete eatenState[date][removedName];
                        eatenStateModified = true;
                    }
                });
            });

            // 2. 處理更名 (從 v5.4 升級)
            if (storedVersion === '5.4') {
                Object.keys(eatenState).forEach(date => {
                    if (eatenState[date]?.['豌豆']) {
                        eatenState[date]['荷蘭豆'] = eatenState[date]['豌豆'];
                        delete eatenState[date]['豌豆'];
                        eatenStateModified = true;
                    }
                });
            }

            // 處理更名: 白韭菜 -> 韭黃
            Object.keys(eatenState).forEach(date => {
                if (eatenState[date]?.['白韭菜']) {
                    eatenState[date]['韭黃'] = eatenState[date]['白韭菜'];
                    delete eatenState[date]['白韭菜'];
                    eatenStateModified = true;
                }
            });
            // 如果有變動，儲存清理後的攝取紀錄
            if (eatenStateModified) safeSetItem('eatenVeggiesDaily', JSON.stringify(eatenState));
        }

        categoryCollapseState = JSON.parse(safeGetItem('categoryCollapseState')) || {};
        
        // Migrate collapse state if a migration occurred (e.g., category rename)
        if (migrationOccurred && categoryCollapseState['瓜果'] !== undefined) {
            categoryCollapseState['瓜果莖'] = categoryCollapseState['瓜果'];
            delete categoryCollapseState['瓜果'];
            safeSetItem('categoryCollapseState', JSON.stringify(categoryCollapseState)); // Persist the change
        }

        recommendationCollapseState = JSON.parse(safeGetItem('recommendationCollapseState'));

        Object.keys(vegetables).forEach(category => {
            if (categoryCollapseState[category] === undefined) {
                categoryCollapseState[category] = (category !== '葉菜');
            }
        });
    }
    
    function handleDateChange() {
        startDate = startDatePicker.value;
        endDate = endDatePicker.value;

        if (endDate < startDate) {
            endDate = startDate;
            endDatePicker.value = startDate;
        }
        updateView();
    }

    function updateView() {
        const isMultiDay = startDate !== endDate;
        
        // 根據是否為多日選擇，禁用或啟用相關按鈕
        selectModeBtn.disabled = isMultiDay;
        document.getElementById('reset-button').disabled = isMultiDay;

        const buttonsToToggle = [selectModeBtn, document.getElementById('reset-button')];
        buttonsToToggle.forEach(btn => {
            if (isMultiDay) {
                btn.style.opacity = 0.5;
                btn.style.cursor = 'not-allowed';
            } else {
                btn.style.opacity = 1;
                btn.style.cursor = 'pointer';
            }
        });

        // 如果在多日模式下，強制關閉選擇模式
        if (isMultiDay && summarySection.classList.contains('selection-mode')) {
            summarySection.classList.remove('selection-mode');
        }

        render();
    }

    function render() {
        vegContainer.innerHTML = '';
        categoryOrder.forEach(category => {
            if (!vegetables[category]) return;

            const isCollapsed = categoryCollapseState[category];

            const categorySection = document.createElement('div');
            categorySection.className = 'category-section';
            if (isCollapsed) {
                categorySection.classList.add('collapsed');
            }

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            categoryHeader.dataset.category = category;
            
            const categoryHeaderTitle = document.createElement('div');
            categoryHeaderTitle.className = 'category-header-title';

            const categoryNameWrapper = document.createElement('div');
            categoryNameWrapper.className = 'category-name-wrapper';

            const categoryTitle = document.createElement('h2');
            categoryTitle.textContent = category;
            
            const toggleIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            toggleIcon.setAttribute("class", "toggle-icon");
            toggleIcon.setAttribute("viewBox", "0 0 24 24");
            toggleIcon.setAttribute("fill", "none");
            toggleIcon.innerHTML = `<polyline points="9 18 15 12 9 6"></polyline>`;

            categoryNameWrapper.appendChild(toggleIcon);
            categoryNameWrapper.appendChild(categoryTitle);

            // 在單日模式下才顯示分類計數
            const dailyEatenState = startDate === endDate ? (eatenState[startDate] || {}) : {};
            const eatenInCategory = vegetables[category].filter(v => dailyEatenState[v.name]).length;
            const categoryCount = document.createElement('span');
            categoryCount.className = 'category-count';
            categoryCount.textContent = eatenInCategory;

            categoryHeaderTitle.appendChild(categoryNameWrapper);
            categoryHeaderTitle.appendChild(categoryCount);
            
            const colorVarName = categoryColorVars[category];
            if (colorVarName) {
                categoryTitle.style.color = `var(${colorVarName})`;
                categoryCount.style.color = `var(${colorVarName})`;
            }
            categoryHeader.appendChild(categoryHeaderTitle);

            const grid = document.createElement('div');
            grid.className = 'vegetable-grid';

            vegetables[category].forEach(veg => {
                const item = document.createElement('div');
                item.className = 'veg-item';
                // 只有在單日檢視時，才標示為已食用
                const isMultiDay = startDate !== endDate;
                if (!isMultiDay && eatenState[startDate]?.[veg.name]) {
                    item.classList.add('eaten');
                }
                item.dataset.name = veg.name;
                item.dataset.category = category;

                item.innerHTML = `
                    <div class="veg-image-container">
                        <img class="veg-image" src="${veg.image}" alt="${veg.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/e0e0e0/757575?text=${encodeURIComponent(veg.name)}';">
                    </div>
                    <div class="veg-name">${veg.name}</div>
                    <div class="veg-actions">
                        <button class="action-btn info-btn" title="資訊">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></svg>
                        </button>
                        <button class="action-btn edit-btn" title="編輯">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
                        </button>
                        <button class="action-btn delete-btn" title="刪除">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></svg>
                        </button>
                    </div>
                `;
                grid.appendChild(item);
            });

            categorySection.appendChild(categoryHeader);
            categorySection.appendChild(grid);
            vegContainer.appendChild(categorySection);
        });
        renderSummary();
    }

    function getDatesInRange(startDateStr, endDateStr) {
        const dates = [];
        let currentDate = new Date(startDateStr + 'T00:00:00Z'); // 使用Z確保UTC
        const endDate = new Date(endDateStr + 'T00:00:00Z');

        while (currentDate <= endDate) {
            dates.push(currentDate.toISOString().split('T')[0]);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return dates;
    }

    function renderSummary() {
        const isMultiDay = startDate !== endDate;
        const datesInRange = getDatesInRange(startDate, endDate);
        const aggregatedEatenSet = new Set();
        const itemServingCounts = {}; // 用於圖表1：計算每個品項的攝取次數

        datesInRange.forEach(dateStr => {
            const dailyEatenState = eatenState[dateStr] || {};
            Object.keys(dailyEatenState).forEach(vegName => {
                if (dailyEatenState[vegName]) {
                    aggregatedEatenSet.add(vegName);
                    itemServingCounts[vegName] = (itemServingCounts[vegName] || 0) + 1;
                }
            });
        });
        const eatenList = Array.from(aggregatedEatenSet);
        const summaryTitleEl = document.querySelector('.summary-header h3');
        let titleText = '';

        const today = new Date().toISOString().split('T')[0];

        if (isMultiDay) {
            // 多日模式
            const dayCount = datesInRange.length;
            titleText = `${dayCount}天攝取 <span id="summary-count">${eatenList.length}</span> 種蔬菜`;
        } else {
            // 單日模式
            if (startDate === today) {
                titleText = `今日攝取 <span id="summary-count">${eatenList.length}</span> 種蔬菜`;
            } else {
                const [year, month, day] = startDate.split('-').map(Number);
                const formattedDate = `${month}/${day}`;
                titleText = `${formattedDate}攝取 <span id="summary-count">${eatenList.length}</span> 種蔬菜`;
            }
        }
        summaryTitleEl.innerHTML = titleText;
        
        const listEl = document.getElementById('summary-list');
        const uniqueCategoryCounts = {}; // 用於圖表3：計算每個分類下的獨立品項數
        const nutrientCounts = {};
        
        listEl.innerHTML = ''; // 每次渲染前清空列表
        if (eatenList.length === 0) {
            // 如果沒有攝取項目，顯示佔位符
            for (let i = 0; i < 2; i++) {
                const li = document.createElement('li');
                li.className = 'summary-item-placeholder';
                listEl.appendChild(li);
            }
        } else {
            eatenList.forEach(name => {
                let vegInfo = null;
                for (const category in vegetables) {
                    const found = vegetables[category].find(v => v.name === name);
                    if (found) {
                        vegInfo = found;
                        uniqueCategoryCounts[category] = (uniqueCategoryCounts[category] || 0) + 1;
                        if (found.nutrients) {
                            const nutrients = found.nutrients.split(',');
                            nutrients.forEach(nutrient => {
                                const trimmedNutrient = nutrient.trim();
                                if (trimmedNutrient) {
                                    nutrientCounts[trimmedNutrient] = (nutrientCounts[trimmedNutrient] || 0) + 1;
                                }
                            });
                        }
                        break;
                    }
                }
                // 將攝取項目渲染到列表中
                if (vegInfo) {
                    const li = document.createElement('li');
                    li.className = 'summary-item';
                    li.innerHTML = `
                        <img src="${vegInfo.image}" alt="${vegInfo.name}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/e0e0e0/757575?text=?';">
                        <span>${vegInfo.name}</span>
                    `;
                    listEl.appendChild(li);
                }
            });
        }

        renderCharts(itemServingCounts, nutrientCounts, uniqueCategoryCounts);

        // 根據日期選擇，決定是否顯示每日長條圖
        const dailyChartContainer = document.getElementById('daily-chart-container');
        const dailyChartTitle = dailyChartContainer.querySelector('h3');

        if (eatenList.length === 0) {
            dailyChartContainer.style.display = 'block';
            renderPlaceholderBarChart();
        } else if (isMultiDay) {
            // 多日檢視
            dailyChartContainer.style.display = 'block';
            const dailyCategoryCounts = {};
            const allCategoriesInRange = new Set();

            datesInRange.forEach(dateStr => {
                dailyCategoryCounts[dateStr] = {};
                const dailyEaten = eatenState[dateStr] || {};
                Object.keys(dailyEaten).forEach(vegName => {
                    for (const category in vegetables) {
                        if (vegetables[category].some(v => v.name === vegName)) {
                            dailyCategoryCounts[dateStr][category] = (dailyCategoryCounts[dateStr][category] || 0) + 1;
                            allCategoriesInRange.add(category);
                            break;
                        }
                    }
                });
            });
            const sortedCategories = Array.from(allCategoriesInRange).sort((a, b) => {
                const indexA = categoryOrder.indexOf(a);
                const indexB = categoryOrder.indexOf(b);
                return indexA - indexB;
            });
            renderMultiDayTrendChart(dailyCategoryCounts, sortedCategories);
        } else { 
            // 單日檢視
            dailyChartContainer.style.display = 'block';
            renderSingleDayCategoryChart(uniqueCategoryCounts);
        }
        renderRecommendations();
    }

    // 輔助函式，根據基底顏色和數量生成不同深淺的顏色陣列
    function generateColorShades(baseColor, count) {
        if (count <= 0) return [];
        if (count === 1) return [baseColor];
        
        const shades = [];
        // 將 HEX 轉為 RGB
        const r_base = parseInt(baseColor.slice(1, 3), 16);
        const g_base = parseInt(baseColor.slice(3, 5), 16);
        const b_base = parseInt(baseColor.slice(5, 7), 16);

        // 定義亮度變化的範圍，例如 0.65 (較暗) 到 1.15 (較亮)
        const minFactor = 0.65;
        const maxFactor = 1.15;

        for (let i = 0; i < count; i++) {
            // 避免只有一個項目時除以零
            const step = (count > 1) ? i / (count - 1) : 1;
            const factor = minFactor + (maxFactor - minFactor) * step;

            // 計算新的 RGB 值並確保在 0-255 範圍內
            const r = Math.min(255, Math.max(0, Math.round(r_base * factor)));
            const g = Math.min(255, Math.max(0, Math.round(g_base * factor)));
            const b = Math.min(255, Math.max(0, Math.round(b_base * factor)));

            // 將 RGB 轉回 HEX
            const toHex = c => c.toString(16).padStart(2, '0');
            shades.push(`#${toHex(r)}${toHex(g)}${toHex(b)}`);
        }
        return shades;
    }

    // 輔助函式，用於建立圖表設定
    function createChartConfig(title, labels, data, colorPalette, centerText) {
        const hasData = data && data.length > 0;
        const isMobile = window.innerWidth <= 992;
        const computedStyle = getComputedStyle(document.documentElement);
        let chartData;

        if (hasData) {
            chartData = {
                labels: labels,
                datasets: [{
                    label: '數量',
                    data: data,
                    backgroundColor: colorPalette,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            };
        } else {
            // 當沒有數據時，顯示灰色佔位符圓餅圖
            chartData = {
                labels: ['無資料'], // 提供假標籤以強制圖例佔據空間
                datasets: [{
                    label: '',
                    data: [1],
                    backgroundColor: [computedStyle.getPropertyValue('--placeholder-bg').trim() || '#eaeaea'],
                    borderWidth: 0,
                    hoverOffset: 0
                }]
            };
        }
        
        return {
            type: 'doughnut',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%', // 圓環厚度
                plugins: {
                    title: {
                        display: false,
                    },
                    legend: {
                        position: isMobile ? 'bottom' : 'right',
                        align: isMobile ? 'center' : 'center',
                        labels: {
                            font: { 
                                family: "'Noto Sans TC', sans-serif", 
                                size: 11 
                            },
                            padding: isMobile ? 15 : 10,
                            boxWidth: hasData ? 12 : 0, // 無資料時隱藏色塊
                            color: hasData ? Chart.defaults.color : 'transparent' // 無資料時隱藏文字
                        },
                        display: true // 總是顯示圖例以保持尺寸一致
                    },
                    tooltip: {
                        enabled: hasData
                    },
                    doughnutText: { // 自訂插件的選項
                        text: {
                            main: hasData ? centerText.main : '0',
                            sub: centerText.sub
                        }
                    }
                }
            }
        };
    }

    // 渲染兩個圖表
    function renderCharts(itemCounts, nutrientCounts, categoryCounts) {
        if (summaryPieChart1) summaryPieChart1.destroy();
        if (summaryPieChart2) summaryPieChart2.destroy();
        if (summaryPieChart3) summaryPieChart3.destroy();

        const computedStyle = getComputedStyle(document.documentElement);
        const getCategoryColors = (labels) => labels.map(label => {
            const varName = categoryColorVars[label];
            return varName ? computedStyle.getPropertyValue(varName).trim() : '#cccccc';
        });

        const nutrientColors = [
            '#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f',
            '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'
        ];

        // 圖表1: 品項分佈 (攝取次數)
        const vegNameToCategoryMap = {};
        Object.keys(vegetables).forEach(category => {
            vegetables[category].forEach(veg => {
                vegNameToCategoryMap[veg.name] = category;
            });
        });

        const sortedItems = Object.entries(itemCounts)
            .map(([name, count]) => ({
                name,
                count,
                category: vegNameToCategoryMap[name] || ''
            }))
            .sort((a, b) => {
                const categoryIndexA = categoryOrder.indexOf(a.category);
                const categoryIndexB = categoryOrder.indexOf(b.category);

                if (categoryIndexA !== categoryIndexB) {
                    return categoryIndexA - categoryIndexB; // 依分類排序
                }
                return b.count - a.count; // 再依數量排序
            });

        const itemLabels = sortedItems.map(item => item.name);
        const itemData = sortedItems.map(item => item.count);

        // 為圖表1生成顏色：相同類別的品項顏色相近但不同
        const itemsByCategory = {};
        itemLabels.forEach(label => {
            for (const category in vegetables) {
                if (vegetables[category].some(v => v.name === label)) {
                    if (!itemsByCategory[category]) itemsByCategory[category] = [];
                    itemsByCategory[category].push(label);
                    break;
                }
            }
        });
        const itemColorMap = {};
        Object.keys(itemsByCategory).forEach(category => {
            const baseColorVar = categoryColorVars[category];
            const baseColor = baseColorVar ? computedStyle.getPropertyValue(baseColorVar).trim() : '#cccccc';
            const items = itemsByCategory[category];
            const shades = generateColorShades(baseColor, items.length);
            items.forEach((item, index) => itemColorMap[item] = shades[index]);
        });
        const itemColors = itemLabels.map(label => itemColorMap[label] || '#cccccc');

        const totalUniqueItems = itemLabels.length;
        const itemCenterText = { main: totalUniqueItems, sub: '' };
        const itemConfig = createChartConfig(
            '各品項攝取分佈',
            itemLabels, 
            itemData,
            itemColors,
            itemCenterText
        );
        const ctx1 = document.getElementById('summary-pie-chart-1').getContext('2d');
        summaryPieChart1 = new Chart(ctx1, itemConfig);

        // 圖表2: 營養素分佈
        const sortedNutrients = Object.entries(nutrientCounts)
            .sort(([, a], [, b]) => b - a);

        const nutrientLabels = sortedNutrients.map(([label]) => label);
        const nutrientData = sortedNutrients.map(([, data]) => data);

        const nutrientCenterText = { main: nutrientLabels.length, sub: '' };
        const nutrientConfig = createChartConfig(
            '主要營養素分佈',
            nutrientLabels,
            nutrientData,
            nutrientColors,
            nutrientCenterText
        );
        const ctx2 = document.getElementById('summary-pie-chart-2').getContext('2d');
        summaryPieChart2 = new Chart(ctx2, nutrientConfig);

        // 圖表3: 攝取種類 (各分類下的獨立品項數)
        const sortedCategories = Object.entries(categoryCounts)
            .sort(([a], [b]) => {
                const indexA = categoryOrder.indexOf(a);
                const indexB = categoryOrder.indexOf(b);
                return indexA - indexB;
            });

        const categoryLabels = sortedCategories.map(([label]) => label);
        const categoryData = sortedCategories.map(([, data]) => data);

        const totalUniqueCategories = categoryLabels.length;
        const categoryCenterText = { main: totalUniqueCategories, sub: '' };
        const categoryConfig = createChartConfig(
            '各類別攝取種類',
            categoryLabels, 
            categoryData, 
            getCategoryColors(categoryLabels),
            categoryCenterText
        );
        const ctx3 = document.getElementById('summary-pie-chart-3').getContext('2d');
        summaryPieChart3 = new Chart(ctx3, categoryConfig);
    }

    function renderMultiDayTrendChart(dailyCategoryCounts, allCategories) {
        if (dailyBarChart) {
            dailyBarChart.destroy();
        }

        const ctx = document.getElementById('daily-bar-chart').getContext('2d');
        const computedStyle = getComputedStyle(document.documentElement);

        const dates = Object.keys(dailyCategoryCounts);

        const datasets = allCategories.map(category => {
            const colorVar = categoryColorVars[category];
            const color = colorVar ? computedStyle.getPropertyValue(colorVar).trim() : '#cccccc';
            const dataForCategory = dates.map(date => dailyCategoryCounts[date][category] || 0);

            return {
                label: category,
                data: dataForCategory,
                backgroundColor: color,
            };
        });

        const config = {
            type: 'bar',
            data: {
                labels: dates,
                datasets: datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            color: computedStyle.getPropertyValue('--text-secondary').trim(),
                            stepSize: 1 // 確保X軸刻度為整數
                        },
                        grid: { color: '#efefef' }
                    },
                    y: {
                        stacked: true,
                        ticks: {
                            font: { family: "'Noto Sans TC', sans-serif", size: 12 },
                            color: computedStyle.getPropertyValue('--text-primary').trim(),
                            // 將 YYYY-MM-DD 格式化為 MM/DD 以節省空間
                            callback: function(value) {
                                const dateStr = this.getLabelForValue(value);
                                const [year, month, day] = dateStr.split('-').map(Number);
                                return `${month}/${day}`;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { family: "'Noto Sans TC', sans-serif", size: 11 },
                            padding: 10,
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        callbacks: {
                            title: function(context) {
                                return context[0].label; // Tooltip 標題顯示完整日期
                            },
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const value = context.parsed.x;
                                if (value > 0) {
                                    return `${datasetLabel}: ${value} 種`;
                                }
                                return null; // 不顯示數值為 0 的項目
                            }
                        }
                    }
                }
            }
        };
        dailyBarChart = new Chart(ctx, config);
    }


    function renderSingleDayCategoryChart(categoryCounts) {
        if (dailyBarChart) {
            dailyBarChart.destroy();
        }

        const ctx = document.getElementById('daily-bar-chart').getContext('2d');
        const computedStyle = getComputedStyle(document.documentElement);

        const sortedEntries = Object.entries(categoryCounts).sort(([keyA], [keyB]) => {
            const indexA = categoryOrder.indexOf(keyA);
            const indexB = categoryOrder.indexOf(keyB);
            return indexA - indexB;
        });

        const labels = sortedEntries.map(entry => entry[0]);
        const data = sortedEntries.map(entry => entry[1]);

        const backgroundColors = labels.map(label => {
            const varName = categoryColorVars[label];
            return varName ? computedStyle.getPropertyValue(varName).trim() : '#cccccc';
        });

        const config = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '種類數量',
                    data: data,
                    backgroundColor: backgroundColors,
                    barThickness: 20,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            color: computedStyle.getPropertyValue('--text-secondary').trim(),
                            stepSize: 1
                        },
                        grid: { color: '#efefef' }
                    },
                    y: {
                        ticks: {
                            font: { family: "'Noto Sans TC', sans-serif", size: 14, weight: 500 },
                            color: computedStyle.getPropertyValue('--text-primary').trim()
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true, callbacks: { label: function(context) { return `種類數量: ${context.parsed.x} 種`; } } }
                }
            }
        };
        dailyBarChart = new Chart(ctx, config);
    }

    function renderPlaceholderBarChart() {
        if (dailyBarChart) {
            dailyBarChart.destroy();
        }

        const ctx = document.getElementById('daily-bar-chart').getContext('2d');
        const computedStyle = getComputedStyle(document.documentElement);
        const placeholderColor = computedStyle.getPropertyValue('--placeholder-bg').trim() || '#eaeaea';

        const config = {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [1],
                    backgroundColor: [placeholderColor],
                    barThickness: 'flex',
                    maxBarThickness: 40
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false, max: 1 },
                    y: { display: false }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    barChartText: { text: '無資料' }
                },
                animation: false
            }
        };
        dailyBarChart = new Chart(ctx, config);
    }

    function renderRecommendations() {
        // 1. Get dates for the last 30 days based on the selected end date
        const referenceDate = new Date(endDatePicker.value + 'T00:00:00Z');
        const last30Days = [];
        for (let i = 0; i < 30; i++) {
            const d = new Date(referenceDate);
            d.setDate(d.getDate() - i);
            last30Days.push(d.toISOString().split('T')[0]);
        }

        // 2. Collect all vegetables eaten in the last 30 days
        const eatenInLast30Days = new Set();
        last30Days.forEach(dateStr => {
            const dailyEaten = eatenState[dateStr] || {};
            Object.keys(dailyEaten).forEach(vegName => {
                if (dailyEaten[vegName]) {
                    eatenInLast30Days.add(vegName);
                }
            });
        });

        // 3. Find all vegetables that were NOT eaten
        const recommendedVeggies = [];
        Object.keys(vegetables).forEach(category => {
            vegetables[category].forEach(veg => {
                if (!eatenInLast30Days.has(veg.name)) {
                    recommendedVeggies.push({ ...veg, category: category });
                }
            });
        });

        // 4. Render them to the DOM
        const recommendationSection = document.getElementById('recommendation-section');
        const recommendationGrid = document.getElementById('recommendation-grid');
        recommendationGrid.innerHTML = '';

        const hasRecommendations = recommendedVeggies.length > 0;

        if (hasRecommendations) {
            recommendedVeggies.forEach(veg => {
                const item = document.createElement('div');
                item.className = 'veg-item';
                item.dataset.name = veg.name;
                item.dataset.category = veg.category;

                item.innerHTML = `
                    <div class="veg-image-container">
                        <img class="veg-image" src="${veg.image}" alt="${veg.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/e0e0e0/757575?text=${encodeURIComponent(veg.name)}';">
                    </div>
                    <div class="veg-name">${veg.name}</div>
                `;
                recommendationGrid.appendChild(item);
            });
        } else {
            // When there are no items, display a message inside the grid.
            const placeholder = document.createElement('div');
            placeholder.textContent = '太棒了！30天內已攝取所有品項。';
            placeholder.style.padding = '1rem';
            placeholder.style.color = 'var(--text-secondary)';
            placeholder.style.textAlign = 'center';
            placeholder.style.gridColumn = '1 / -1';
            recommendationGrid.appendChild(placeholder);
        }

        // Set default collapsed state if it hasn't been set by the user yet
        if (recommendationCollapseState === null) {
            recommendationCollapseState = true; // Default to collapsed
        }
        
        // Apply the state
        recommendationSection.classList.toggle('collapsed', recommendationCollapseState);
    }

    function openModal(type, data) {
        editForm.reset();
        const categorySelect = document.getElementById('veg-category-select');
        const vegNutrientsInput = document.getElementById('veg-nutrients-input');

        if (type === 'add') {
            modalTitle.textContent = '新增食材';
            editModal.classList.add('add-mode');
            vegImageLabel.textContent = '圖片網址 (必要):';
            editOrigNameInput.value = '';
            vegNameInput.value = '';
            vegImageInput.placeholder = '請貼上圖片的網址';
            vegNutrientsInput.value = '';

            // Populate category dropdown
            categorySelect.innerHTML = ''; // Clear previous options
            categoryOrder.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        } else { // edit
            editModal.classList.remove('add-mode');
            modalTitle.textContent = '編輯食材';
            vegImageLabel.textContent = '新圖片網址:';
            editCategoryInput.value = data.category;
            const veg = vegetables[data.category]?.find(v => v.name === data.name);
            if (!veg) {
                alert(`開啟編輯失敗：在分類 '${data.category}' 中找不到食材 '${data.name}'。資料可能已過期，請重新整理頁面。`);
                return;
            }
            editOrigNameInput.value = veg.name;
            vegNameInput.value = veg.name;
            vegImageInput.value = ''; 
            vegImageInput.placeholder = '若不修改請留空';
            const currentNutrients = veg.nutrients || '';
            vegNutrientsInput.value = currentNutrients.includes('待補充') ? '' : currentNutrients;
        }
        editModal.style.display = 'flex';
    }

    function openNutrientModal(category, name) {
        const veg = vegetables[category].find(v => v.name === name);
        if (!veg) return;

        document.getElementById('nutrient-modal-title').textContent = veg.name;
        const imgEl = document.getElementById('nutrient-modal-image');
        imgEl.src = veg.image;
        imgEl.alt = veg.name;
        document.getElementById('nutrient-modal-text').textContent = veg.nutrients || '暫無資料';

        nutrientModal.style.display = 'flex';
    }

    function closeModal(modalElement) {
        modalElement.style.display = 'none';
    }

    function showConfirmation(message, onConfirm) {
        document.getElementById('confirm-message').textContent = message;
        confirmModal.style.display = 'flex';

        const confirmOk = document.getElementById('confirm-ok');
        const confirmCancel = document.getElementById('confirm-cancel');

        const okListener = () => {
            closeModal(confirmModal);
            onConfirm();
            cleanup();
        };

        const cancelListener = () => {
            closeModal(confirmModal);
            cleanup();
        };
        
        function cleanup() {
            confirmOk.removeEventListener('click', okListener);
            confirmCancel.removeEventListener('click', cancelListener);
        }

        confirmOk.addEventListener('click', okListener, { once: true });
        confirmCancel.addEventListener('click', cancelListener, { once: true });
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        const newName = vegNameInput.value.trim();
        if (!newName) {
            alert('請輸入名稱！');
            return;
        }

        const originalName = editOrigNameInput.value;
        const isEditing = !!originalName;

        if (isEditing) {
            // --- 編輯邏輯 ---
            const category = editCategoryInput.value;
            const newImageUrl = vegImageInput.value.trim();
            const newNutrients = document.getElementById('veg-nutrients-input').value.trim();
            const veg = vegetables[category]?.find(v => v.name === originalName);

            if (!veg) {
                alert(`儲存失敗：找不到原始食材 '${originalName}'。請重新操作。`);
                console.error(`EDIT FAILED: Cannot find vegetable with name "${originalName}" in category "${category}"`);
                closeModal(editModal);
                return;
            }

            // 檢查新名稱是否與同分類下的其他食材重複
            if (newName !== originalName && vegetables[category].some(v => v.name === newName)) {
                alert(`儲存失敗：分類 '${category}' 中已存在名為 '${newName}' 的食材。`);
                return;
            }

            // 如果名稱被修改，同步更新所有日期的攝取紀錄
            if (newName !== originalName) {
                Object.keys(eatenState).forEach(date => {
                    if (eatenState[date]?.[originalName]) {
                        delete eatenState[date][originalName];
                        eatenState[date][newName] = true;
                    }
                });
            }

            // 更新食材物件的屬性
            veg.name = newName;
            if (newImageUrl) {
                veg.image = newImageUrl;
            }
            veg.nutrients = newNutrients || '待補充';
        } else {
            // --- 新增邏輯 ---
            const category = document.getElementById('veg-category-select').value;
            const newImageUrl = vegImageInput.value.trim();
            const newNutrients = document.getElementById('veg-nutrients-input').value.trim();
            if (!newImageUrl) {
                alert('新增時，必須提供圖片網址！');
                return;
            }
            if (!vegetables[category]) {
                vegetables[category] = [];
            }
            if (vegetables[category].some(v => v.name === newName)) {
                alert(`新增失敗：分類 '${category}' 中已存在名為 '${newName}' 的食材。`);
                return;
            }
            vegetables[category].push({ name: newName, image: newImageUrl, nutrients: newNutrients || '待補充' });
        }

        saveData();
        updateView();
        closeModal(editModal);
    }
    
    // --- 資料匯出/匯入功能 ---
    function downloadDataAsJson() {
        // 為了確保資料完整性，特別是包含 Base64 照片的 photos 陣列，
        // 我們手動建立一個新的物件來進行序列化，而不是直接 stringify 原始的 eatenState。
        const cleanEatenState = {};
        Object.keys(eatenState).forEach(date => {
            const dailyEntry = eatenState[date];
            // 增加對 dailyEntry 是否存在的檢查，確保即使某天紀錄為 null 也不會出錯
            if (dailyEntry) {
                cleanEatenState[date] = {
                    items: dailyEntry.items || {},
                    photos: dailyEntry.photos || []
                };
            }
        });

        const dataToSave = {
            version: dataVersion, // 在備份中加入版本號
            vegetables: vegetables,
            // 使用手動清理過的 eatenState 進行備份
            eatenState: cleanEatenState,
            categoryCollapseState: categoryCollapseState,
            recommendationCollapseState: recommendationCollapseState
        };

        const dataStr = JSON.stringify(dataToSave, null, 2); // 格式化JSON，方便閱讀
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement('a');
        link.href = url;
        const today = new Date().toISOString().split('T')[0];
        link.download = `vegetable-data-backup-${today}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                // 驗證檔案結構，確保是有效的備份檔
                if (data && data.vegetables && data.eatenState) { // 只需驗證核心資料是否存在
                    showConfirmation("確定要用上傳的檔案覆蓋目前所有資料嗎？此操作無法復原。", () => {
                        vegetables = data.vegetables;
                        
                        // --- 資料結構遷移：確保上傳的 eatenState 轉換為新格式 ---
                        const importedEatenState = data.eatenState;
                        eatenState = {}; // 清空目前的狀態
                        Object.keys(importedEatenState).forEach(date => {
                            const entry = importedEatenState[date];
                            // 如果是舊格式 (沒有 items 和 photos 屬性)，則進行轉換
                            if (entry && !entry.hasOwnProperty('items') && !entry.hasOwnProperty('photos')) {
                                eatenState[date] = { items: entry, photos: [] };
                            } else if (entry) { // 如果是新格式，且 entry 存在 (不為 null)
                                eatenState[date] = {
                                    items: entry.items || {},
                                    photos: entry.photos || [] // 確保 photos 欄位總是存在
                                };
                            }
                        });

                        // 安全地載入摺疊狀態，若備份檔中不存在則使用預設值
                        categoryCollapseState = data.categoryCollapseState || {};
                        recommendationCollapseState = data.recommendationCollapseState !== undefined ? data.recommendationCollapseState : null;
                        
                        // 將備份檔中的版本號也一併寫入 localStorage
                        if (data.version) {
                            safeSetItem('dataVersion', data.version);
                        }
                        
                        saveData(); // 將新資料存入 localStorage
                        updateView(); // 重新渲染畫面
                        alert('資料已成功載入！');
                        closeModal(managementModal);
                    });
                } else {
                    alert('檔案格式不符或已損毀，載入失敗。');
                }
            } catch (error) {
                console.error("解析JSON檔案時出錯:", error);
                alert('讀取檔案時發生錯誤，請確認檔案為有效的 JSON 格式。');
            } finally {
                // 重置檔案輸入，以便可以再次選擇同一個檔案
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }

    // Event Listeners
    // --- 統一的點擊處理 ---
    vegContainer.addEventListener('click', e => {
        const header = e.target.closest('.category-header');
        const vegItem = e.target.closest('.veg-item');

        // 處理分類標題的點擊（折疊/展開）
        if (header) {
            const category = header.dataset.category;
            categoryCollapseState[category] = !categoryCollapseState[category];
            header.parentElement.classList.toggle('collapsed');
            saveData(); // 保存折疊狀態
            return;
        }

        // 處理蔬菜項目的點擊
        if (vegItem) {
            const name = vegItem.dataset.name;
            const category = vegItem.dataset.category;
            const isMultiDay = startDate !== endDate;

            // 優先處理圖示按鈕的點擊
            if (e.target.closest('.info-btn')) {
                openNutrientModal(category, name);
                return;
            }
            if (e.target.closest('.edit-btn')) {
                openModal('edit', { category, name });
                return;
            }
            if (e.target.closest('.delete-btn')) {
                showConfirmation(`確定要刪除「${name}」嗎？`, () => {
                    vegetables[category] = vegetables[category].filter(v => v.name !== name);
                    Object.keys(eatenState).forEach(date => { delete eatenState[date][name]; });
                    saveData();
                    updateView();
                });
                return;
            }

            // --- Click on item body ---
            const isTouchDevice = !window.matchMedia('(hover: hover)').matches;

            if (isTouchDevice) {
                // On touch devices, show actions for 2 seconds on click.
                // Hide any other open action menus
                document.querySelectorAll('.veg-item.show-actions').forEach(item => {
                    if (item !== vegItem) {
                        item.classList.remove('show-actions');
                        const timerId = item.dataset.actionTimer;
                        if (timerId) clearTimeout(timerId);
                    }
                });

                // Show actions for the clicked item and set a timer to hide them
                vegItem.classList.add('show-actions');
                const existingTimer = vegItem.dataset.actionTimer;
                if (existingTimer) clearTimeout(existingTimer);
                
                const newTimer = setTimeout(() => {
                    vegItem.classList.remove('show-actions');
                }, 2000);
                vegItem.dataset.actionTimer = newTimer;
            }

            // Toggle selection state for all devices
            // 僅在單日模式下啟用
            if (isMultiDay) return;

            if (!eatenState[startDate]) eatenState[startDate] = {};
            const wasEaten = !!eatenState[startDate][name];
            eatenState[startDate][name] = !wasEaten;
            saveData();

            // Efficiently update UI without full re-render
            vegItem.classList.toggle('eaten', !wasEaten);
            const categoryHeader = vegItem.closest('.category-section').querySelector('.category-header');
            const countEl = categoryHeader.querySelector('.category-count');
            let currentCount = parseInt(countEl.textContent, 10);
            countEl.textContent = wasEaten ? currentCount - 1 : currentCount + 1;
            renderSummary();
        }
    });

    document.getElementById('recommendation-grid').addEventListener('click', e => {
        const vegItem = e.target.closest('.veg-item');
        if (!vegItem) return;

        const name = vegItem.dataset.name;
        const isMultiDay = startDate !== endDate;

        if (isMultiDay) {
            alert('請在單日模式下新增攝取紀錄。');
            return;
        }

        if (!eatenState[startDate]) eatenState[startDate] = {};
        eatenState[startDate][name] = true; // Directly add to eaten list
        saveData();
        updateView();
    });

    document.querySelector('#recommendation-section .category-header').addEventListener('click', () => {
        const recommendationSection = document.getElementById('recommendation-section');
        // Toggle the state. If it was null, renderRecommendations has already set a default.
        recommendationCollapseState = !recommendationCollapseState;
        recommendationSection.classList.toggle('collapsed', recommendationCollapseState);
        saveData();
    });

    document.getElementById('reset-button').onclick = () => {
        showConfirmation(`確定要重置 ${startDate} 的紀錄嗎？`, () => {
            eatenState[startDate] = {};
            saveData();
            updateView();
        });
    };
    
    selectModeBtn.addEventListener('click', () => {
        const isExitingSelectionMode = summarySection.classList.contains('selection-mode');

        // 當用戶點擊「儲存」按鈕（即退出選擇模式時）執行儲存操作。
        // 雖然應用程式在每次點擊蔬菜時都會自動儲存，
        // 但在此處增加一次明確的儲存步驟，可以確保操作符合用戶的預期，
        // 並再次保證所有變更都已寫入本地儲存。
        if (isExitingSelectionMode) {
            saveData();
        }
        summarySection.classList.toggle('selection-mode');
    });

    document.querySelectorAll('.btn-cancel').forEach(btn => {
        btn.addEventListener('click', () => {
            const modalId = btn.dataset.modal;
            if (modalId) {
                closeModal(document.getElementById(modalId));
            }
        });
    });

    document.getElementById('about-link').addEventListener('click', () => {
        aboutModal.style.display = 'flex';
    });

    // --- 管理按鈕與 Modal 邏輯 ---
    document.getElementById('management-btn').addEventListener('click', () => {
        managementModal.style.display = 'flex';
    });

    document.getElementById('manage-add-veg-btn').addEventListener('click', () => {
        closeModal(managementModal);
        openModal('add', {});
    });

    document.getElementById('manage-download-btn').addEventListener('click', () => {
        downloadDataAsJson();
        // 讓使用者看到下載觸發後再關閉
        setTimeout(() => closeModal(managementModal), 300);
    });

    document.getElementById('import-file-input').addEventListener('change', handleFileUpload);

    editForm.addEventListener('submit', handleFormSubmit);

    startDatePicker.addEventListener('change', handleDateChange);
    endDatePicker.addEventListener('change', handleDateChange);

    // Add a debounced resize listener to update chart layouts
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            renderSummary();
        }, 250); // Debounce to avoid excessive re-renders
    });

    // 全域點擊監聽，用於關閉已開啟的選單
    document.addEventListener('click', (e) => {
        // If the click is outside any vegetable item, close all action menus.
        if (!e.target.closest('.veg-item')) {
            document.querySelectorAll('.veg-item.show-actions').forEach(item => {
                item.classList.remove('show-actions');
                const timerId = item.dataset.actionTimer;
                if (timerId) clearTimeout(timerId);
            });
        }
    });

    window.onclick = e => { 
        if (e.target.classList.contains('modal')) {
            closeModal(e.target);
        }
    };

    // --- 頁面生命週期處理，強化在行動裝置上的儲存可靠性 ---
    // 'pagehide' 事件在行動瀏覽器 (特別是 iOS Safari) 上比 'unload' 更可靠。
    // 當使用者切換分頁、關閉瀏覽器或導航到其他頁面時，此事件會觸發。
    window.addEventListener('pagehide', function() {
        // saveData() 是同步且快速的，在此處呼叫是安全的。
        saveData();
    });

    function initializeApp() {
        const today = new Date().toISOString().split('T')[0];
        startDatePicker.value = today;
        endDatePicker.value = today;
        handleDateChange();
    }

    // Initial Load
    loadData();
    initializeApp();
});
</script>
</body>
</html>
