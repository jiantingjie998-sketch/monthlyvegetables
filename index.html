
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的多元營養攝取</title>
    <!-- Chart.js Library for Pie Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
    <!-- Cropper.js for Image Editing -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        /* --- Google Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        /* --- 整體樣式與新色盤 --- */
        :root {
            --bg-color: #f7f9f7; /* 清新淺綠白 */
            --text-primary: #333d33; /* 深綠灰色 */
            --text-secondary: #6c757d; /* 柔和灰 */
            --header-color: #2a4b37; /* 優雅森林綠 */
            --accent-color: #a9bca9; /* 柔和鼠尾草綠 */
            --btn-save-bg: #4a7c59; /* 儲存按鈕綠 */
            --btn-reset-bg: #c17c74; /* 刪除按鈕紅 */
            --btn-manage-bg: #6a828f; /* 管理按鈕藍灰 */
            --btn-cancel-bg: #a0a0a0; /* 取消按鈕灰 */
            --placeholder-bg: #eaeaea;

            /* Category Colors (Updated for elegance) */
            --leafy-color: #4f7553;      /* 葉菜 - 自然綠 */
            --spice-color: #d18c67;      /* 辛香料 - 暖陶色 */
            --root-color: #b57f5b;       /* 根莖 - 大地橘 */
            --gourd-bean-color: #9a9a5b; /* 瓜果 - 黃綠色 */
            --mushroom-color: #8b7d75;   /* 菌菇 - 灰褐色 */
        }

        html {
            overflow-y: scroll; /* 始終顯示滾動條，防止版面跳動 */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }
        
        .main-content {
            width: 100%;
            max-width: 1200px;
            padding: 1rem;
            box-sizing: border-box; /* 確保 padding 不會影響總寬度 */
            margin: 0 auto;
        }

        /* --- 頂部容器與日期選擇器 --- */
        .top-container {
            display: grid;
            grid-template-areas: "back header dates";
            grid-template-columns: auto 1fr auto;
            justify-content: space-between;
            align-items: center; /* 確保所有項目在垂直方向上置中對齊 */
            width: 100%;
            margin-bottom: 1.5rem; /* 統一主要區塊間距 */
            gap: 0.75rem;
        }
        .header {
            grid-area: header;
            justify-self: start; /* 讓標題靠左 */
        }
        .header h1 {
            margin: 0;
            color: var(--header-color);
            font-size: 1.75rem; /* 設定基礎字體大小 */
        }
        
        .date-selector {
            grid-area: dates;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            flex-wrap: wrap; /* 允許日期選擇器在空間不足時換行 */
            gap: 0.75rem;
        }

        .date-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
            margin: 0 -0.4rem; /* 減少與日期選擇器之間的間距 */
        }
        
        .date-selector input[type="date"] {
            padding: 0.5rem;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-primary);
            background-color: #fff;
            width: auto;
            min-width: 140px;
        }

        /* --- 日期切換按鈕 --- */
        .date-nav-btn {
            background-color: transparent;
            border: none;
            padding: 0.4rem;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .date-nav-btn:hover { background-color: #e4ede4; }
        .date-nav-btn svg { width: 20px; height: 20px; stroke: var(--header-color); stroke-width: 2.5; }

        #back-to-home-btn {
            grid-area: back;
    background-color: transparent;
    box-shadow: none; /* 移除陰影 */
}

/* 為返回按鈕設定獨立的 hover 效果和圖示顏色 */
#back-to-home-btn:hover {
    background-color: #e4ede4; /* 加上淡淡的 hover 背景色，提供視覺回饋 */
}

#back-to-home-btn svg {
    stroke: var(--header-color); /* 設定圖示顏色 */
    width: 30px; /* 放大圖示尺寸 */
    height: 30px; /* 放大圖示尺寸 */
    stroke-width: 1.8; /* 加粗圖示線條 */
}

        @media (max-width: 600px) {
            .top-container {
                grid-template-columns: auto 1fr; /* 返回按鈕佔用所需空間，標題佔用剩餘空間 */
                grid-template-areas: 
                    "back  header"
                    "dates dates"; /* 日期選擇器橫跨兩欄 */
            }
            .date-selector {
                flex-wrap: nowrap; /* 防止換行 */
                justify-content: flex-start; /* 在換行時讓日期選擇器靠左對齊 */
                gap: 0.5rem; /* 縮小元件間距 */
            }
        }

        /* 針對特別窄的螢幕優化標題 */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.5rem;
            }
        }

        #recommendation-section .category-header {
            cursor: pointer;
            border-bottom: 2px solid var(--header-color);
        }

        /* --- 分類區塊 --- */
        .category-section {
            margin-top: 1.5rem; /* 統一主要區塊間距 */
        }

        /* --- 分類標題 (可點擊) --- */
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 0.5rem;
            cursor: pointer;
            user-select: none; /* 防止選取文字 */
        }
        .category-header-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .category-name-wrapper {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        h2 { font-size: 1.5rem; margin: 0; }
        .category-count { font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); }
        .recommendation-subtitle {
            font-weight: 400;
            color: #a0a0a0;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }
        
        /* --- 折疊圖示 --- */
        .toggle-icon {
            width: 20px;
            height: 20px;
            stroke: var(--text-secondary);
            stroke-width: 2.5;
            transition: transform 0.3s ease-in-out;
        }
        .category-section:not(.collapsed) .toggle-icon {
            transform: rotate(90deg);
        }

        /* --- 蔬菜格線容器 (可折疊) --- */
        .vegetable-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 0.75rem;
            width: 100%;
            margin-top: 1rem;
            overflow: hidden;
            padding-top: 4px; /* 新增：為第一列的上移動畫提供緩衝空間，避免被裁切 */
            max-height: 2000px; /* 預設一個足夠大的高度 */
            transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1;
        }
        .category-section.collapsed .vegetable-grid {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
        }

        /* --- 建議攝取區塊的特殊樣式 --- */
        /* 設定固定高度並捲動 */
        #recommendation-section:not(.collapsed) #recommendation-grid {
            max-height: 420px; /* 約3排蔬菜的高度 */
            overflow-y: auto;
            padding-top: 4px;
            padding-inline-end: 8px; /* 為滾動條留出空間，比 padding-right 更好 */
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }
        
        #recommendation-grid::-webkit-scrollbar {
            width: 6px;
        }
        #recommendation-grid::-webkit-scrollbar-track {
            background: transparent;
        }
        #recommendation-grid::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 6px;
        }

        /* 窄螢幕：固定高度並保持捲動 */
        @media (max-width: 768px) {
            #recommendation-section:not(.collapsed) #recommendation-grid {
                max-height: 330px; /* 在手機上略微降低高度 */
                padding-inline-end: 8px;
            }
        }

        /* --- 建議攝取區塊標題的特殊樣式 --- */
        #recommendation-section h2 {
            font-size: 1.5rem; /* 與月曆標題字級一致 */
        }

        /* --- 單一蔬菜格 --- */
        .veg-item {
            background-color: #ffffff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            border: 1px solid #e5e5e5;
            position: relative;
        }
        .veg-item:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0,0,0,0.06); }
        .veg-image-container { 
            width: 100%; 
            height: 80px; 
            border-top-left-radius: 10px; /* 配合父元素的圓角 */
            border-top-right-radius: 10px; /* 配合父元素的圓角 */
            background-color: #ffffff; /* 將底色改為白色 */
        }
        .veg-image { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; /* 修改為 contain 以完整顯示圖片 */
        }
        .veg-name { font-size: 0.9rem; font-weight: 500; padding: 0.6rem 0.5rem; color: var(--text-primary); text-align: center; }
        .veg-item.eaten { filter: grayscale(100%); opacity: 0.6; }
        .veg-item.eaten:hover { opacity: 0.75; }

        /* --- 按鈕通用樣式 --- */
        .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 700;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.07); }
        .btn-reset { background-color: var(--btn-reset-bg); }
        .btn-reset:hover { background-color: #ad6b63; }
        .btn-save { background-color: var(--btn-save-bg); }
        .btn-save:hover { background-color: #3e694b; }
        .btn-cancel { background-color: var(--btn-cancel-bg); }
        .btn-cancel:hover { background-color: #8c8c8c; }
        .btn-select { background-color: var(--btn-manage-bg); }
        .btn-select:hover { background-color: #586f7a; }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            flex-shrink: 0; /* 防止在 flex 容器中被壓縮 */
        }
        .btn-icon svg {
            width: 22px;
            height: 22px;
            stroke: #ffffff;
            stroke-width: 1.5;
        }

        /* 選取/儲存按鈕的圖示切換 */
        #select-mode-btn .icon-save {
            display: none;
        }
        .summary-section.selection-mode #select-mode-btn .icon-select {
            display: none;
        }
        .summary-section.selection-mode #select-mode-btn .icon-save {
            display: block;
        }

        /* --- 編輯/刪除/資訊按鈕 --- */
        .veg-actions {
            position: absolute;
            top: 6px;
            right: 6px;
            display: flex;
            gap: 5px;
            opacity: 0;
            pointer-events: none; /* 隱藏時不可點擊 */
            transition: opacity 0.2s;
        }
        /* 手機長按時顯示 */
        .veg-item.show-actions .veg-actions {
            opacity: 1;
            pointer-events: auto;
        }
        /* 電腦滑鼠懸停時顯示 */
        @media (hover: hover) and (pointer: fine) {
            .veg-item:hover .veg-actions { opacity: 1; pointer-events: auto; }
        }
        .action-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }
        .action-btn:hover { background: #fff; transform: scale(1.1); }
        .action-btn svg { width: 14px; height: 14px; stroke: #5c5c5c; stroke-width: 2; }
        .action-btn.info-btn svg { stroke-width: 2.5; }

        /* --- 總覽 & 設定區塊 --- */
        .summary-section {
            width: 100%;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e5e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
            box-sizing: border-box; 
        }
        .unique-count {
            font-weight: 400;
            color: #a0a0a0;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .summary-header h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--header-color);
        }
        .summary-actions {
            display: flex;
            gap: 0.75rem;
        }
        .summary-content {
            display: grid;
            gap: 1rem;
            align-items: start;
            grid-template-columns: 1fr;
            margin-bottom: 1rem; /* 在列表和選擇區塊間增加間距 */
        }
        
        #summary-list { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.75rem; 
            padding: 0; 
            margin: 0;
            min-width: 0; /* 確保列表可以正確換行 */
        }

        /* 在窄螢幕下限制成果區高度，超出則滾動 */
        @media (max-width: 768px) {
            #summary-list {
                /* 15rem 約為 5 列的高度 (240px) */
                max-height: 15rem; 
                overflow-y: auto;
                /* 為滾動條增加一些空間，避免內容被遮擋 */
                padding-right: 0.5rem;
                /* 美化滾動條 (可選，但能提升體驗) */
                scrollbar-width: thin;
                scrollbar-color: var(--accent-color) var(--bg-color);
            }
            #summary-list::-webkit-scrollbar {
                width: 6px;
            }
            #summary-list::-webkit-scrollbar-track {
                background: transparent; /* 讓軌道透明 */
            }
            #summary-list::-webkit-scrollbar-thumb {
                background-color: var(--accent-color);
                border-radius: 6px;
            }
        }

        /* --- 照片成果區 --- */
        #photo-gallery-section {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        /* 當照片區有內容時，才加上上邊距，避免沒有照片時出現多餘空白 */
        #photo-gallery-section:not(:empty) {
            margin-top: 1rem;
        }
        .photo-thumbnail-wrapper {
            position: relative;
        }
        .remove-photo-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: all 0.2s;
            opacity: 1; /* 在觸控裝置上預設可見 */
        }
        .remove-photo-btn svg {
            width: 12px;
            height: 12px;
            stroke: white;
            stroke-width: 2.5;
        }
        .remove-photo-btn:hover {
            background: var(--btn-reset-bg);
            transform: scale(1.1);
        }
        .photo-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        .summary-item {
            list-style: none;
            background: #f4f4f4;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 28px 0.4rem 0.6rem; /* 調整右側 padding，始終為按鈕保留空間 */
            border-radius: 6px;
            font-size: 0.85rem;
            position: relative; /* 為了定位刪除按鈕 */
            transition: background-color 0.2s;
        }
        .summary-item .remove-btn {
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 1; /* 在觸控裝置上預設可見 */
            transition: opacity 0.2s; /* 為透明度加上漸變效果 */
        }
        .summary-item .remove-btn svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-secondary);
            transition: stroke 0.2s;
        }
        .summary-item .remove-btn:hover svg {
            stroke: var(--btn-reset-bg);
        }
        .summary-item img { width: 30px; height: 30px; border-radius: 4px; object-fit: cover; }
        
        /* Placeholder Styles */
        .summary-item-placeholder {
            list-style: none;
            background: var(--placeholder-bg);
            border-radius: 6px;
            width: 120px;
            height: 38px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        @media (hover: hover) and (pointer: fine) {
            .remove-photo-btn {
                opacity: 0;
            }
            .photo-thumbnail-wrapper:hover .remove-photo-btn {
                opacity: 1;
            }
        }

        /* 在支援 hover 的裝置上 (電腦)，預設隱藏 X 按鈕 */
        @media (hover: hover) and (pointer: fine) {
            .summary-item .remove-btn {
                opacity: 0; /* 預設透明 */
                pointer-events: none; /* 隱藏時不可點擊 */
            }
            .summary-item:hover .remove-btn {
                opacity: 1; /* Hover 時浮現 */
                pointer-events: auto;
            }
        }
        
        /* --- 圖表區塊 --- */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 桌面版為兩欄 */
            gap: 1.5rem; /* 統一圖表間距 */
            margin-bottom: 1.5rem; /* 統一主要區塊間距 */
        }

        .charts-container .summary-section {
            margin-bottom: 0;
        }

        .charts-content {
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 0; /* 確保在 flex 容器中，圖表可以正確縮小，避免在窄螢幕上破版 */
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 400px; /* 統一所有圖表的高度 */
            max-width: none; /* 允許圖表填滿其容器寬度 */
            margin: 0 auto;
        }
        .chart-wrapper canvas {
            touch-action: pan-y; /* 允許垂直滾動，但攔截水平滑動以用於切換頁面 */
        }

        .pagination-container {
            text-align: center;
            padding-top: 10px;
        }

        .pagination-dot {
            cursor: pointer;
            height: 10px;
            width: 10px;
            margin: 0 4px;
            background-color: #ccc;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.3s ease;
        }

        .pagination-dot.active {
            background-color: var(--btn-save-bg);
        }

        @media (max-width: 992px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }


        /* --- 彈出式視窗 (Modal) --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
            align-items: center; justify-content: center;
            padding: 1rem;
            box-sizing: border-box;
        }
        .modal-content {
            background-color: #fefefe; 
            margin: auto; 
            padding: 2rem;
            border: none; 
            width: 90%; 
            max-width: 400px;
            border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        /* --- 蔬菜選擇 Modal --- */
        #selection-modal .modal-content {
            max-width: 900px; /* 讓 Modal 可以更寬 */
            width: 95%;
        }
        #selection-modal-body {
            max-height: 65vh; /* 限制最大高度，超出則滾動 */
            overflow-y: auto;
            padding-right: 10px; /* 為滾動條預留空間 */
        }

        .modal-content.add-mode {
            /* 在新增模式下，給予足夠的高度以容納下拉選單 */
            min-height: 420px;
        }

        #footer-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem; /* 統一主要區塊間距 */
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            width: 100%;
            max-width: 1200px; /* 與主內容區塊寬度一致 */
            box-sizing: border-box;
            margin-left: auto; /* 水平置中以對齊上方區塊 */
            margin-right: auto; /* 水平置中以對齊上方區塊 */
        }

        @media (max-width: 480px) {
            #footer-section {
                flex-direction: column; /* 在小螢幕上垂直排列 */
                align-items: center;
                text-align: center;
                gap: 0.5rem;
                padding-bottom: 1rem;
            }
        }

        .modal-content {
         display: flex;
         flex-direction: column;
         }
        .link-style {
            text-decoration: underline;
            cursor: pointer;
            color: var(--header-color);
            font-weight: 500;
            transition: opacity 0.2s;
        }
        .link-style:hover { opacity: 0.8; }

        .modal-content .small-credit {
            font-size: 0.75rem; /* 字體小一級 */
            color: #a0a0a0;
            margin: 2rem 0 1rem 0; /* 與主文句間距2rem, 與下方按鈕間距1rem */
            text-align: left; /* 確保靠左對齊 */
        }

        .modal-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
            background-color: #f9f9f9;
            border-left: 4px solid var(--accent-color);
            padding: 0.75rem 1rem;
            margin-bottom: 1.5rem;
            text-align: left;
            line-height: 1.5;
        }
        /* --- 相機 Modal --- */
        #camera-modal {
            background-color: rgba(0,0,0,0.85);
            padding: 0;
        }
        #camera-modal .modal-content {
            background: transparent;
            box-shadow: none;
            width: 100%;
            height: 100%;
            max-width: none;
            padding: 0;
            justify-content: center;
        }
        #camera-view {
            width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        #camera-controls {
            position: absolute;
            bottom: 2rem;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between; /* 改為 space-between 以獲得更好的對齊 */
            align-items: center;
            padding: 0 2rem; /* 增加左右邊距，讓按鈕不會太靠邊 */
        }
        /* 統一相機控制中的圖示按鈕樣式 */
        #camera-controls .btn-icon {
            width: 50px;
            height: 50px;
            background-color: rgba(40, 40, 40, 0.7);
            border-radius: 50%; /* 讓按鈕變圓形 */
        }
        /* 加大圖示尺寸 */
        #camera-controls .btn-icon svg {
            width: 28px;
            height: 28px;
        }
        #capture-btn {
            width: 70px; /* 稍微加大主按鈕 */
            height: 70px; /* 稍微加大主按鈕 */
            border-radius: 50%;
            border: 4px solid white;
            background-color: rgba(255,255,255,0.3);
        }


        .management-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            width: 100%;
        }
        .management-actions .btn, .management-actions label.btn {
            width: 100%;
            box-sizing: border-box;
            background-color: var(--btn-manage-bg);
            color: #ffffff; /* 確保文字為白色 */
            justify-content: center;
        }
        .management-actions .btn:hover, .management-actions label.btn:hover {
            background-color: #586f7a;
        }

        /* 新增模式下顯示分類選擇 */
        #category-select-group { display: none; }
        .modal.add-mode #category-select-group { display: block; }
        .modal-content select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: white;
        }

        @media (max-width: 480px) {
            .modal { padding: 0.75rem; }
            .modal-content {
                padding: 1.5rem;
                width: calc(100% - 2rem);
                margin: 1rem;
            }
            /* --- 縮小成果區按鈕以適應窄螢幕 --- */
            .summary-actions {
                gap: 0.5rem; /* 8px */
            }
            .summary-actions .btn-icon {
                width: 34px;
                height: 34px;
            }
            .summary-actions .btn-icon svg {
                width: 18px;
                height: 18px;
                stroke-width: 1.8; /* 讓縮小的圖示線條更清晰 */
            }
            .summary-header {
                flex-wrap: wrap; /* 在窄螢幕上允許標題和按鈕換行 */
                gap: 0.75rem;
            }
            .home-intro h1 {
                font-size: 1.5rem; /* 在窄螢幕上縮小首頁標題 */
            }
        }

        .modal-content h3 { margin-top: 0; color: var(--header-color); }
        .modal-content p { font-size: 1rem; color: var(--text-primary); line-height: 1.6; margin-bottom: 1.5rem; }
        .modal-content .form-group { margin-bottom: 1rem; text-align: left; }
        .modal-content label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); }
        .modal-content input[type="text"] { width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        #about-modal .modal-actions {
            justify-content: center; /* 按鈕置中 */
            margin-top: 0; /* 間距由上方感謝文字控制 */
        }
        /* --- Photo Editor Modal --- */
        #photo-editor-container {
            width: 100%;
            height: 40vh; /* 限制圖片容器高度 */
            margin-bottom: 1rem;
            background: #eee;
        }
        #photo-editor-image {
            display: block;
            max-width: 100%;
        }
        .editor-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .editor-actions .btn {
            /* 移除通用按鈕樣式，改為圖示按鈕樣式 */
            background-color: transparent;
            border: none;
            box-shadow: none;
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        .editor-actions .btn:hover {
            background-color: #e9e9e9; /* 懸停時的淺灰色背景 */
            transform: none; /* 移除通用按鈕的 hover 效果 */
            box-shadow: none;
        }
        .editor-actions .btn svg {
            width: 28px;
            height: 28px;
            stroke: var(--text-primary); /* 圖示顏色使用主要文字顏色 */
        }
        #about-modal .modal-content p {
            text-align: left;
        }
        #nutrient-modal-image {
            width: 100%;
            aspect-ratio: 4 / 3;
            object-fit: contain;
            background-color: #ffffff;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        #photo-viewer-modal-image {
            width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        /* --- Home Screen & Calendar --- */
        #home-screen {
            width: 100%;
            max-width: 1200px; /* 與次頁寬度一致 */
            margin: 1rem auto 2rem; /* 減少上方留白 */
            padding: 1rem;
            box-sizing: border-box;
            display: flex;
            position: relative; /* 設為相對定位，以便定位內部的絕對元素 */
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .home-intro {
            /* --- 介紹區塊樣式 --- */
            margin-bottom: 2rem;
            margin-bottom: 1.5rem; /* 統一主要區塊間距 */
        }
        .home-intro h1 {
            color: var(--header-color);
            font-size: 2rem;
            margin-top: 0; /* 移除 h1 預設的上邊距 */
            margin-bottom: 0.5rem;
        }
        .home-intro p {
            font-size: 0.8rem; /* 調小二級 */
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 650px;
            margin: 0 auto; /* 移除底部 margin，改由 .home-intro 控制 */
        }
        #home-screen #management-btn {
            position: absolute;
            top: 1.25rem; /* 調整 top 值以與標題水平對齊 */
            left: calc(1rem - 6px); /* 再往左移 3px */
            background-color: transparent;
            box-shadow: none;
        }
        #home-screen #management-btn:hover {
            background-color: #eef1ee; /* 加上淡淡的 hover 背景色 */
        }
        #home-screen #management-btn svg {
            stroke: var(--header-color);
            width: 28px;
            height: 28px;
            stroke-width: 1.8;
        }
        #calendar-container {
            width: 100%;
            background: #fff;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e5e5e5;
            box-sizing: border-box; /* 確保 padding 不會撐開寬度 */
        margin-bottom: 1.5rem;
    }
    #home-screen .summary-section {
        padding: 1rem; /* 與月曆區塊的 padding 一致 */
        }
        #home-screen #recommendation-section {
            width: 100%;
            background: #fff;
            border-radius: 12px;
        padding: 1rem; /* 與月曆區塊的 padding 一致 */
            box-sizing: border-box;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e5e5e5;
        }
        /* 移除首頁建議攝取區塊的上邊距，避免與上方圖表間距過大 */
        #home-screen > #recommendation-section {
            margin-top: 0;
        }
        #calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        #calendar-header h2 { color: var(--header-color); font-size: 1.5rem; margin: 0; }
        #calendar-header .btn { background-color: var(--accent-color); color: var(--text-primary); font-weight: bold; padding: 0.5rem 1rem; }
        #calendar-weekdays, #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        #calendar-weekdays div { font-weight: 700; color: var(--text-secondary); font-size: 0.85rem; padding-bottom: 0.5rem; }
        .day-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            border: 2px solid transparent;
            padding: 2px;
            box-sizing: border-box;
        }
        .day-number {
            position: absolute;
            top: 4px;
            left: 6px;
            font-size: 0.8em;
            font-weight: 500;
            color: #b0b0b0; /* 刷淡日期數字顏色 */
            line-height: 1;
        }
        .day-count {
            font-size: 1.2em; /* 再縮小字體 */
            font-weight: 600; /* 降低粗細 */
            color: rgba(74, 124, 89, 0.85); /* 顏色刷淡 */
            line-height: 1;
            transform: translateY(5px); /* 再稍微向下偏移 */
        }
        .day-cell:not(.empty-cell):hover { background-color: #eef1ee; }
        .day-cell.today { border-color: var(--accent-color); }
        .day-cell.today .day-number { color: var(--header-color); font-weight: 700; }
        .day-cell.has-data { background-color: #e4ede4; }
        .day-cell.has-data.today { background-color: #d8e2d8; }
        .day-cell.empty-cell { cursor: default; }
        .day-photo-indicator {
            position: absolute;
            top: 1px; /* 向上移動 3px，使其視覺上更靠上 */
            right: 6px;
            width: 14px;
            height: 14px;
            color: var(--accent-color); /* 改回柔和的鼠尾草綠，色塊設計下質感更佳 */
            opacity: 0.9;
        }
        .day-photo-indicator svg {
            fill: currentColor; /* 改為實心填色 */
        }
        
        @media (max-width: 420px) { /* 針對特別窄的螢幕縮小字體 */
            .day-cell {
                aspect-ratio: 1 / 1.5; /* 明顯增加高度，讓版面更寬敞 */
            }
            .day-number {
                font-size: 0.7em;
            }
            .day-count {
                font-size: 1.0em;
            }
            /* 在窄螢幕上將照片圖示改為與計數顏色一致的小圓點 */
            .day-photo-indicator {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background-color: var(--accent-color); /* 與桌面版圖示顏色一致 */
                opacity: 0.9; /* 與桌面版圖示透明度一致 */
                top: 5px;
                right: 5px;
                color: transparent; /* 確保在極端情況下 SVG 顏色不會顯示 */
            }
            .day-photo-indicator svg {
                display: none; /* 隱藏 SVG 圖示 */
            }
        }
        
        @media (min-width: 769px) { /* 在寬螢幕上縮小日期格高度 */
            .day-cell {
                aspect-ratio: 4 / 3; /* 讓儲存格寬高比為 4:3，使其變扁 */
            }
        }
        
    </style>
</head>
<body>
    <div id="home-screen" style="display: none;">
        <div class="home-intro">
            <h1>我的多元營養攝取</h1>
            <button id="management-btn" class="btn btn-icon btn-select" title="管理">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
            </button>
            <p>輕鬆記錄每日飲食、幫助攝取多元營養<br>請點擊下方日期記錄或查看攝取狀況</p>
        </div>
        <div id="calendar-container">
            <div id="calendar-header">
                <button id="prev-month-btn" class="btn">&lt;</button>
                <h2 id="month-year-display"></h2>
                <button id="next-month-btn" class="btn">&gt;</button>
            </div>
            <div id="calendar-weekdays"></div>
            <div id="calendar-grid"></div>
        </div>
        <div class="summary-section">
            <div class="summary-header">
                <h3>攝取品項</h3>
            </div>
            <div class="charts-content">
                <div style="width: 100%;">
                    <div class="chart-wrapper"><canvas id="home-treemap-chart"></canvas></div>
                    <div id="home-treemap-pagination" class="pagination-container"></div>
                </div>
            </div>
        </div>
        <div id="recommendation-section" class="category-section">
            <div class="summary-header">
                <h3>建議攝取 <span class="recommendation-subtitle">30天內未攝取</span></h3>
            </div>
            <div id="recommendation-grid" class="vegetable-grid">
                <!-- Recommended vegetables will be injected here -->
            </div>
        </div>
    </div>

    <main class="main-content" style="display: none;">
        <div class="top-container">
            <button id="back-to-home-btn" class="btn btn-icon" title="返回首頁">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
                </svg>
            </button>
            <div class="header">
                <h1>我的紀錄</h1>
            </div>
            <div class="date-selector">
                <button id="prev-day-btn" class="date-nav-btn" title="前一天">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                </button>
                <input type="date" id="start-date-picker" value="">
                <span class="date-label">&mdash;</span>
                <input type="date" id="end-date-picker" value="">
                <button id="next-day-btn" class="date-nav-btn" title="後一天">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                </button>
            </div>
        </div>
        <input type="file" id="import-file-input" accept=".json" style="display: none;">
        <input type="file" id="upload-photo-input" accept="image/*" style="display: none;" multiple>

        <div id="daily-summary-section" class="summary-section">
            <div class="summary-header">
                <h3>攝取 <span id="summary-count">0</span> 種蔬菜</h3>
                <div class="summary-actions">
                    <button id="camera-btn" class="btn btn-icon btn-select" title="拍照辨識">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>
                    </button>
                    <button id="select-mode-btn" class="btn btn-icon btn-save" title="新增攝取/儲存">
                        <svg class="icon-select" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        <svg class="icon-save" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    </button>
                    <button id="reset-button" class="btn btn-icon btn-reset" title="刪除本日紀錄">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    </button>
                </div>
            </div>
            <div class="summary-content">
                <ul id="summary-list"></ul>
                <div id="photo-gallery-section"></div>
            </div>
            <!-- 蔬菜選擇容器已移至 Modal 中 -->
        </div>

        <div id="charts-grid" class="charts-container">
            <div id="unique-items-chart-section" class="summary-section">
                <div class="summary-header">
                    <h3>攝取大類</h3>
                </div>
                <div class="charts-content">
                    <div class="chart-wrapper"><canvas id="summary-pie-chart-3"></canvas></div>
                </div>
            </div>
            <div id="nutrient-chart-section" class="summary-section">
                <div class="summary-header">
                    <h3>主要營養素</h3>
                </div>
                <div class="charts-content">
                    <div class="chart-wrapper"><canvas id="summary-pie-chart-2"></canvas></div>
                </div>
            </div>
            <div id="trace-elements-chart-section" class="summary-section">
                <div class="summary-header">
                    <h3>微量元素</h3>
                </div>
                <div class="charts-content">
                    <div class="chart-wrapper"><canvas id="summary-pie-chart-4"></canvas></div>
                </div>
            </div>
            <div id="daily-chart-container" class="summary-section" style="display: none;">
                <div class="summary-header">
                    <h3>攝取分析</h3>
                </div>
                <div class="charts-content">
                    <div class="chart-wrapper"><canvas id="daily-bar-chart"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer-section">
        <span>版權所有 All Rights Reserved</span>
        <span id="about-link" class="link-style">關於網站</span>
    </div>

    <!-- 管理 Modal -->
    <div id="management-modal" class="modal">
        <div class="modal-content">
            <h3>管理選項</h3>
            <p class="modal-description">您的資料儲存在目前使用的瀏覽器中。若要在不同瀏覽器或裝置間同步，請先「下載備份」，再到另一台裝置「上傳備份」。<br><br><b>提示：</b>若備份檔包含大量照片，上傳時可能因記憶體限制而失敗。建議定期清理不需要的照片紀錄。</p>
            <div class="management-actions">
                <button id="manage-add-veg-btn" class="btn">新增蔬菜</button>
                <label for="import-file-input" id="manage-import-btn" class="btn">上傳備份</label>
                <button id="manage-download-btn" class="btn">下載備份</button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" data-modal="management-modal">關閉</button>
            </div>
        </div>
    </div>

    <!-- 蔬菜選擇 Modal -->
    <div id="selection-modal" class="modal">
        <div class="modal-content">
            <h3>選擇攝取品項</h3>
            <div id="selection-modal-body">
                <!-- 蔬菜列表將會被注入到這裡 -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-save" data-modal="selection-modal">完成</button>
            </div>
        </div>
    </div>

    <!-- 相機選擇 Modal -->
    <div id="camera-choice-modal" class="modal">
        <div class="modal-content">
            <div class="management-actions">
                <label for="upload-photo-input" id="choice-upload-btn" class="btn">從相簿選取</label>
                <button id="choice-camera-btn" class="btn">開啟相機</button>
            </div>
        </div>
    </div>

    <!-- 編輯/新增 Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">編輯食材</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-category">
                <input type="hidden" id="edit-original-name">
                <div class="form-group" id="category-select-group">
                    <label for="veg-category-select">分類:</label>
                    <select id="veg-category-select" required></select>
                </div>
                <div class="form-group">
                    <label for="veg-name-input">食材名稱:</label>
                    <input type="text" id="veg-name-input" required>
                </div>
                <div class="form-group">
                    <label for="veg-image-input" id="veg-image-label">圖片網址:</label>
                    <input type="text" id="veg-image-input" placeholder="請貼上圖片的網址">
                </div>
                <div class="form-group">
                    <label for="veg-nutrients-input">主要營養素 (以逗號分隔):</label>
                    <input type="text" id="veg-nutrients-input" placeholder="例如: 維生素C, 鐵, 葉酸">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" data-modal="edit-modal">取消</button>
                    <button type="submit" class="btn btn-save">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 確認操作 Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-title">確定操作</h3>
            <p id="confirm-message">您確定要執行此操作嗎？</p>
            <div class="modal-actions">
                <button type="button" id="confirm-cancel" class="btn btn-cancel">取消</button>
                <button type="button" id="confirm-ok" class="btn btn-reset">確定</button>
            </div>
        </div>
    </div>

    <!-- 營養素資訊 Modal -->
    <div id="nutrient-modal" class="modal">
        <div class="modal-content">
            <img id="nutrient-modal-image" src="" alt="食材圖片">
            <h3 id="nutrient-modal-title">食材名稱</h3>
            <p id="nutrient-modal-text">主要營養素</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" data-modal="nutrient-modal">關閉</button>
            </div>
        </div>
    </div>

    <!-- 相機 Modal -->
    <div id="camera-modal" class="modal">
        <div class="modal-content">
            <video id="camera-view" autoplay playsinline></video>
            <canvas id="camera-canvas" style="display:none;"></canvas>
            <div id="camera-controls" style="align-items: center;">
                <label for="upload-photo-input" class="btn btn-icon" title="從相簿選取" style="display: inline-flex; align-items: center; justify-content: center; position: relative; top: 5px;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5z" />
                    </svg> 
                </label>
                <button type="button" id="capture-btn" title="拍照"></button>
                <button type="button" class="btn btn-icon btn-cancel" data-modal="camera-modal" title="取消">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 照片編輯 Modal -->
    <div id="photo-editor-modal" class="modal">
        <div class="modal-content">
            <h3>編輯照片</h3>
            <div id="photo-editor-container">
                <img id="photo-editor-image" src="">
            </div>
            <div class="editor-actions">
                <button id="editor-rotate-btn" class="btn" title="旋轉">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3" /></svg>
                </button>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" data-modal="photo-editor-modal">取消</button>
                <button type="button" id="editor-confirm-btn" class="btn btn-save">確定</button>
            </div>
        </div>
    </div>

    <!-- 照片刪除確認 Modal -->
    <div id="photo-delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="photo-delete-confirm-title">刪除照片</h3>
            <p id="photo-delete-confirm-message">您想要如何處理這張照片？</p>
            <div id="photo-delete-confirm-actions" class="management-actions" style="margin-bottom: 1rem;">
                <!-- Buttons will be injected here by JS -->
            </div>
            <div class="modal-actions" style="justify-content: center;">
                <button type="button" class="btn btn-cancel" data-modal="photo-delete-confirm-modal">取消</button>
            </div>
        </div>
    </div>

    <!-- 照片檢視 Modal -->
    <div id="photo-viewer-modal" class="modal"><div class="modal-content"><img id="photo-viewer-modal-image" src="" alt="檢視照片"><div class="modal-actions"><button type="button" class="btn btn-cancel" data-modal="photo-viewer-modal">關閉</button></div></div></div>

    <!-- 關於我 Modal -->
    <div id="about-modal" class="modal">
        <div class="modal-content">
            <p>網頁設計概念受楊定一博士著作「療癒的飲食與斷食」啟發，為幫助多元攝取營養，設計此網頁記錄每日品項，也有助提醒尚未攝取的品項，達到多元營養的目的。</p>
            <p class="small-credit">感謝科技進步，讓我能將想法實現為網頁，也謝謝Jeff Lin技術協力，加快了實現的速度。</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" data-modal="about-modal">關閉</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let cropper = null;
    let cameraStream = null;

    // --- IndexedDB Helper ---
    // A simple key-value store using IndexedDB, which has a much larger storage capacity than localStorage.
    const idb = {
        db: null,
        async open() {
            if (this.db) return;
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('VegetableDB', 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('appData')) {
                        db.createObjectStore('appData', { keyPath: 'key' });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve();
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        },
        async set(key, value) {
            await this.open();
            const transaction = this.db.transaction(['appData'], 'readwrite');
            const store = transaction.objectStore('appData');
            return store.put({ key, value });
        },
        async get(key) {
            await this.open();
            const request = this.db.transaction(['appData'], 'readonly').objectStore('appData').get(key);
            return new Promise(resolve => {
                request.onsuccess = () => resolve(request.result?.value);
                request.onerror = () => resolve(undefined); // Return undefined on error
            });
        },
    };

    // Chart.js Plugin to draw text inside the doughnut chart
    const doughnutTextPlugin = {
        id: 'doughnutText',
        afterDraw(chart, args, options) {
            if (!options.text || options.text.main === undefined) {
                return;
            }
            const { ctx, chartArea: { top, right, bottom, left } } = chart;
            const centerX = (left + right) / 2;
            const centerY = (top + bottom) / 2;
            const computedStyle = getComputedStyle(document.documentElement);
            ctx.save();
            
            // Main text (number)
            const mainFontSize = Math.min(chart.width * 0.18, 48); // Cap font size
            ctx.font = `700 ${mainFontSize}px "Noto Sans TC", sans-serif`;
            ctx.fillStyle = computedStyle.getPropertyValue('--header-color').trim();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(options.text.main, centerX, centerY); // Center the number

            ctx.restore();
        }
    };

    // Chart.js Plugin to draw text inside placeholder bar chart
    const barChartTextPlugin = {
        id: 'barChartText',
        afterDraw(chart, args, options) {
            if (!options.text) {
                return;
            }
            const { ctx, chartArea: { top, right, bottom, left } } = chart;
            const centerX = (left + right) / 2;
            const centerY = (top + bottom) / 2;
            const computedStyle = getComputedStyle(document.documentElement);

            ctx.save();
            
            const fontSize = Math.min(chart.width * 0.07, 16);
            ctx.font = `500 ${fontSize}px "Noto Sans TC", sans-serif`;
            ctx.fillStyle = computedStyle.getPropertyValue('--text-secondary').trim();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(options.text, centerX, centerY);

            ctx.restore();
        }
    };
    Chart.register(doughnutTextPlugin, barChartTextPlugin);

        const defaultVegetables = {
        '葉菜': [
            { name: '地瓜葉', image: 'https://i.postimg.cc/Qx48ccLm/2.png', nutrients: '維生素A, 維生素C, 維生素E, 維生素K, 維生素B6' },
            { name: '空心菜', image: 'https://i.postimg.cc/NjRMYN82/image.png', nutrients: '維生素C, 維生素A, 維生素B2, 葉酸, 維生素B3' },
            { name: '菠菜', image: 'https://i.postimg.cc/59hVTPMh/image.png', nutrients: '維生素K, 維生素A, 維生素C, 葉酸, 維生素B6' },
            { name: 'A菜', image: 'https://i.postimg.cc/ZRsSfF4R/Gemini-Generated-Image-z9dal7z9dal7z9da.png', nutrients: '維生素A, 維生素C, 維生素K, 葉酸, 維生素B2' },
            { name: '小白菜', image: 'https://i.postimg.cc/ryZnXjnN/image.png', nutrients: '維生素C, 維生素K, 維生素A, 葉酸, 維生素B6' },
            { name: '青江菜', image: 'https://i.postimg.cc/L6jcMQFn/image.png', nutrients: '維生素A, 維生素C, 維生素K, 葉酸, 維生素B6' },
            { name: '高麗菜', image: 'https://i.postimg.cc/TYY2yCsh/2.png', nutrients: '維生素K, 維生素C, 維生素B6, 葉酸, 維生素B1' },
            { name: '大白菜', image: 'https://i.postimg.cc/GpbCCn1B/image.png', nutrients: '維生素C, 維生素K, 葉酸, 維生素B6, 維生素A' },
            { name: '芥藍', image: 'https://i.postimg.cc/YCG75815/image.png', nutrients: '維生素C, 維生素K, 維生素A, 葉酸, 維生素B6' },
            { name: '龍鬚菜', image: 'https://i.postimg.cc/WzyXGpFH/image.png', nutrients: '維生素A, 維生素C, 鐵, 鋅, 葉酸' },
            { name: '芹菜', image: 'https://i.postimg.cc/zBQdLPj8/image.png', nutrients: '維生素K, 維生素A, 維生素C, 葉酸, 維生素B5' },
            { name: '結球萵苣', image: 'https://i.postimg.cc/593kt1P1/image.png', nutrients: '維生素A, 維生素K, 維生素C, 葉酸, 維生素B1' },
            { name: '萵苣', image: 'https://i.postimg.cc/3N9KSvkK/3.png', nutrients: '維生素K, 維生素A, 葉酸, 維生素C, 維生素B1' },
            { name: '茼蒿', image: 'https://i.postimg.cc/bwc6CBjw/image.png', nutrients: '維生素A, 維生素K, 維生素C, 葉酸, 維生素B6' },
            { name: '蘿蔓', image: 'https://i.postimg.cc/Xqnjk87H/2.png', nutrients: '維生素A, 維生素K, 葉酸, 維生素C, 維生素B1' },
            { name: '莧菜', image: 'https://i.postimg.cc/D8TQ6S2B/amaranth.png', nutrients: '維生素K, 維生素A, 維生素C, 鈣, 鐵' },
            { name: '紅莧菜', image: 'https://i.postimg.cc/TPz0fWY3/image.png', nutrients: '維生素K, 維生素A, 維生素C, 鈣, 鐵' },
            { name: '紅鳳菜', image: 'https://i.postimg.cc/3xPtqwwj/image.png', nutrients: '維生素A, 維生素C, 鐵, 鈣, 花青素' },
            { name: '韭菜', image: 'https://i.postimg.cc/JzyTKXR4/image.png', nutrients: '維生素A, 維生素C, 維生素K, 維生素B6, 葉酸' },
            { name: '韭黃', image: 'https://i.postimg.cc/Z5cXW9Rm/2.png', nutrients: '維生素A, 維生素C, 膳食纖維' },
            { name: '韭菜花', image: 'https://i.postimg.cc/D00x44ZG/image.png', nutrients: '維生素C, 維生素A, 維生素K, 維生素B2, 葉酸' },
            { name: '九層塔', image: 'https://i.postimg.cc/jSBRFKSJ/image.png', nutrients: '維生素K, 維生素A, 維生素C, 葉酸, 維生素B6' },
            { name: '香菜', image: 'https://i.postimg.cc/KvqbRCGk/image.png', nutrients: '維生素K, 維生素A, 維生素C, 葉酸, 維生素B6' },
            { name: '蒜苗', image: 'https://i.postimg.cc/c1gWFpP7/image.png', nutrients: '維生素C, 維生素A, 維生素K, 維生素B6, 葉酸' },
            { name: '其他葉菜', image: 'https://i.postimg.cc/44HCWN8v/image.png', nutrients: '多種維生素, 礦物質' },
            { name: '各種生菜', image: 'https://i.postimg.cc/907v0J4g/image.png', nutrients: '維生素A, 維生素K, 葉酸' },
        ],
        '辛香料': [
            { name: '蔥', image: 'https://i.postimg.cc/RhXPpQ3q/image.png', nutrients: '維生素K, 維生素C, 維生素A, 維生素B6, 葉酸' },
            { name: '薑', image: 'https://i.postimg.cc/1zJ7SzVg/image.png', nutrients: '薑辣素, 鎂, 鉀, 錳, 維生素B6' },
            { name: '大蒜', image: 'https://i.postimg.cc/rzXQj03H/image.png', nutrients: '蒜素, 錳, 維生素B6, 維生素C, 硒' },
            { name: '洋蔥', image: 'https://i.postimg.cc/jW9Gjmkm/onion.png', nutrients: '槲皮素, 維生素C, 維生素B6, 葉酸, 鉀' },
            { name: '紅蔥頭', image: 'https://i.postimg.cc/bwpnwDvN/image.png', nutrients: '維生素A, 維生素C, 維生素B6, 葉酸, 鉀' },
            { name: '紅辣椒', image: 'https://i.postimg.cc/sMHLnbyx/chili.png', nutrients: '辣椒素, 維生素C, 維生素A, 維生素B6, 鉀' },
        ],
        '根莖穀豆': [
            { name: '白蘿蔔', image: 'https://i.postimg.cc/gr3fYMyt/daikon.png', nutrients: '維生素C, 葉酸, 維生素B6, 維生素B5, 維生素B1' },
            { name: '胡蘿蔔', image: 'https://i.postimg.cc/QdfFNfP0/image.png', nutrients: '維生素A, 維生素K, 維生素B6, 維生素C, 維生素B1' },
            { name: '地瓜', image: 'https://i.postimg.cc/Fs5MD7ym/image.png', nutrients: '維生素A, 維生素C, 維生素B6, 維生素B5, 維生素B1' },
            { name: '南瓜', image: 'https://i.postimg.cc/PPjnYGrk/pumpkin.png', nutrients: '維生素A, 維生素C, 維生素E, 維生素B2, 維生素B6' },
            { name: '馬鈴薯', image: 'https://i.postimg.cc/rKwXQ1Wh/potato.png', nutrients: '維生素C, 維生素B6, 鉀, 錳, 葉酸' },
            { name: '芋頭', image: 'https://i.postimg.cc/PrWBcTyD/image.png', nutrients: '鉀, 維生素C, 維生素E, 維生素B6, 錳' },
            { name: '山藥', image: 'https://i.postimg.cc/rKNX9hKR/yam.png', nutrients: '鉀, 錳, 維生素C, 維生素B6, 膳食纖維' },
            { name: '日本山藥', image: 'https://i.postimg.cc/YStHvkcH/image.png', nutrients: '鉀, 錳, 維生素C, 維生素B1, 膳食纖維' },
            { name: '海帶', image: 'https://i.postimg.cc/DzpVg6gY/image.png', nutrients: '碘, 維生素K, 葉酸, 鎂, 鈣' },
            { name: '蓮藕', image: 'https://i.postimg.cc/PxsTdZtS/image.png', nutrients: '維生素C, 維生素B6, 維生素B1, 維生素B5, 葉酸' },
            { name: '玉米筍', image: 'https://i.postimg.cc/2yvPCDfP/image.png', nutrients: '維生素C, 維生素A, 葉酸, 鐵, 鉀' },
            { name: '玉米', image: 'https://i.postimg.cc/ZRdnc4qM/image.png', nutrients: '葉黃素, 玉米黃素, 維生素B1, 維生素B5, 葉酸' },
            { name: '紫米', image: 'https://i.postimg.cc/yd2MqN2m/image.png', nutrients: '花青素, 鐵, 維生素E, 膳食纖維, 鎂' },
            { name: '糙米', image: 'https://i.postimg.cc/qRNPZKDB/image.png', nutrients: '錳, 硒, 鎂, 維生素B3, 維生素B1' },
            { name: '芝麻', image: 'https://i.postimg.cc/gJTjyrdR/image.png', nutrients: '鈣, 鐵, 鎂, 鋅, 維生素E' },
            { name: '黃豆', image: 'https://i.postimg.cc/bwwv5QJb/image.png', nutrients: '蛋白質, 鐵, 錳, 磷, 維生素K' },
            { name: '牛蒡', image: 'https://i.postimg.cc/02HxXhJG/image.png', nutrients: '膳食纖維, 鉀, 鎂, 菊糖, 多酚' },
            { name: '黑豆', image: 'https://i.postimg.cc/Pf1NvX9L/image.png', nutrients: '蛋白質, 大豆異黃酮, 膳食纖維, 花青素, 維生素A, 維生素E' }
        ],
        '瓜果莖': [
            { name: '白花椰', image: 'https://i.postimg.cc/JhBRwKWy/image.png', nutrients: '維生素C, 維生素K, 維生素B6, 葉酸, 維生素B5' },
            { name: '青花菜', image: 'https://i.postimg.cc/hQSWFxYt/broccoli.png', nutrients: '維生素C, 維生素K, 維生素A, 維生素B6, 葉酸' },
            { name: '番茄', image: 'https://i.postimg.cc/PPShj3Ts/tomato.png', nutrients: '茄紅素, 維生素C, 維生素A, 維生素K, 鉀' },
            { name: '茄子', image: 'https://i.postimg.cc/CKZxhSbx/image.png', nutrients: '花青素, 膳食纖維, 錳, 維生素K, 維生素B6' },
            { name: '糯米椒', image: 'https://i.postimg.cc/TK3SJfzB/shishito-pepper.png', nutrients: '維生素C, 維生素A, 維生素B6, 維生素K, 維生素B1' },
            { name: '青椒', image: 'https://i.postimg.cc/8cf5ZDPY/image.png', nutrients: '維生素C, 維生素A, 維生素B6, 維生素K, 葉酸' },
            { name: '甜椒', image: 'https://i.postimg.cc/zHY6CWNk/bell-pepper.png', nutrients: '維生素C, 維生素A, 維生素B6, 葉酸, 維生素K' },
            { name: '大黃瓜', image: 'https://i.postimg.cc/9fQ5ZKG7/image.png', nutrients: '維生素K, 維生素C, 鉀, 鎂, 錳' },
            { name: '小黃瓜', image: 'https://i.postimg.cc/pLZM9Rnv/image.png', nutrients: '維生素K, 維生素C, 維生素B5, 維生素A, 維生素B1' },
            { name: '櫛瓜', image: 'https://i.postimg.cc/Hr6qqV0p/zucchini.png', nutrients: '維生素C, 維生素A, 維生素B6, 葉酸, 維生素K' },
            { name: '蒲瓜', image: 'https://i.postimg.cc/K8FyvRjQ/image.png', nutrients: '維生素C, 維生素B3, 維生素B6, 鈣, 鐵' },
            { name: '絲瓜', image: 'https://i.postimg.cc/qBNXP3NP/2.png', nutrients: '維生素C, 維生素B6, 維生素B5, 維生素B1, 葉酸' },
            { name: '苦瓜', image: 'https://i.postimg.cc/Y07rzFZv/image.png', nutrients: '苦瓜苷, 維生素C, 維生素A, 葉酸, 鉀' },
            { name: '冬瓜', image: 'https://i.postimg.cc/6QHnSW-t6/image.png', nutrients: '維生素C, 維生素B1, 維生素B3, 維生素B5, 維生素B6' },
            { name: '四季豆', image: 'https://i.postimg.cc/Y9sKY4Lg/image.png', nutrients: '維生素K, 維生素C, 維生素A, 葉酸, 維生素B1' },
            { name: '菜豆', image: 'https://i.postimg.cc/MTSCdPCq/image.png', nutrients: '維生素K, 維生素C, 葉酸, 維生素A, 維生素B6' },
            { name: '荷蘭豆', image: 'https://i.postimg.cc/brRzCJf3/image.png', nutrients: '維生素K, 維生素C, 維生素B1, 維生素A, 葉酸' },
            { name: '毛豆', image: 'https://i.postimg.cc/PLNgTTK1/edamame.png', nutrients: '蛋白質, 葉酸, 鐵, 錳, 維生素K' },
            { name: '秋葵', image: 'https://i.postimg.cc/kBczSBpx/okra.png', nutrients: '維生素K, 維生素C, 葉酸, 維生素B6, 維生素A' },
            { name: '豆芽菜', image: 'https://i.postimg.cc/XYPnDmtS/image.png', nutrients: '維生素C, 維生素K, 葉酸, 維生素B1, 維生素B2' },
            { name: '竹筍', image: 'https://i.postimg.cc/fW0zHpSQ/image.png', nutrients: '膳食纖維, 鉀, 維生素B1, 維生素B6, 維生素C' },
            { name: '筊白筍', image: 'https://i.postimg.cc/Dz7SntBW/image.png', nutrients: '鉀, 葉酸, 維生素C, 維生素B1, 維生素B6' },
            { name: '蘆筍', image: 'https://i.postimg.cc/P5hBfbdK/image.png', nutrients: '葉酸, 維生素K, 維生素B1, 維生素B2, 維生素C' }
        ],
        '菌菇': [
            { name: '乾香菇', image: 'https://i.postimg.cc/HL3C5KH7/image.png', nutrients: '維生素D, 維生素B2, 維生素B3, 維生素B5, 維生素B6' },
            { name: '香菇', image: 'https://i.postimg.cc/z351RZfY/shiitake-mushroom.png', nutrients: '維生素D, 維生素B2, 維生素B3, 維生素B5, 維生素B6' },
            { name: '金針菇', image: 'https://i.postimg.cc/cLCsh09B/image.png', nutrients: '維生素B3, 維生素B5, 維生素B1, 維生素B2, 葉酸' },
            { name: '杏鮑菇', image: 'https://i.postimg.cc/zXG2bMMh/image.png', nutrients: '維生素B3, 維生素B2, 維生素B5, 葉酸, 維生素B1' },
            { name: '黑木耳', image: 'https://i.postimg.cc/Twpgvz3V/image.png', nutrients: '膳食纖維, 鐵, 多醣體, 鈣, 維生素B2' },
            { name: '白木耳', image: 'https://i.postimg.cc/SscrsNJ7/image.png', nutrients: '多醣體, 膳食纖維, 膠質, 維生素D, 硒' },
            { name: '秀珍菇', image: 'https://i.postimg.cc/Pfbrr6vY/image.png', nutrients: '維生素B3, 維生素B2, 維生素B5, 維生素D, 葉酸' },
            { name: '鴻喜菇', image: 'https://i.postimg.cc/L6N9jnTs/image.png', nutrients: '維生素B3, 維生素B2, 維生素B5, 維生素D, 葉酸' }
        ]
    };

    const categoryOrder = ['葉菜', '瓜果莖', '菌菇', '根莖穀豆', '辛香料'];
    const dataVersion = '7.15'; // 資料版本控制 (營養素更新)
    const itemsToRemoveInMigration = ['豆類', '綠豆', '紅豆', '花生']; // 在資料合併時要移除的舊品項

    const categoryColorVars = {
        '葉菜': '--leafy-color',
        '辛香料': '--spice-color',
        '根莖穀豆': '--root-color',
        '瓜果莖': '--gourd-bean-color',
        '菌菇': '--mushroom-color'
    };

    let vegetables = {};
    let eatenState = {};
    let categoryCollapseState = {}; // 追蹤類別的折疊狀態
    let recommendationCollapseState = null;
    let summaryPieChart2 = null; // 第二個圖表的實例
    let summaryPieChart3 = null; // 第三個圖表的實例
    let summaryPieChart4 = null; // 第四個圖表的實例 (微量元素)
    let dailyBarChart = null;   // 長條圖的實例
    let isStorageAvailable = true; // 追蹤 localStorage 是否可用
    let calendarDate = new Date(); // 用於月曆的目前日期
    let homeTreemapPage = 0; // 首頁 Treemap 分頁狀態

    const summarySection = document.getElementById('daily-summary-section');
    const selectModeBtn = document.getElementById('select-mode-btn');
    const selectionModal = document.getElementById('selection-modal');
    const editModal = document.getElementById('edit-modal');
    const confirmModal = document.getElementById('confirm-modal');
    const nutrientModal = document.getElementById('nutrient-modal');
    const managementModal = document.getElementById('management-modal');
    const aboutModal = document.getElementById('about-modal');
    const cameraModal = document.getElementById('camera-modal');
    const photoViewerModal = document.getElementById('photo-viewer-modal');
    const cameraChoiceModal = document.getElementById('camera-choice-modal');
    const photoEditorModal = document.getElementById('photo-editor-modal');
    const photoDeleteConfirmModal = document.getElementById('photo-delete-confirm-modal');
    const modalTitle = document.getElementById('modal-title');
    const editForm = document.getElementById('edit-form');
    const editCategoryInput = document.getElementById('edit-category');
    const editOrigNameInput = document.getElementById('edit-original-name');
    const vegNameInput = document.getElementById('veg-name-input');
    const vegImageInput = document.getElementById('veg-image-input');
    const vegImageLabel = document.getElementById('veg-image-label');
    const startDatePicker = document.getElementById('start-date-picker');
    const endDatePicker = document.getElementById('end-date-picker');
    const prevDayBtn = document.getElementById('prev-day-btn');
    const nextDayBtn = document.getElementById('next-day-btn');
    const uploadPhotoInput = document.getElementById('upload-photo-input');

    // 日期範圍變數
    let startDate, endDate;

    async function safeSetItem(key, value) {
        if (!isStorageAvailable) return;
        try {
            await idb.set(key, value);
        } catch (e) {
            console.error(`Error saving to IndexedDB: ${e}`);
            if (isStorageAvailable) { // Show the warning only once
                alert('由於您目前使用的環境限制，可能無法自動儲存您的紀錄');
            }
            isStorageAvailable = false;
        }
    }

    async function safeGetItem(key) {
        if (!isStorageAvailable) return null;
        try {
            return await idb.get(key);
        } catch (e) {
            console.error(`Error reading from IndexedDB: ${e}`);
            isStorageAvailable = false;
            return null;
        }
    }

    async function saveData() {
        await Promise.all([
            safeSetItem('vegetablesData', vegetables),
            safeSetItem('eatenVeggiesDaily', eatenState),
            safeSetItem('categoryCollapseState', categoryCollapseState),
            safeSetItem('recommendationCollapseState', recommendationCollapseState)
        ]);
    }

    async function loadData() {
        const storedVeggies = await safeGetItem('vegetablesData');
        const storedVersion = await safeGetItem('dataVersion');
        let loadedVeggies = storedVeggies || null;
        let migrationOccurred = false; // 標記是否執行了資料合併

        // 如果版本不符或沒有本地資料，則進行合併與更新
        if (!loadedVeggies || storedVersion !== dataVersion) {
            migrationOccurred = true;

            // --- 特定版本遷移邏輯 (在合併前執行) ---
            if (loadedVeggies && storedVersion === '5.4') {
                // 將 '豌豆' 更名為 '荷蘭豆'
                Object.keys(loadedVeggies).forEach(category => {
                    const vegToRename = loadedVeggies[category].find(v => v.name === '豌豆');
                    if (vegToRename) {
                        vegToRename.name = '荷蘭豆';
                    }
                });
            }
            const baseVeggies = structuredClone(defaultVegetables);
            
            if (loadedVeggies && Object.keys(loadedVeggies).length > 0) { // 如果存在舊資料，則進行合併
                const mergedVeggies = {};
                const processedNames = new Set();

                // 1. 遍歷新的預設資料，以建立順序和更新內容
                categoryOrder.forEach(category => {
                    if (baseVeggies[category]) {
                        mergedVeggies[category] = [];
                        baseVeggies[category].forEach(defaultVeg => {
                            // 在用戶的資料中尋找此蔬菜（不論分類）
                            let loadedVeg = null;
                            for (const cat in loadedVeggies) {
                                const found = loadedVeggies[cat].find(v => v.name === defaultVeg.name);
                                if (found) {
                                    loadedVeg = found;
                                    break;
                                }
                            }

                            if (loadedVeg) {
                                // 找到了。使用用戶的版本，但更新圖片和營養素
                                loadedVeg.image = defaultVeg.image;
                                loadedVeg.nutrients = defaultVeg.nutrients;
                                mergedVeggies[category].push(loadedVeg);
                            } else {
                                // 這是新的預設品項，直接加入
                                mergedVeggies[category].push(defaultVeg);
                            }
                            processedNames.add(defaultVeg.name);
                        });
                    }
                });

                // 2. 加入任何剩餘的用戶自訂品項
                Object.keys(loadedVeggies).forEach(category => {
                    loadedVeggies[category].forEach(loadedVeg => {
                        // 如果品項在移除清單中，則跳過，不加回去
                        if (itemsToRemoveInMigration.includes(loadedVeg.name)) {
                            return;
                        }

                        if (!processedNames.has(loadedVeg.name)) {
                            // 這是用戶自訂的品項，或是從預設中被刪除的品項，需要加回去
                            if (!mergedVeggies[category]) {
                                mergedVeggies[category] = []; // 如果分類是新的，則建立它
                            }
                            // 避免重複加入
                            if (!mergedVeggies[category].some(v => v.name === loadedVeg.name)) {
                                mergedVeggies[category].push(loadedVeg);
                            }
                        }
                    });
                });
                vegetables = mergedVeggies;
            } else {
                // 完全沒有本地資料，直接使用預設值
                vegetables = baseVeggies;
            }
            // 更新/儲存合併後的資料和新版本號
            await safeSetItem('vegetablesData', vegetables);
            await safeSetItem('dataVersion', dataVersion);

        } else {
            // 版本相符，直接從本地儲存載入
            vegetables = loadedVeggies;
        }

        const storedEatenState = await safeGetItem('eatenVeggiesDaily') || {};

        // 如果執行了資料合併，則對攝取紀錄進行遷移
        if (migrationOccurred) {
            let eatenStateModified = false;

            // 1. 處理移除
            Object.keys(storedEatenState).forEach(date => {
                itemsToRemoveInMigration.forEach(removedName => {
                    if (storedEatenState[date]?.[removedName]) {
                        delete storedEatenState[date][removedName];
                        eatenStateModified = true;
                    }
                });
            });

            // 2. 處理更名 (從 v5.4 升級)
            if (storedVersion === '5.4') {
                Object.keys(storedEatenState).forEach(date => {
                    if (storedEatenState[date]?.['豌豆']) {
                        storedEatenState[date]['荷蘭豆'] = storedEatenState[date]['豌豆'];
                        delete storedEatenState[date]['豌豆'];
                        eatenStateModified = true;
                    }
                });
            }

            // 處理更名: 白韭菜 -> 韭黃
            Object.keys(storedEatenState).forEach(date => {
                if (storedEatenState[date]?.['白韭菜']) {
                    storedEatenState[date]['韭黃'] = storedEatenState[date]['白韭菜'];
                    delete storedEatenState[date]['白韭菜'];
                    eatenStateModified = true;
                }
            });
            // 如果有變動，儲存清理後的攝取紀錄
            if (eatenStateModified) safeSetItem('eatenVeggiesDaily', JSON.stringify(storedEatenState));
        }

        // --- 資料結構遷移：將舊格式的 eatenState 轉換為新格式 ---
        eatenState = {};
        Object.keys(storedEatenState).forEach(date => {
            const entry = storedEatenState[date];
            if (entry && !entry.hasOwnProperty('items') && !entry.hasOwnProperty('photos')) {
                // 這是舊格式，轉換它
                eatenState[date] = {
                    items: entry,
                    photos: []
                };
            } else {
                // 這是新格式或空物件，直接使用
                eatenState[date] = entry;
            }
        });

        categoryCollapseState = await safeGetItem('categoryCollapseState') || {};
        
        // Migrate collapse state if a migration occurred (e.g., category rename)
        if (migrationOccurred && categoryCollapseState['瓜果'] !== undefined) {
            categoryCollapseState['瓜果莖'] = categoryCollapseState['瓜果'];
            delete categoryCollapseState['瓜果'];
            await safeSetItem('categoryCollapseState', categoryCollapseState); // Persist the change
        }

        recommendationCollapseState = await safeGetItem('recommendationCollapseState');

        Object.keys(vegetables).forEach(category => {
            if (typeof categoryCollapseState[category] === 'undefined') {
                categoryCollapseState[category] = (category !== '葉菜');
            }
        });
    }
    
    function handleDateChange() {
        startDate = startDatePicker.value;
        endDate = endDatePicker.value;

        if (endDate < startDate) {
            endDate = startDate;
            endDatePicker.value = startDate;
        }
        updateView();
    }

    function updateView() {
        const isMultiDay = startDate !== endDate;
        
        // 根據是否為多日選擇，禁用或啟用相關按鈕
        selectModeBtn.disabled = isMultiDay;
        document.getElementById('camera-btn').disabled = isMultiDay;
        document.getElementById('reset-button').disabled = isMultiDay;

        const buttonsToToggle = [selectModeBtn, document.getElementById('reset-button'), document.getElementById('camera-btn'), document.getElementById('upload-photo-input')];
        buttonsToToggle.forEach(btn => {
            if (isMultiDay) {
                btn.style.opacity = 0.5;
                btn.style.cursor = 'not-allowed';
            } else {
                btn.style.opacity = 1;
                btn.style.cursor = 'pointer';
            }
        });

        render();
    }

    function render() {
        const selectionModalBody = document.getElementById('selection-modal-body');
        selectionModalBody.innerHTML = '';
        categoryOrder.forEach(category => {
            if (!vegetables[category]) return;

            const isCollapsed = categoryCollapseState[category];

            const categorySection = document.createElement('div');
            categorySection.className = 'category-section';
            if (isCollapsed) {
                categorySection.classList.add('collapsed');
            }

            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            categoryHeader.dataset.category = category;
            
            const categoryHeaderTitle = document.createElement('div');
            categoryHeaderTitle.className = 'category-header-title';

            const categoryNameWrapper = document.createElement('div');
            categoryNameWrapper.className = 'category-name-wrapper';

            const categoryTitle = document.createElement('h2');
            categoryTitle.textContent = category;
            
            const toggleIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            toggleIcon.setAttribute("class", "toggle-icon");
            toggleIcon.setAttribute("viewBox", "0 0 24 24");
            toggleIcon.setAttribute("fill", "none");
            toggleIcon.innerHTML = `<polyline points="9 18 15 12 9 6"></polyline>`;

            categoryNameWrapper.appendChild(toggleIcon);
            categoryNameWrapper.appendChild(categoryTitle);

            // 在單日模式下才顯示分類計數
            const dailyEatenItems = startDate === endDate ? (eatenState[startDate]?.items || {}) : {};
            const eatenInCategory = vegetables[category].filter(v => dailyEatenItems[v.name]).length;
            const categoryCount = document.createElement('span');
            categoryCount.className = 'category-count';
            categoryCount.textContent = eatenInCategory;

            categoryHeaderTitle.appendChild(categoryNameWrapper);
            categoryHeaderTitle.appendChild(categoryCount);
            
            const colorVarName = categoryColorVars[category];
            if (colorVarName) {
                categoryTitle.style.color = `var(${colorVarName})`;
                categoryCount.style.color = `var(${colorVarName})`;
            }
            categoryHeader.appendChild(categoryHeaderTitle);

            const grid = document.createElement('div');
            grid.className = 'vegetable-grid';

            vegetables[category].forEach(veg => {
                const item = document.createElement('div');
                item.className = 'veg-item';
                // 只有在單日檢視時，才標示為已食用
                const isMultiDay = startDate !== endDate;
                if (!isMultiDay && eatenState[startDate]?.items?.[veg.name]) {
                    item.classList.add('eaten');
                }
                item.dataset.name = veg.name;
                item.dataset.category = category;

                item.innerHTML = `
                    <div class="veg-image-container">
                        <img class="veg-image" src="${veg.image}" alt="${veg.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/e0e0e0/757575?text=${encodeURIComponent(veg.name)}';">
                    </div>
                    <div class="veg-name">${veg.name}</div>
                    <div class="veg-actions">
                        <button class="action-btn info-btn" title="資訊">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></svg>
                        </button>
                        <button class="action-btn edit-btn" title="編輯">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>
                        </button>
                        <button class="action-btn delete-btn" title="刪除">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></svg>
                        </button>
                    </div>
                `;
                grid.appendChild(item);
            });

            categorySection.appendChild(categoryHeader);
            categorySection.appendChild(grid);
            selectionModalBody.appendChild(categorySection);
        });
        renderSummary();
    }

    function getDatesInRange(startDateStr, endDateStr) {
        const dates = [];
        let currentDate = new Date(startDateStr + 'T00:00:00Z'); // 使用Z確保UTC
        const endDate = new Date(endDateStr + 'T00:00:00Z');

        while (currentDate <= endDate) {
            dates.push(currentDate.toISOString().split('T')[0]);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return dates;
    }

    function renderSummary() {
        const isMultiDay = startDate !== endDate;
        const datesInRange = getDatesInRange(startDate, endDate);
        const aggregatedEatenSet = new Set();
        const itemServingCounts = {}; // 用於圖表1：計算每個品項的攝取次數

        datesInRange.forEach(dateStr => {
            const dailyEatenItems = eatenState[dateStr]?.items || {};
            Object.keys(dailyEatenItems).forEach(vegName => {
                if (dailyEatenItems[vegName]) {
                    aggregatedEatenSet.add(vegName);
                    itemServingCounts[vegName] = (itemServingCounts[vegName] || 0) + 1;
                }
            });
        });
        const eatenList = Array.from(aggregatedEatenSet);
        const summaryTitleEl = summarySection.querySelector('.summary-header h3');
        let titleText = '';

        const today = new Date().toISOString().split('T')[0];

        if (isMultiDay) {
            // 多日模式
            const dayCount = datesInRange.length;
            titleText = `${dayCount}天攝取 <span id="summary-count">${eatenList.length}</span> 種蔬菜`;
        } else {
            // 單日模式
            if (startDate === today) {
                titleText = `今日攝取 <span id="summary-count">${eatenList.length}</span> 種蔬菜`;
            } else {
                const [year, month, day] = startDate.split('-').map(Number);
                const formattedDate = `${month}/${day}`;
                titleText = `${formattedDate}攝取 <span id="summary-count">${eatenList.length}</span> 種蔬菜`;
            }
        }
        summaryTitleEl.innerHTML = titleText;
        
        const listEl = document.getElementById('summary-list');
        const uniqueCategoryCounts = {}; // 用於圖表3：計算每個分類下的獨立品項數
        const nutrientCounts = {};
        const traceElementCounts = {}; // 用於圖表4：微量元素計數
        
        listEl.innerHTML = ''; // 每次渲染前清空列表
        document.getElementById('photo-gallery-section').innerHTML = ''; // 清空照片區
        if (eatenList.length === 0) {
            // 如果沒有攝取項目，顯示佔位符
            for (let i = 0; i < 2; i++) {
                const li = document.createElement('li');
                li.className = 'summary-item-placeholder';
                listEl.appendChild(li);
            }
        } else {
            // 定義哪些是微量元素
            const traceElements = ['碘', '鎂', '鐵', '鈣', '鉀', '鋅', '錳', '硒', '磷'];

            eatenList.forEach(name => {
                let vegInfo = null;
                for (const category in vegetables) {
                    const found = vegetables[category].find(v => v.name === name);
                    if (found) {
                        vegInfo = found;
                        uniqueCategoryCounts[category] = (uniqueCategoryCounts[category] || 0) + 1;
                        if (found.nutrients) {
                            const nutrients = found.nutrients.split(',');
                            nutrients.forEach(nutrient => {
                                const trimmedNutrient = nutrient.trim();
                                if (trimmedNutrient) {
                                    if (traceElements.includes(trimmedNutrient)) {
                                        traceElementCounts[trimmedNutrient] = (traceElementCounts[trimmedNutrient] || 0) + 1;
                                    } else {
                                        nutrientCounts[trimmedNutrient] = (nutrientCounts[trimmedNutrient] || 0) + 1;
                                    }
                                }
                            });
                        }
                        break;
                    }
                }
                // 將攝取項目渲染到列表中
                if (vegInfo) {
                    const li = document.createElement('li');
                    li.className = 'summary-item';
                    li.dataset.name = vegInfo.name; // 加上 data-name 以便識別
                    li.innerHTML = `
                        <img src="${vegInfo.image}" alt="${vegInfo.name}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/e0e0e0/757575?text=?';">
                        <span>${vegInfo.name}</span>
                        <button class="remove-btn" title="取消選取">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    `;
                    listEl.appendChild(li);
                }
            });
        }

        // 渲染照片 (單日或多日)
        const photoGallery = document.getElementById('photo-gallery-section');
        photoGallery.innerHTML = ''; // 每次渲染前清空

        const allPhotosInRange = [];
        datesInRange.forEach(dateStr => {
            const dailyPhotos = eatenState[dateStr]?.photos || [];
            dailyPhotos.forEach((photoData, index) => {
                // 根據您的要求，只處理新的 Blob 格式照片，舊的 Base64 格式會被忽略
                if (photoData.url instanceof Blob) {
                    allPhotosInRange.push({
                        ...photoData,
                        displayUrl: URL.createObjectURL(photoData.url),
                        date: dateStr,
                        originalIndex: index
                    });
                }
            });
        });

        // 依日期排序
        allPhotosInRange.sort((a, b) => new Date(a.date) - new Date(b.date) || a.originalIndex - b.originalIndex);

        if (allPhotosInRange.length > 0) {
            allPhotosInRange.forEach(photoData => {
                const wrapper = document.createElement('div');
                wrapper.className = 'photo-thumbnail-wrapper';

                const img = document.createElement('img');
                img.src = photoData.displayUrl;
                img.className = 'photo-thumbnail';
                img.alt = `攝取紀錄照片 (${photoData.date})`;
                img.title = photoData.date; // 滑鼠懸停時顯示日期

                wrapper.appendChild(img);

                // 僅在單日模式下顯示刪除按鈕
                if (!isMultiDay) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-photo-btn';
                    removeBtn.title = '刪除照片';
                    removeBtn.dataset.index = photoData.originalIndex;
                    removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
                    wrapper.appendChild(removeBtn);
                }
                
                photoGallery.appendChild(wrapper);
            });
        }

        // Clean up object URLs after rendering to prevent memory leaks
        photoGallery.addEventListener('load', () => {
            allPhotosInRange.forEach(p => URL.revokeObjectURL(p.displayUrl));
        }, { once: true });
        renderCharts(itemServingCounts, nutrientCounts, uniqueCategoryCounts, traceElementCounts);

        // 根據日期選擇，決定是否顯示每日長條圖
        const dailyChartContainer = document.getElementById('daily-chart-container');

        if (eatenList.length === 0) {
            dailyChartContainer.style.display = 'block';
            renderPlaceholderBarChart();
        } else if (isMultiDay) {
            // 多日檢視
            dailyChartContainer.style.display = 'block';
            const dailyCategoryCounts = {};
            const allCategoriesInRange = new Set();

            datesInRange.forEach(dateStr => {
                dailyCategoryCounts[dateStr] = {};
                const dailyEatenItems = eatenState[dateStr]?.items || {}; // 從 items 讀取
                Object.keys(dailyEatenItems).forEach(vegName => {
                    for (const category in vegetables) {
                        if (vegetables[category].some(v => v.name === vegName)) {
                            dailyCategoryCounts[dateStr][category] = (dailyCategoryCounts[dateStr][category] || 0) + 1;
                            allCategoriesInRange.add(category);
                            break;
                        }
                    }
                });
            });
            const sortedCategories = Array.from(allCategoriesInRange).sort((a, b) => {
                const indexA = categoryOrder.indexOf(a);
                const indexB = categoryOrder.indexOf(b);
                return indexA - indexB;
            });
            renderMultiDayTrendChart(dailyCategoryCounts, sortedCategories);
        } else { 
            // 單日檢視
            dailyChartContainer.style.display = 'block';
            renderSingleDayCategoryChart(uniqueCategoryCounts);
        }
        renderRecommendations(endDate);
    }

    // 輔助函式，根據基底顏色和數量生成不同深淺的顏色陣列
    function generateColorShades(baseColor, count) {
        if (count <= 0) return [];
        if (count === 1) return [baseColor];
        
        const shades = [];
        // 將 HEX 轉為 RGB
        const r_base = parseInt(baseColor.slice(1, 3), 16);
        const g_base = parseInt(baseColor.slice(3, 5), 16);
        const b_base = parseInt(baseColor.slice(5, 7), 16);

        // 定義亮度變化的範圍，例如 0.65 (較暗) 到 1.15 (較亮)
        const minFactor = 0.65;
        const maxFactor = 1.15;

        for (let i = 0; i < count; i++) {
            // 避免只有一個項目時除以零
            const step = (count > 1) ? i / (count - 1) : 1;
            const factor = minFactor + (maxFactor - minFactor) * step;

            // 計算新的 RGB 值並確保在 0-255 範圍內
            const r = Math.min(255, Math.max(0, Math.round(r_base * factor)));
            const g = Math.min(255, Math.max(0, Math.round(g_base * factor)));
            const b = Math.min(255, Math.max(0, Math.round(b_base * factor)));

            // 將 RGB 轉回 HEX
            const toHex = c => c.toString(16).padStart(2, '0');
            shades.push(`#${toHex(r)}${toHex(g)}${toHex(b)}`);
        }
        return shades;
    }

    // 輔助函式，用於建立圖表設定
    function createChartConfig(title, labels, data, colorPalette, centerText) {
        const hasData = data && data.length > 0;
        const isMobile = window.innerWidth <= 992;
        const computedStyle = getComputedStyle(document.documentElement);
        let chartData;

        if (hasData) {
            chartData = {
                labels: labels,
                datasets: [{
                    label: '數量',
                    data: data,
                    backgroundColor: colorPalette,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            };
        } else {
            // 當沒有數據時，顯示灰色佔位符圓餅圖
            chartData = {
                labels: ['無資料'], // 提供假標籤以強制圖例佔據空間
                datasets: [{
                    label: '',
                    data: [1],
                    backgroundColor: [computedStyle.getPropertyValue('--placeholder-bg').trim() || '#eaeaea'],
                    borderWidth: 0,
                    hoverOffset: 0
                }]
            };
        }
        
        return {
            type: 'doughnut',
            data: chartData,
            options: {
                layout: {
                    padding: 1
                },
                responsive: true,
                maintainAspectRatio: false, // 確保圖表填滿容器，不維持原始長寬比
                cutout: '70%', // 圓環厚度
                plugins: {
                    title: {
                        display: false,
                    },
                    legend: {
                        position: isMobile ? 'bottom' : 'right',
                        align: isMobile ? 'center' : 'center',
                        labels: {
                            font: { 
                                family: "'Noto Sans TC', sans-serif", 
                                size: 11 
                            },
                            padding: isMobile ? 15 : 10,
                            boxWidth: hasData ? 12 : 0, // 無資料時隱藏色塊
                            color: hasData ? Chart.defaults.color : 'transparent' // 無資料時隱藏文字
                        },
                        display: true // 總是顯示圖例以保持尺寸一致
                    },
                    tooltip: {
                        enabled: hasData
                    },
                    doughnutText: { // 自訂插件的選項
                        text: {
                            main: hasData ? centerText.main : '0',
                            sub: centerText.sub
                        }
                    }
                }
            }
        };
    }

    // 渲染兩個圖表
    function renderCharts(itemCounts, nutrientCounts, categoryCounts, traceElementCounts) {
        if (summaryPieChart2) summaryPieChart2.destroy();
        if (summaryPieChart3) summaryPieChart3.destroy();
        if (summaryPieChart4) summaryPieChart4.destroy();

        const computedStyle = getComputedStyle(document.documentElement);
        const getCategoryColors = (labels) => labels.map(label => {
            const varName = categoryColorVars[label];
            return varName ? computedStyle.getPropertyValue(varName).trim() : '#cccccc';
        });
        
        const traceElementColors = [
            '#8cd1e6', '#f5b7cb', '#b2d8b2', '#fde2a3', '#d7bde2',
            '#a9dfbf', '#f1c4a8', '#aed6f1', '#f5cba7', '#b3b6b7'
        ];
        const nutrientColors = [
            '#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f',
            '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'
        ];

        // 圖表2: 營養素分佈
        const sortedNutrients = Object.entries(nutrientCounts)
            .sort(([, a], [, b]) => b - a);

        const nutrientLabels = sortedNutrients.map(([label]) => label);
        const nutrientData = sortedNutrients.map(([, data]) => data);

        const nutrientCenterText = { main: nutrientLabels.length, sub: '' };
        const nutrientConfig = createChartConfig(
            '主要營養素',
            nutrientLabels,
            nutrientData,
            nutrientColors,
            nutrientCenterText
        );
        const ctx2 = document.getElementById('summary-pie-chart-2').getContext('2d');
        summaryPieChart2 = new Chart(ctx2, nutrientConfig);

        // 圖表3: 攝取種類 (各分類下的獨立品項數)
        const sortedCategories = Object.entries(categoryCounts)
            .sort(([a], [b]) => {
                const indexA = categoryOrder.indexOf(a);
                const indexB = categoryOrder.indexOf(b);
                return indexA - indexB;
            });

        const categoryLabels = sortedCategories.map(([label]) => label);
        const categoryData = sortedCategories.map(([, data]) => data);

        const totalUniqueCategories = categoryLabels.length;
        const categoryCenterText = { main: totalUniqueCategories, sub: '' };
        const categoryConfig = createChartConfig(
            '攝取大類',
            categoryLabels, 
            categoryData, 
            getCategoryColors(categoryLabels),
            categoryCenterText
        );
        const ctx3 = document.getElementById('summary-pie-chart-3').getContext('2d');
        summaryPieChart3 = new Chart(ctx3, categoryConfig);

        // 圖表4: 微量元素分佈
        const sortedTraceElements = Object.entries(traceElementCounts)
            .sort(([, a], [, b]) => b - a);

        const traceLabels = sortedTraceElements.map(([label]) => label);
        const traceData = sortedTraceElements.map(([, data]) => data);

        const traceCenterText = { main: traceLabels.length, sub: '' };
        const traceConfig = createChartConfig(
            '微量元素',
            traceLabels,
            traceData,
            traceElementColors,
            traceCenterText
        );
        const ctx4 = document.getElementById('summary-pie-chart-4').getContext('2d');
        summaryPieChart4 = new Chart(ctx4, traceConfig);
    }

    function renderMultiDayTrendChart(dailyCategoryCounts, allCategories) {
        if (dailyBarChart) {
            dailyBarChart.destroy();
        }

        const ctx = document.getElementById('daily-bar-chart').getContext('2d');
        const computedStyle = getComputedStyle(document.documentElement);

        const dates = Object.keys(dailyCategoryCounts);

        const datasets = allCategories.map(category => {
            const colorVar = categoryColorVars[category];
            const color = colorVar ? computedStyle.getPropertyValue(colorVar).trim() : '#cccccc';
            const dataForCategory = dates.map(date => dailyCategoryCounts[date][category] || 0);

            return {
                label: category,
                data: dataForCategory,
                backgroundColor: color,
            };
        });

        const config = {
            type: 'bar',
            data: {
                labels: dates,
                datasets: datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 5, right: 15, bottom: 5, left: 10 }
                },
                scales: {
                    x: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            color: computedStyle.getPropertyValue('--text-secondary').trim(),
                            stepSize: 1 // 確保X軸刻度為整數
                        },
                        grid: { color: '#efefef' }
                    },
                    y: {
                        stacked: true,
                        ticks: {
                            font: { family: "'Noto Sans TC', sans-serif", size: 12 },
                            color: computedStyle.getPropertyValue('--text-primary').trim(),
                            // 將 YYYY-MM-DD 格式化為 MM/DD 以節省空間
                            callback: function(value) {
                                const dateStr = this.getLabelForValue(value);
                                const [year, month, day] = dateStr.split('-').map(Number);
                                return `${month}/${day}`;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: { family: "'Noto Sans TC', sans-serif", size: 11 },
                            padding: 10,
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        callbacks: {
                            title: function(context) {
                                return context[0].label; // Tooltip 標題顯示完整日期
                            },
                            label: function(context) {
                                const datasetLabel = context.dataset.label || '';
                                const value = context.parsed.x;
                                if (value > 0) {
                                    return `${datasetLabel}: ${value} 種`;
                                }
                                return null; // 不顯示數值為 0 的項目
                            }
                        }
                    }
                }
            }
        };
        dailyBarChart = new Chart(ctx, config);
    }


    function renderSingleDayCategoryChart(categoryCounts) {
        if (dailyBarChart) {
            dailyBarChart.destroy();
        }

        const ctx = document.getElementById('daily-bar-chart').getContext('2d');
        const computedStyle = getComputedStyle(document.documentElement);

        const sortedEntries = Object.entries(categoryCounts).sort(([keyA], [keyB]) => {
            const indexA = categoryOrder.indexOf(keyA);
            const indexB = categoryOrder.indexOf(keyB);
            return indexA - indexB;
        });

        const labels = sortedEntries.map(entry => entry[0]);
        const data = sortedEntries.map(entry => entry[1]);

        const backgroundColors = labels.map(label => {
            const varName = categoryColorVars[label];
            return varName ? computedStyle.getPropertyValue(varName).trim() : '#cccccc';
        });

        const config = {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '種類數量',
                    data: data,
                    backgroundColor: backgroundColors,
                    barThickness: 20,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 5, right: 15, bottom: 5, left: 10 }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            color: computedStyle.getPropertyValue('--text-secondary').trim(),
                            stepSize: 1
                        },
                        grid: { color: '#efefef' }
                    },
                    y: {
                        ticks: {
                            font: { family: "'Noto Sans TC', sans-serif", size: 14, weight: 500 },
                            color: computedStyle.getPropertyValue('--text-primary').trim()
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true, callbacks: { label: function(context) { return `種類數量: ${context.parsed.x} 種`; } } }
                }
            }
        };
        dailyBarChart = new Chart(ctx, config);
    }

    function renderPlaceholderBarChart() {
        if (dailyBarChart) {
            dailyBarChart.destroy();
        }

        const ctx = document.getElementById('daily-bar-chart').getContext('2d');
        const computedStyle = getComputedStyle(document.documentElement);
        const placeholderColor = computedStyle.getPropertyValue('--placeholder-bg').trim() || '#eaeaea';

        const config = {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [{
                    data: [1],
                    backgroundColor: [placeholderColor],
                    barThickness: 'flex',
                    maxBarThickness: 40
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false, max: 1 },
                    y: { display: false }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false },
                    barChartText: { text: '無資料' }
                },
                animation: false
            }
        };
        dailyBarChart = new Chart(ctx, config);
    }

    function renderRecommendations(referenceDateStr) {
        // 1. Get dates for the last 30 days based on the selected end date
        const referenceDate = new Date(referenceDateStr + 'T00:00:00Z');
        const last30Days = [];
        for (let i = 0; i < 30; i++) {
            const d = new Date(referenceDate);
            d.setDate(d.getDate() - i);
            last30Days.push(d.toISOString().split('T')[0]);
        }

        // 2. Collect all vegetables eaten in the last 30 days
        const eatenInLast30Days = new Set();
        last30Days.forEach(dateStr => {
            const dailyEatenItems = eatenState[dateStr]?.items || {};
            Object.keys(dailyEatenItems).forEach(vegName => { // 從 items 讀取
                if (dailyEatenItems[vegName]) {
                    eatenInLast30Days.add(vegName);
                }
            });
        });

        // 3. Find all vegetables that were NOT eaten
        const recommendedVeggies = [];
        Object.keys(vegetables).forEach(category => {
            vegetables[category].forEach(veg => {
                if (!eatenInLast30Days.has(veg.name)) {
                    recommendedVeggies.push({ ...veg, category: category });
                }
            });
        });

        // 4. Render them to the DOM
        const recommendationSection = document.getElementById('recommendation-section');
        const recommendationGrid = document.getElementById('recommendation-grid');
        recommendationGrid.innerHTML = '';

        const hasRecommendations = recommendedVeggies.length > 0;

        if (hasRecommendations) {
            recommendedVeggies.forEach(veg => {
                const item = document.createElement('div');
                item.className = 'veg-item';
                item.dataset.name = veg.name;
                item.dataset.category = veg.category;

                 item.innerHTML = `
                    <div class="veg-image-container">
                        <img class="veg-image" src="${veg.image}" alt="${veg.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/e0e0e0/757575?text=${encodeURIComponent(veg.name)}';">
                    </div>
                    <div class="veg-name">${veg.name}</div>
                    <div class="veg-actions">
                        <button class="action-btn info-btn" title="資訊">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></svg>
                        </button>
                    </div>
                `;
                recommendationGrid.appendChild(item);
            });
        } else {
            // When there are no items, display a message inside the grid.
            const placeholder = document.createElement('div');
            placeholder.textContent = '太棒了！30天內已攝取所有品項。';
            placeholder.style.padding = '1rem';
            placeholder.style.color = 'var(--text-secondary)';
            placeholder.style.textAlign = 'center';
            placeholder.style.gridColumn = '1 / -1';
            recommendationGrid.appendChild(placeholder);
        }

        // Set default collapsed state if it hasn't been set by the user yet
        if (recommendationCollapseState === null) {
            recommendationCollapseState = true; // Default to collapsed
        }
        
        // Apply the state
        recommendationSection.classList.toggle('collapsed', recommendationCollapseState);
    }

    function openModal(type, data) {
        editForm.reset();
        const categorySelect = document.getElementById('veg-category-select');
        const vegNutrientsInput = document.getElementById('veg-nutrients-input');

        if (type === 'add') {
            modalTitle.textContent = '新增食材';
            editModal.classList.add('add-mode');
            vegImageLabel.textContent = '圖片網址 (必要):';
            editOrigNameInput.value = '';
            vegNameInput.value = '';
            vegImageInput.placeholder = '請貼上圖片的網址';
            vegNutrientsInput.value = '';

            // Populate category dropdown
            categorySelect.innerHTML = ''; // Clear previous options
            categoryOrder.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        } else { // edit
            editModal.classList.remove('add-mode');
            modalTitle.textContent = '編輯食材';
            vegImageLabel.textContent = '新圖片網址:';
            editCategoryInput.value = data.category;
            const veg = vegetables[data.category]?.find(v => v.name === data.name);
            if (!veg) {
                alert(`開啟編輯失敗：在分類 '${data.category}' 中找不到食材 '${data.name}'。資料可能已過期，請重新整理頁面。`);
                return;
            }
            editOrigNameInput.value = veg.name;
            vegNameInput.value = veg.name;
            vegImageInput.value = ''; 
            vegImageInput.placeholder = '若不修改請留空';
            const currentNutrients = veg.nutrients || '';
            vegNutrientsInput.value = currentNutrients.includes('待補充') ? '' : currentNutrients;
        }
        editModal.style.display = 'flex';
    }

    function openNutrientModal(category, name) {
        const veg = vegetables[category].find(v => v.name === name);
        if (!veg) return;

        document.getElementById('nutrient-modal-title').textContent = veg.name;
        const imgEl = document.getElementById('nutrient-modal-image');
        imgEl.src = veg.image;
        imgEl.alt = veg.name;
        document.getElementById('nutrient-modal-text').textContent = veg.nutrients || '暫無資料';

        nutrientModal.style.display = 'flex';
    }

    function closeModal(modalElement) {
        modalElement.style.display = 'none';
    }

    function showConfirmation(message, onConfirm) {
        document.getElementById('confirm-message').textContent = message;
        confirmModal.style.display = 'flex';

        const confirmOk = document.getElementById('confirm-ok');
        const confirmCancel = document.getElementById('confirm-cancel');

        const okListener = () => {
            closeModal(confirmModal);
            onConfirm();
            cleanup();
        };

        const cancelListener = () => {
            closeModal(confirmModal);
            cleanup();
        };
        
        function cleanup() {
            confirmOk.removeEventListener('click', okListener);
            confirmCancel.removeEventListener('click', cancelListener);
        }

        confirmOk.addEventListener('click', okListener, { once: true });
        confirmCancel.addEventListener('click', cancelListener, { once: true });
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        const newName = vegNameInput.value.trim();
        if (!newName) {
            alert('請輸入名稱！');
            return;
        }

        const originalName = editOrigNameInput.value;
        const isEditing = !!originalName;

        if (isEditing) {
            // --- 編輯邏輯 ---
            const category = editCategoryInput.value;
            const newImageUrl = vegImageInput.value.trim();
            const newNutrients = document.getElementById('veg-nutrients-input').value.trim();
            const veg = vegetables[category]?.find(v => v.name === originalName);

            if (!veg) {
                alert(`儲存失敗：找不到原始食材 '${originalName}'。請重新操作。`);
                console.error(`EDIT FAILED: Cannot find vegetable with name "${originalName}" in category "${category}"`);
                closeModal(editModal);
                return;
            }

            // 檢查新名稱是否與同分類下的其他食材重複
            if (newName !== originalName && vegetables[category].some(v => v.name === newName)) {
                alert(`儲存失敗：分類 '${category}' 中已存在名為 '${newName}' 的食材。`);
                return;
            }

            // 如果名稱被修改，同步更新所有日期的攝取紀錄
            if (newName !== originalName) {
                Object.keys(eatenState).forEach(dateStr => {
                    const dailyItems = eatenState[dateStr]?.items;
                    if (dailyItems && dailyItems[originalName]) {
                        delete dailyItems[originalName];
                        dailyItems[newName] = true;
                    }
                });
            }

            // 更新食材物件的屬性
            veg.name = newName;
            if (newImageUrl) {
                veg.image = newImageUrl;
            }
            veg.nutrients = newNutrients || '待補充';
        } else {
            // --- 新增邏輯 ---
            const category = document.getElementById('veg-category-select').value;
            const newImageUrl = vegImageInput.value.trim();
            const newNutrients = document.getElementById('veg-nutrients-input').value.trim();
            if (!newImageUrl) {
                alert('新增時，必須提供圖片網址！');
                return;
            }
            if (!vegetables[category]) {
                vegetables[category] = [];
            }
            if (vegetables[category].some(v => v.name === newName)) {
                alert(`新增失敗：分類 '${category}' 中已存在名為 '${newName}' 的食材。`);
                return;
            }
            vegetables[category].push({ name: newName, image: newImageUrl, nutrients: newNutrients || '待補充' });
        }

        saveData();
        updateView();
        closeModal(editModal);
    }
    
    // --- 照片編輯功能 ---
    function openPhotoEditor(imageFile) {
        const image = document.getElementById('photo-editor-image');
        const reader = new FileReader();

        reader.onload = (e) => {
            image.src = e.target.result;
            photoEditorModal.style.display = 'flex';

            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(image, {
                aspectRatio: NaN, // 自由裁剪
                viewMode: 1,
                background: false,
                autoCropArea: 0.8,
            });
        };
        reader.readAsDataURL(imageFile);
    }

    document.getElementById('editor-rotate-btn').addEventListener('click', () => {
        if (cropper) {
            cropper.rotate(90);
        }
    });

    document.getElementById('editor-confirm-btn').addEventListener('click', () => {
        if (!cropper) return;

        cropper.getCroppedCanvas({
            maxWidth: 800, // 限制最大寬度
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        }).toBlob(async (blob) => {
            await processAndSaveImages([blob]);
            closeModal(photoEditorModal);
            if (cropper) cropper.destroy();
            cropper = null;
        }, 'image/jpeg', 0.8); // 壓縮品質
    });

    // --- Blob <-> Base64 轉換輔助函式 ---
    function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    function base64ToBlob(base64) {
        return fetch(base64).then(res => res.blob());
    }

    // --- 資料匯出/匯入功能 (已更新為 IndexedDB 和 Blob 格式) ---
    async function downloadDataAsJson() {
        // 建立一個包含所有現存蔬菜名稱的 Set，以便快速查找
        const allExistingVegNames = new Set(
            Object.values(vegetables).flatMap(category => category.map(veg => veg.name))
        );

        const cleanEatenState = {};
        // 異步處理照片轉換
        for (const date in eatenState) {
            const dailyEntry = eatenState[date];
            if (dailyEntry) {
                // 清理攝取品項，只保留現存的蔬菜
                const cleanedItems = {};
                if (dailyEntry.items) {
                    for (const vegName in dailyEntry.items) {
                        if (allExistingVegNames.has(vegName)) {
                            cleanedItems[vegName] = dailyEntry.items[vegName];
                        }
                    }
                }

                const newPhotos = [];
                for (const photo of (dailyEntry.photos || [])) {
                    let url = photo.url;
                    if (photo.url instanceof Blob) url = await blobToBase64(photo.url);
                    newPhotos.push({ ...photo, url });
                }
                cleanEatenState[date] = {
                    items: cleanedItems,
                    photos: newPhotos
                };
            }
        }

        const dataToSave = {
            version: dataVersion,
            vegetables: vegetables,
            eatenState: cleanEatenState,
            categoryCollapseState: categoryCollapseState,
            recommendationCollapseState: recommendationCollapseState
        };

        const dataStr = JSON.stringify(dataToSave);
        const dataBlob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        const localToday = toLocalISOString(new Date());
        link.download = `veg-backup-${localToday}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        closeModal(managementModal);

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data && data.vegetables && data.eatenState) {
                    // 建立一個包含所有從檔案中匯入的蔬菜名稱的 Set
                    const importedVegNames = new Set(
                        Object.values(data.vegetables).flatMap(category => category.map(veg => veg.name))
                    );

                    showConfirmation("確定要用上傳的檔案覆蓋目前所有資料嗎？此操作無法復原。", async () => {
                        vegetables = data.vegetables;
                        
                        const importedEatenState = data.eatenState;
                        eatenState = {}; // 清空目前的狀態

                        // 將 Base64 轉回 Blob
                        for (const date in importedEatenState) {
                            const entry = importedEatenState[date];
                            if (!entry) continue;

                            // 清理攝取品項，確保只包含檔案中定義的蔬菜
                            const cleanedItems = {};
                            if (entry.items) {
                                for (const vegName in entry.items) {
                                    // 只加入存在於 `importedVegNames` 中的品項
                                    if (importedVegNames.has(vegName)) {
                                        cleanedItems[vegName] = entry.items[vegName];
                                    }
                                }
                            }

                            // 將照片從 Base64 轉回 Blob
                            const newPhotos = [];
                            for (const photo of (entry.photos || [])) {
                                let url = photo.url;
                                if (typeof url === 'string' && url.startsWith('data:image')) {
                                    url = await base64ToBlob(url);
                                }
                                newPhotos.push({ ...photo, url });
                            }

                            eatenState[date] = {
                                items: cleanedItems,
                                photos: newPhotos
                            };
                        }

                        categoryCollapseState = data.categoryCollapseState || {};
                        recommendationCollapseState = data.recommendationCollapseState !== undefined ? data.recommendationCollapseState : null;
                        
                        await safeSetItem('dataVersion', data.version || dataVersion);

                        await saveData(); // 等待所有資料儲存完成
                        updateView(); // 重新渲染畫面
                        alert('資料已成功載入！');
                    });
                } else {
                    alert('檔案格式不符或已損毀，載入失敗。');
                }
            } catch (error) {
                console.error("解析 JSON 檔案時出錯:", error);
                alert('讀取檔案時發生錯誤，請確認檔案為有效的 JSON 格式。');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    }

    // Event Listeners
    // --- 統一的點擊處理 ---
    document.getElementById('selection-modal-body').addEventListener('click', e => {
        const header = e.target.closest('.category-header');
        const vegItem = e.target.closest('.veg-item');

        // 處理分類標題的點擊（折疊/展開）
        if (header) {
            const category = header.dataset.category;
            categoryCollapseState[category] = !categoryCollapseState[category];
            header.parentElement.classList.toggle('collapsed');
            saveData(); // 保存折疊狀態
            return;
        }

        // 處理蔬菜項目的點擊
        if (vegItem) {
            const name = vegItem.dataset.name;
            const category = vegItem.dataset.category;
            const isMultiDay = startDate !== endDate;

            // 優先處理圖示按鈕的點擊
            if (e.target.closest('.info-btn')) {
                openNutrientModal(category, name);
                return;
            }
            if (e.target.closest('.edit-btn')) {
                openModal('edit', { category, name });
                return;
            }
            if (e.target.closest('.delete-btn')) {
                showConfirmation(`確定要刪除「${name}」嗎？`, () => {
                    vegetables[category] = vegetables[category].filter(v => v.name !== name);
                    // 從所有日期的攝取紀錄中移除此品項
                    Object.keys(eatenState).forEach(date => {
                        if (eatenState[date]?.items) {
                            delete eatenState[date].items[name];
                        }
                    });
                    saveData();
                    updateView();
                });
                return;
            }

            // --- Click on item body ---
            const isTouchDevice = !window.matchMedia('(hover: hover)').matches;

            if (isTouchDevice) {
                // On touch devices, show actions for 2 seconds on click.
                // Hide any other open action menus
                document.querySelectorAll('.veg-item.show-actions').forEach(item => {
                    if (item !== vegItem) {
                        item.classList.remove('show-actions');
                        const timerId = item.dataset.actionTimer;
                        if (timerId) clearTimeout(timerId);
                    }
                });

                // Show actions for the clicked item and set a timer to hide them
                vegItem.classList.add('show-actions');
                const existingTimer = vegItem.dataset.actionTimer;
                if (existingTimer) clearTimeout(existingTimer);
                
                const newTimer = setTimeout(() => {
                    vegItem.classList.remove('show-actions');
                }, 2000);
                vegItem.dataset.actionTimer = newTimer;
            }

            // Toggle selection state for all devices
            // 僅在單日模式下啟用
            if (isMultiDay) return;
            
            // 確保當天的紀錄物件存在
            if (!eatenState[startDate]) eatenState[startDate] = { items: {}, photos: [] };

            const wasEaten = !!eatenState[startDate].items[name];
            eatenState[startDate].items[name] = !wasEaten;
            saveData();

            // Efficiently update UI without full re-render
            vegItem.classList.toggle('eaten', !wasEaten);
            const categoryHeader = vegItem.closest('.category-section').querySelector('.category-header');
            const countEl = categoryHeader.querySelector('.category-count');
            let currentCount = parseInt(countEl.textContent, 10);
            countEl.textContent = wasEaten ? currentCount - 1 : currentCount + 1;
            renderSummary();
        }
    });

    // 處理建議攝取區塊的點擊事件 (只處理資訊按鈕)
    document.getElementById('recommendation-grid').addEventListener('click', (e) => {
        const vegItem = e.target.closest('.veg-item');
        if (!vegItem) return;

        // 檢查是否點擊了資訊按鈕
        if (e.target.closest('.info-btn')) {
            openNutrientModal(vegItem.dataset.category, vegItem.dataset.name);
        }
    });

    // 移除建議攝取區塊的折疊功能

    document.getElementById('reset-button').onclick = () => {
        showConfirmation(`確定要重置 ${startDate} 的紀錄嗎？`, () => {
            eatenState[startDate] = { items: {}, photos: [] };
            saveData();
            updateView();
        });
    };
    
    selectModeBtn.addEventListener('click', () => {
        selectionModal.style.display = 'flex';
    });

    // 為所有帶有 data-modal 屬性的按鈕（通常是取消或完成按鈕）添加關閉 modal 的事件監聽器
    document.querySelectorAll('button[data-modal]').forEach(btn => {
        btn.addEventListener('click', () => {
            const modalId = btn.dataset.modal;
            if (modalId) {
                const modalToClose = document.getElementById(modalId);
                if (modalToClose) {
                    closeModal(modalToClose);
                }
            }
        });
    });

    document.getElementById('about-link').addEventListener('click', () => {
        aboutModal.style.display = 'flex';
    });

    // --- 管理按鈕與 Modal 邏輯 ---
    document.getElementById('management-btn').addEventListener('click', () => {
        managementModal.style.display = 'flex';
    });

    document.getElementById('manage-add-veg-btn').addEventListener('click', () => {
        closeModal(managementModal);
        openModal('add', {});
    });

    document.getElementById('manage-download-btn').addEventListener('click', () => {
        downloadDataAsJson();
        closeModal(managementModal); // 點擊後立即關閉
    });

    document.getElementById('import-file-input').addEventListener('change', handleFileUpload);

    editForm.addEventListener('submit', handleFormSubmit);

    // --- 圖片壓縮輔助函式 ---
    function compressImage(file, quality = 0.7, maxWidth = 800, returnType = 'blob') {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
    
                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    if (returnType === 'blob') {
                        canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
                    } else {
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    }
                };
                img.onerror = error => reject(error);
            };
            reader.onerror = error => reject(error);
        });
    }

    // --- 處理單張或多張圖片，並儲存 ---
    async function processAndSaveImages(imageBlobs) {
        try {
            if (!eatenState[startDate]) eatenState[startDate] = { items: {}, photos: [] };

            const allRecognizedItems = new Set();

            imageBlobs.forEach(blob => {
                const recognizedVeggies = simulateRecognition(); // 模擬辨識
                const recognizedVegNames = recognizedVeggies.map(v => v.name);
                recognizedVegNames.forEach(name => allRecognizedItems.add(name));

                eatenState[startDate].photos.push({ url: blob, recognizedItems: recognizedVegNames });
            });

            allRecognizedItems.forEach(name => eatenState[startDate].items[name] = true);
            saveData();
            updateView();
            alert(`新增完成！已從 ${imageBlobs.length} 張照片中自動加入：${Array.from(allRecognizedItems).join('、')}`);
        } catch (error) {
            console.error("處理照片時出錯:", error);
            alert("處理照片時發生錯誤。");
        }
    }

    // --- 照片上傳事件監聽 ---
    uploadPhotoInput.addEventListener('change', async (event) => {
        const files = event.target.files;
        if (!files || files.length === 0) return;

        // 關閉可能開啟的選擇視窗
        closeModal(cameraChoiceModal);

        if (files.length === 1) {
            // 如果只選一張，進入編輯模式
            openPhotoEditor(files[0]);
        } else {
            // 如果選取多張，直接壓縮處理
            if (files.length > 5) {
                alert('一次最多只能上傳 5 張照片。');
                event.target.value = ''; // 重置 input
                return;
            }
            const compressionPromises = Array.from(files).map(file => compressImage(file, 0.7, 800, 'blob'));
            const imageBlobs = await Promise.all(compressionPromises);
            await processAndSaveImages(imageBlobs);
        }

        // 重置 input，以便可以再次選擇同一個檔案
        event.target.value = '';
    });

    // --- 成果區項目取消選取功能 ---
    document.getElementById('summary-list').addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-btn');
        if (!removeBtn) return;

        const summaryItem = removeBtn.closest('.summary-item');
        if (!summaryItem) return;

        const name = summaryItem.dataset.name;
        if (!name) return;

        // 更新資料狀態
        if (eatenState[startDate]?.items?.[name]) {
            eatenState[startDate].items[name] = false;
            saveData();
            // 直接重新渲染畫面，確保所有相關區塊 (計數、圖表、蔬菜格) 都同步更新
            updateView();
        }
    });

    // --- 照片檢視與刪除功能 ---
    document.getElementById('photo-gallery-section').addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-photo-btn');
        const thumbnail = e.target.closest('.photo-thumbnail');

        if (removeBtn) {
            e.stopPropagation(); // 防止觸發開啟檢視器
            const photoIndex = parseInt(removeBtn.dataset.index, 10);
            if (isNaN(photoIndex)) return;

            const photoToDelete = eatenState[startDate]?.photos?.[photoIndex];
            if (!photoToDelete) return;

            const recognizedItems = photoToDelete.recognizedItems || [];

            if (recognizedItems.length > 0) {
                // 有關聯蔬菜，顯示進階選項
                showPhotoDeleteConfirmation(photoIndex, recognizedItems);
            } else {
                // 沒有關聯蔬菜 (舊資料)，顯示基本確認
                showConfirmation('確定要刪除這張照片嗎？', () => {
                    eatenState[startDate].photos.splice(photoIndex, 1);
                    saveData();
                    updateView();
                });
            }

        } else if (thumbnail) {
            // 點擊了照片縮圖 (開啟檢視器)
            const imageSrc = thumbnail.src; // src is an object URL
            document.getElementById('photo-viewer-modal-image').src = imageSrc;
            photoViewerModal.style.display = 'flex';
        }
    });

    function showPhotoDeleteConfirmation(photoIndex, recognizedItems) {
        const modal = photoDeleteConfirmModal;
        const actionsContainer = document.getElementById('photo-delete-confirm-actions');
        const messageEl = document.getElementById('photo-delete-confirm-message');
        actionsContainer.innerHTML = ''; // 清空舊按鈕

        messageEl.textContent = `這張照片辨識出了「${recognizedItems.join('、')}」。您想要如何處理？`;

        // 按鈕1: 只刪除照片
        const deletePhotoOnlyBtn = document.createElement('button');
        deletePhotoOnlyBtn.textContent = '只刪除照片';
        deletePhotoOnlyBtn.className = 'btn btn-select';
        deletePhotoOnlyBtn.onclick = () => {
            eatenState[startDate].photos.splice(photoIndex, 1);
            saveData();
            updateView();
            closeModal(modal);
        };
        actionsContainer.appendChild(deletePhotoOnlyBtn);

        // 按鈕2: 刪除照片和對應蔬菜
        const deleteBothBtn = document.createElement('button');
        deleteBothBtn.textContent = '刪除照片和對應蔬菜';
        deleteBothBtn.className = 'btn btn-reset'; // 紅色，表示更強的刪除操作
        deleteBothBtn.onclick = () => {
            // 刪除對應的蔬菜
            recognizedItems.forEach(vegName => {
                if (eatenState[startDate]?.items?.[vegName]) {
                    delete eatenState[startDate].items[vegName];
                }
            });
            // 刪除照片
            eatenState[startDate].photos.splice(photoIndex, 1);
            saveData();
            updateView();
            closeModal(modal);
        };
        actionsContainer.appendChild(deleteBothBtn);

        modal.style.display = 'flex';
    }

    // --- 相機功能 ---
    document.getElementById('camera-btn').addEventListener('click', () => {
        // 點擊相機按鈕時，開啟選擇視窗
        cameraChoiceModal.style.display = 'flex';
    });

    // 選擇視窗中的 "從相簿選取" 按鈕
    document.getElementById('choice-upload-btn').addEventListener('click', () => {
        // 這裡不需要做任何事，因為 label 的 for 屬性會自動觸發 input click
        // 只需要在 input 的 change 事件中關閉 modal
    });

    // 選擇視窗中的 "開啟相機" 按鈕
    document.getElementById('choice-camera-btn').addEventListener('click', () => {
        closeModal(cameraChoiceModal);
        openCamera();
    });

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        closeModal(cameraModal);
    }

    document.querySelector('#camera-modal .btn-cancel').addEventListener('click', stopCamera);

    async function openCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('您的瀏覽器不支援相機功能。');
            return;
        }
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } // 優先使用後置鏡頭
            });
            const videoEl = document.getElementById('camera-view');
            videoEl.srcObject = cameraStream;
            cameraModal.style.display = 'flex';
        } catch (err) {
            console.error("相機錯誤:", err);
            alert('無法開啟相機。請確認您已授權網站使用相機，或您的相機未被其他應用程式佔用。');
        }
    }

    // 儲存照片到裝置
    function downloadImage(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || `veg-photo-${new Date().getTime()}.jpg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    document.getElementById('capture-btn').addEventListener('click', async () => {
        const video = document.getElementById('camera-view');
        const canvas = document.getElementById('camera-canvas');
        const maxWidth = 800; // 與相簿上傳的壓縮設定一致
        const quality = 0.7;

        // 根據 video 尺寸和最大寬度，計算等比例縮放後的 canvas 尺寸
        let width = video.videoWidth;
        let height = video.videoHeight;

        if (width > maxWidth) {
            height = (maxWidth / width) * height;
            width = maxWidth;
        }

        canvas.width = width;
        canvas.height = height;
        
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, width, height); // 繪製縮放後的圖片
        
        // 將照片轉為 Blob 格式以節省空間
        const imageBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));

        stopCamera();
        // 儲存照片到裝置
        downloadImage(imageBlob);

        // 拍照後，直接將照片加入當日紀錄，並模擬辨識
        const recognizedVeggies = simulateRecognition();
        const recognizedVegNames = recognizedVeggies.map(v => v.name);
        
        if (!eatenState[startDate]) eatenState[startDate] = { items: {}, photos: [] };
        
        eatenState[startDate].photos.push({ url: imageBlob, recognizedItems: recognizedVegNames });
        recognizedVegNames.forEach(name => eatenState[startDate].items[name] = true);
        
        saveData();
        updateView();
        alert(`拍照完成！已自動新增：${recognizedVegNames.join('、')}`);
    });

    function simulateRecognition() {
        const allVeggies = categoryOrder.flatMap(cat => vegetables[cat] || []);
        if (allVeggies.length === 0) return;

        const recognizedVeggies = [];
        const numToRecognize = Math.min(allVeggies.length, Math.floor(Math.random() * 2) + 2); // 2 or 3

        while (recognizedVeggies.length < numToRecognize) {
            const randomIndex = Math.floor(Math.random() * allVeggies.length);
            const randomVeg = allVeggies[randomIndex];
            if (!recognizedVeggies.some(v => v.name === randomVeg.name)) {
                recognizedVeggies.push(randomVeg);
            }
        }
        return recognizedVeggies;
    }

    startDatePicker.addEventListener('change', handleDateChange);
    endDatePicker.addEventListener('change', handleDateChange);

    // --- 日期快速切換功能 ---
    function shiftDate(days) {
        let start = new Date(startDatePicker.value + 'T00:00:00');
        let end = new Date(endDatePicker.value + 'T00:00:00');

        // 計算日期範圍的長度 (天數)
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        // 移動起始日期
        start.setDate(start.getDate() + days);
        // 根據原始範圍長度，計算並移動結束日期
        end = new Date(start);
        end.setDate(end.getDate() + diffDays);

        // 更新日期選擇器的值並觸發更新
        startDatePicker.value = toLocalISOString(start);
        endDatePicker.value = toLocalISOString(end);
        handleDateChange();
    }

    prevDayBtn.addEventListener('click', () => shiftDate(-1));
    nextDayBtn.addEventListener('click', () => shiftDate(1));


    // --- Home Screen & Calendar Navigation ---
    document.getElementById('back-to-home-btn').addEventListener('click', () => {
        showHomeScreen();
    });

    document.getElementById('prev-month-btn').addEventListener('click', () => {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
    });

    document.getElementById('next-month-btn').addEventListener('click', () => {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
    });

    // Add a debounced resize listener to update chart layouts
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            renderSummary();
        }, 250); // Debounce to avoid excessive re-renders
    });

    // 全域點擊監聽，用於關閉已開啟的選單
    document.addEventListener('click', (e) => {
        // 修正：只有當點擊的目標及其任何父元素都不是 .veg-item 時，才關閉選單。
        if (e.target.closest('.modal-content')) {
            return; // 如果點擊在 modal 內容上，不關閉 veg-item 的 actions
        }

        // 這可以防止點擊 .veg-item 的子元素（如圖片或文字）時，錯誤地關閉選單。
        const clickedVegItem = e.target.closest('.veg-item');
        if (!clickedVegItem) {
            document.querySelectorAll('.veg-item.show-actions').forEach(item => {
                item.classList.remove('show-actions');
                const timerId = item.dataset.actionTimer;
                if (timerId) clearTimeout(timerId);
            });
        }
    });

    window.onclick = e => { 
        if (e.target.classList.contains('modal')) {
            if (e.target.id === 'photo-editor-modal' && cropper) {
                cropper.destroy();
                cropper = null;
            }
            closeModal(e.target);
        }
    };

    function showHomeScreen() {
        // 顯示首頁 (月曆、建議攝取等)
        document.getElementById('home-screen').style.display = 'flex';
        document.querySelector('.main-content').style.display = 'none';
        const today = toLocalISOString(new Date());
        renderRecommendations(today); // 在首頁顯示基於今日的建議
        renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
    }

    function showMainView(dateStr) {
        // 顯示次頁 (單日/多日紀錄)
        document.getElementById('home-screen').style.display = 'none';
        document.querySelector('.main-content').style.display = 'block';
        
        startDatePicker.value = dateStr;
        endDatePicker.value = dateStr;
        handleDateChange();
    }

    // Helper function to format a date as YYYY-MM-DD in the local timezone
    function toLocalISOString(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function generateHomeTreemap(startDateStr, endDateStr) {
        const canvas = document.getElementById('home-treemap-chart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const computedStyle = getComputedStyle(document.documentElement);
        const datesInRange = getDatesInRange(startDateStr, endDateStr);

        // 計算選定日期範圍內的品項數量
        const itemCounts = {};
        datesInRange.forEach(dateStr => {
            const dailyEatenItems = eatenState[dateStr]?.items || {};
            Object.keys(dailyEatenItems).forEach(vegName => {
                if (dailyEatenItems[vegName]) {
                    itemCounts[vegName] = (itemCounts[vegName] || 0) + 1;
                }
            });
        });

        const hasItemData = Object.keys(itemCounts).length > 0;
        const paginationContainer = document.getElementById('home-treemap-pagination');
        paginationContainer.innerHTML = '';
        
        // 將標題元素選擇器移至前方，以便在各種情況下都能更新
        const homeTreemapTitle = document.querySelector('#home-screen .summary-section h3');

        if (hasItemData) {
            const vegNameToCategoryMap = {};
            Object.keys(vegetables).forEach(category => {
                vegetables[category].forEach(veg => {
                    vegNameToCategoryMap[veg.name] = category;
                });
            });

            let treemapData = Object.entries(itemCounts).map(([name, count]) => ({
                name: name,
                count: count,
                category: vegNameToCategoryMap[name] || '其他'
            }));

            treemapData.sort((a, b) => {
                if (b.count !== a.count) {
                    return b.count - a.count;
                }
                const categoryIndexA = categoryOrder.indexOf(a.category);
                const categoryIndexB = categoryOrder.indexOf(b.category);
                return categoryIndexA - categoryIndexB;
            });

            const isMobile = window.innerWidth <= 992;
            const TREEMAP_PAGE_SIZE = isMobile ? 40 : 999; // 在手機上限制每頁40個，寬螢幕不限制
            let pages = [];
            let dataForChart;

            if (isMobile && treemapData.length > TREEMAP_PAGE_SIZE) {
                // 分頁邏輯
                for (let i = 0; i < treemapData.length; i += TREEMAP_PAGE_SIZE) {
                    pages.push(treemapData.slice(i, i + TREEMAP_PAGE_SIZE));
                }

                if (homeTreemapPage >= pages.length) {
                    homeTreemapPage = pages.length - 1;
                }
                dataForChart = pages[homeTreemapPage];

                // 渲染分頁圓點
                pages.forEach((_, index) => {
                    const dot = document.createElement('span');
                    dot.className = 'pagination-dot';
                    if (index === homeTreemapPage) {
                        dot.classList.add('active');
                    }
                    dot.dataset.page = index;
                    dot.addEventListener('click', () => {
                        homeTreemapPage = index;
                        generateHomeTreemap(startDateStr, endDateStr);
                    });
                    paginationContainer.appendChild(dot);
                });

                // 增加手勢滑動功能
                if (!canvas.dataset.swipeListenersAttached) {
                    let touchStartX = 0;
                    let touchEndX = 0;

                    canvas.addEventListener('touchstart', e => {
                        touchStartX = e.changedTouches[0].screenX;
                        touchEndX = touchStartX; // 重置
                    }, { passive: true });

                    canvas.addEventListener('touchmove', e => {
                        touchEndX = e.changedTouches[0].screenX;
                    }, { passive: true });

                    canvas.addEventListener('touchend', () => {
                        const swipeDistance = touchEndX - touchStartX;
                        if (swipeDistance > 50 && homeTreemapPage > 0) { // 向右滑
                            homeTreemapPage--;
                            generateHomeTreemap(startDateStr, endDateStr);
                        } else if (swipeDistance < -50 && homeTreemapPage < pages.length - 1) { // 向左滑
                            homeTreemapPage++;
                            generateHomeTreemap(startDateStr, endDateStr);
                        }
                    }, { passive: true });
                    canvas.dataset.swipeListenersAttached = 'true';
                }
            } else {
                dataForChart = treemapData;
            }

            const itemsByCategory = {};
            dataForChart.forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });

            const itemColorMap = {};
            Object.keys(itemsByCategory).forEach(category => {
                const items = itemsByCategory[category];
                items.sort((a, b) => b.count - a.count);
                
                const baseColorVar = categoryColorVars[category];
                const baseColor = baseColorVar ? computedStyle.getPropertyValue(baseColorVar).trim() : '#cccccc';
                
                const shades = generateColorShades(baseColor, items.length);
                items.forEach((item, index) => itemColorMap[item.name] = shades[index]);
            });

            if (window.homeTreemap) window.homeTreemap.destroy();
            window.homeTreemap = new Chart(ctx, {
                type: 'treemap',
                data: {
                    datasets: [{
                        tree: dataForChart,
                        key: 'count',
                        borderWidth: 0,
                        spacing: 0,
                        labels: {
                            display: true,
                            color: 'white',
                            font: { size: 12, weight: '500', lineHeight: 1.4 },
                            formatter: (ctx) => {
                                const dataItem = ctx.raw._data;
                                return [dataItem.name, dataItem.count];
                            }
                        },
                        backgroundColor: (ctx) => {
                            if (ctx.type !== 'data') return 'transparent';
                            const itemName = ctx.raw._data.name;
                            return itemColorMap[itemName] || '#cccccc';
                        }
                    }]
                },
                options: {
                    animation: false,
                    layout: { padding: 1 },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ` ${ctx.raw._data.name}: ${ctx.raw._data.count}`
                            }
                        }
                    }
                }
            });

            // 更新首頁的攝取品項標題，顯示品項總數和總次數
            const uniqueItemsCount = Object.keys(itemCounts).length;
            const totalCount = Object.values(itemCounts).reduce((sum, count) => sum + count, 0);
            homeTreemapTitle.innerHTML = `攝取品項 <span class="unique-count">${uniqueItemsCount}種/${totalCount}次</span>`;
        } else {
            const placeholderColor = computedStyle.getPropertyValue('--placeholder-bg').trim() || '#eaeaea';
            
            homeTreemapTitle.innerHTML = `攝取品項 <span class="unique-count">0種/0次</span>`;
            if (window.homeTreemap) window.homeTreemap.destroy();
            window.homeTreemap = new Chart(ctx, {
                type: 'treemap',
                data: {
                    datasets: [{
                        tree: [{ value: 1 }],
                        key: 'value',
                        backgroundColor: placeholderColor,
                        labels: {
                            display: true,
                            align: 'center',
                            position: 'center',
                            color: 'grey',
                            font: { size: 16, weight: '500' },
                            formatter: () => '無攝取品項資料'
                        }
                    }]
                },
                options: {
                    layout: { padding: 1 },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: false
                }
            });
        }
    }

    function renderCalendar(year, month) {
        // 計算月份的開始和結束日期
        const startOfMonth = toLocalISOString(new Date(year, month, 1));
        const endOfMonth = toLocalISOString(new Date(year, month + 1, 0));
        
        // 生成月曆視圖下方的 treemap 圖表
        generateHomeTreemap(startOfMonth, endOfMonth);

        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('month-year-display');
        const weekdaysGrid = document.getElementById('calendar-weekdays');
        calendarGrid.innerHTML = '';
        weekdaysGrid.innerHTML = '';

        monthYearDisplay.textContent = `${year}年 ${month + 1}月`;
        monthYearDisplay.style.fontSize = '1.5rem';
        monthYearDisplay.style.fontWeight = '700';
        document.querySelectorAll('#home-screen .summary-section h3, #home-screen #recommendation-section h3').forEach(title => {
            title.style.fontSize = '1.5rem';
            title.style.fontWeight = '700';
        });

        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        weekdays.forEach(day => {
            const dayEl = document.createElement('div');
            dayEl.textContent = day;
            weekdaysGrid.appendChild(dayEl);
        });

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        const todayString = toLocalISOString(today);

        // Add empty cells for days before the 1st
        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'day-cell empty-cell';
            calendarGrid.appendChild(emptyCell);
        }

        // Add day cells
        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell';

            const dayNumberEl = document.createElement('span');
            dayNumberEl.className = 'day-number';
            dayNumberEl.textContent = day;
            dayCell.appendChild(dayNumberEl);
            
            const date = new Date(year, month, day);
            const dateString = toLocalISOString(date);
            dayCell.dataset.date = dateString;

            if (dateString === todayString) dayCell.classList.add('today');

            const dailyRecord = eatenState[dateString];
            const items = dailyRecord?.items || {};
            const photos = dailyRecord?.photos || [];

            const count = Object.values(items).filter(isEaten => isEaten === true).length;
            if (count > 0) {
                dayCell.classList.add('has-data');
                dayCell.innerHTML += `<span class="day-count">${count}</span>`;
            }

            // 如果當天有照片，則新增照片圖示 (修正)
            if (photos.length > 0) {
                const photoIndicator = document.createElement('div');
                photoIndicator.className = 'day-photo-indicator';
                photoIndicator.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 0 1 3.25 3h13.5A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17H3.25A2.25 2.25 0 0 1 1 14.75v-9.5Zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-2.69l-2.22-2.219a.75.75 0 0 0-1.06 0l-1.91 1.909a.75.75 0 0 1-1.06 0l-2.09-2.09a.75.75 0 0 0-1.06 0l-3.94 3.94ZM10 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" clip-rule="evenodd" /></svg>`;
                dayCell.appendChild(photoIndicator);
            }

            dayCell.addEventListener('click', () => {
                showMainView(dateString);
            });

            calendarGrid.appendChild(dayCell);
        }
    }

    async function initializeApp() {
        // --- Data Migration from localStorage to IndexedDB ---
        const lsVeggies = localStorage.getItem('vegetablesData');
        const idbVeggies = await idb.get('vegetablesData');

        // 如果 localStorage 有資料但 IndexedDB 是空的，則執行轉移。
        if (lsVeggies && !idbVeggies) {
            console.log("Migrating data from localStorage to IndexedDB...");
            try {
                const dataKeys = ['vegetablesData', 'eatenVeggiesDaily', 'categoryCollapseState', 'recommendationCollapseState', 'dataVersion'];
                for (const key of dataKeys) {
                    const lsData = localStorage.getItem(key);
                    if (lsData) {
                        await idb.set(key, JSON.parse(lsData));
                    }
                }
                // Clear localStorage after successful migration
                dataKeys.forEach(key => localStorage.removeItem(key));
                alert('資料儲存方式已升級，您的紀錄已成功轉移。');
            } catch (error) {
                console.error("Data migration failed:", error);
                alert('資料轉移失敗，請手動備份後聯繫開發者。');
            }
        }

        await loadData();
        showHomeScreen();
    }

    // Initial Load
    initializeApp();
});
</script>
</body>
</html>
